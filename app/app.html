<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Configuration -->
    <link rel="manifest" href="./manifest.webmanifest">
    <meta name="theme-color" content="#6c5ce7">
    <link rel="apple-touch-icon" href="./assets/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- SEO Meta Tags -->
    <meta name="description"
        content="Bulletin AI - Assistant intelligent pour la rédaction d'appréciations scolaires. Générez des appréciations personnalisées pour vos élèves grâce à l'IA.">
    <meta name="keywords"
        content="bulletin scolaire, appréciations, enseignant, IA, intelligence artificielle, école, éducation">
    <meta name="author" content="David Trafial">
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Bulletin AI | Assistant de rédaction d'appréciations scolaires">
    <meta property="og:description"
        content="Générez des appréciations personnalisées pour vos élèves grâce à l'intelligence artificielle. Gratuit et conforme RGPD.">
    <meta property="og:image" content="./assets/icon-512.png">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Bulletin AI | Assistant de rédaction d'appréciations scolaires">
    <meta name="twitter:description"
        content="Générez des appréciations personnalisées pour vos élèves grâce à l'intelligence artificielle.">
    <meta name="twitter:image" content="./assets/icon-512.png">
    <!-- CSP removed for GitHub Pages compatibility -->
    <title>Bulletin AI | Votre assistant de rédaction</title>
    <link rel="icon" type="image/svg+xml" href="assets/icon.svg" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/svg+xml" href="assets/icon-dark-mode.svg" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;700&display=swap">
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="src/css/main.css">
    <script>
        // Immediate Theme Application (Prevents White Flash)
        try {
            const savedState = localStorage.getItem('bulletin_app_state');
            if (savedState) {
                const state = JSON.parse(savedState);
                // Check flattened settings (legacy/flat structure)
                let theme = 'light';
                if (state.settings && state.settings.theme) {
                    theme = state.settings.theme;
                } else if (state.theme) {
                    theme = state.theme;
                }

                if (theme === 'dark') {
                    document.documentElement.dataset.theme = 'dark';
                }
            }
        } catch (e) {
            console.error('Theme init error:', e);
        }
    </script>
</head>

<body>
    <!-- Skip Link pour accessibilité WCAG -->
    <a href="#main-content" class="skip-link">Aller au contenu principal</a>

    <!-- NOUVELLE STRUCTURE DE MISE EN PAGE PRINCIPALE -->
    <!-- Liste + Focus: Sidebar collapsed by default -->
    <div class="app-layout sidebar-collapsed app-loading">

        <!-- Sidebar removed - Import functionality now handled by Hub Modal -->
        <!-- ==================================================================== -->
        <!-- 2. CONTENU PRINCIPAL                                                 -->
        <!-- ==================================================================== -->
        <div class="main-content-wrapper">
            <header class="header">
                <!-- App Logo removed for cleaner UI -->
                <div class="header-logo" style="display: none;"></div>

                <!-- Class Selector - À gauche pour hiérarchie: Classe > Trimestre > Modèle -->
                <div class="class-selector-wrapper">
                    <div id="headerClassChip" class="header-context-chip class-chip tooltip" role="button" tabindex="0"
                        data-tooltip="Changer de classe">
                        <span class="icon"><iconify-icon icon="solar:users-group-rounded-linear"></iconify-icon></span>
                        <span id="headerClassName">Ma Classe</span>
                        <span id="headerStudentCount" class="student-count-badge">0</span>
                        <iconify-icon icon="solar:alt-arrow-down-linear" class="class-chevron"></iconify-icon>
                    </div>
                    <div id="classDropdown" class="class-dropdown" style="display: none;">
                        <div class="class-dropdown-header">
                            <button id="manageClassesBtn" class="class-dropdown-title-btn" title="Gérer les classes">
                                <iconify-icon icon="solar:settings-linear"></iconify-icon>
                                <span>Mes Classes</span>
                            </button>
                            <button id="addNewClassBtn" class="btn-icon-small tooltip" data-tooltip="Nouvelle classe">
                                <iconify-icon icon="ph:plus"></iconify-icon>
                            </button>
                        </div>
                        <div id="classDropdownList" class="class-dropdown-list">
                            <!-- Classes will be rendered here dynamically -->
                        </div>
                    </div>
                </div>

                <div class="header-center">
                    <div class="ui-segmented-control header-style" id="mainPeriodSelector"></div>
                </div>

                <div class="header-actions">
                    <!-- Generation Dashboard: Unified clickable pill showing class status -->
                    <div id="headerGenDashboard" class="header-gen-dashboard tooltip" role="button" tabindex="0"
                        aria-label="Statut de génération" data-tooltip="Changer de modèle IA">
                        <!-- Model indicator (decorative, not interactive itself) -->
                        <div class="dash-model-label" id="dashModelLabel">
                            <iconify-icon icon="solar:cpu-linear"></iconify-icon>
                            <span id="dashModelName">Gemini</span>
                        </div>
                        <!-- Validated count -->
                        <button class="dash-badge dash-validated" id="dashValidated"
                            data-tooltip="Appréciations validées">
                            <iconify-icon icon="ph:check"></iconify-icon>
                            <span class="dash-count" id="dashValidatedCount">0</span>
                        </button>
                        <!-- Error count (hidden if 0) -->
                        <button class="dash-badge dash-errors" id="dashErrors" data-tooltip="Erreurs de génération">
                            <iconify-icon icon="solar:danger-triangle-linear"></iconify-icon>
                            <span class="dash-count" id="dashErrorCount">0</span>
                        </button>
                        <!-- Pending count -->
                        <button class="dash-badge dash-pending" id="dashPending"
                            data-tooltip="En attente de génération">
                            <iconify-icon icon="solar:hourglass-line-linear"></iconify-icon>
                            <span class="dash-count" id="dashPendingCount">0</span>
                        </button>
                        <!-- Generating state overlay -->
                        <div class="dash-generating" id="dashGenerating">
                            <div class="dash-progress-bar">
                                <div class="dash-progress-fill" id="dashProgressFill"></div>
                            </div>
                            <span class="dash-progress-text" id="dashProgressText">0/0</span>
                            <button class="dash-cancel-btn" id="dashCancelBtn" data-tooltip="Annuler">
                                <iconify-icon icon="ph:x"></iconify-icon>
                            </button>
                        </div>
                    </div>

                    <div class="header-actions-pill">

                        <div class="dropdown-wrapper">
                            <button id="headerMenuBtn" class="pill-segment menu-btn tooltip" data-tooltip="Menu">
                                <iconify-icon icon="solar:menu-dots-bold"></iconify-icon>
                            </button>

                            <div id="headerMenuDropdown" class="header-dropdown-menu">
                                <div class="theme-control-wrapper">
                                    <div class="ui-segmented-control css-driven" id="themeSegmentedControl"
                                        data-active="light">
                                        <button class="ui-segment" data-value="light" aria-label="Mode clair"
                                            title="Mode clair">
                                            <iconify-icon icon="solar:sun-linear"></iconify-icon>
                                        </button>
                                        <button class="ui-segment" data-value="system" aria-label="Mode système"
                                            title="Mode système">
                                            <iconify-icon icon="solar:monitor-linear"></iconify-icon>
                                        </button>
                                        <button class="ui-segment" data-value="dark" aria-label="Mode sombre"
                                            title="Mode sombre">
                                            <iconify-icon icon="solar:moon-linear"></iconify-icon>
                                        </button>
                                        <div class="ui-glider"></div>
                                    </div>
                                </div>
                                <button id="updateMenuItem" class="menu-item update-item" style="display: none;">
                                    <iconify-icon icon="solar:gift-linear"
                                        style="color: var(--primary-color);"></iconify-icon>
                                    <span style="color: var(--primary-color); font-weight: 600;">Mise à jour
                                        disponible</span>
                                </button>
                                <div class="menu-separator"></div>
                                <button id="personalizationBtn" class="menu-item">
                                    <iconify-icon icon="solar:magic-stick-3-linear"></iconify-icon> Personnalisation
                                </button>
                                <button id="settingsButton" class="menu-item">
                                    <iconify-icon icon="solar:settings-linear"></iconify-icon> Paramètres
                                </button>
                                <button id="helpButton" class="menu-item">
                                    <iconify-icon icon="solar:question-circle-linear"></iconify-icon> Aide
                                </button>
                                <div id="cloudSeparator" class="menu-separator"></div>
                                <button id="cloudReconnectBtn" class="menu-item cloud-reconnect-item"
                                    style="display: none;">
                                    <iconify-icon icon="solar:plug-circle-linear"></iconify-icon>
                                    <span>Reconnecter Google Drive</span>
                                </button>
                                <button id="cloudSaveMenuBtn" class="menu-item cloud-save-menu-item"
                                    style="display: none;">
                                    <iconify-icon icon="solar:cloud-upload-linear"></iconify-icon>
                                    <span class="cloud-save-label">Enregistrer (Cloud)</span>
                                    <span class="cloud-save-time" id="cloudSaveTimeHint"></span>
                                </button>
                                <button id="cloudLoadMenuBtn" class="menu-item cloud-save-menu-item"
                                    style="display: none;">
                                    <iconify-icon icon="solar:cloud-download-linear"></iconify-icon>
                                    <span class="cloud-save-label">Récupérer (Cloud)</span>
                                    <span class="cloud-save-time" id="cloudLoadTimeHint"></span>
                                </button>
                                <div id="pwaInstallSeparator" class="menu-separator" style="display: none;"></div>
                                <button id="installPwaBtn" class="menu-item" style="display: none;">
                                    <iconify-icon icon="solar:download-minimalistic-linear"></iconify-icon> Installer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- PWA Update Banner -->
            <div id="pwaUpdateBanner" class="pwa-update-banner" style="display: none;">
                <div class="pwa-banner-main">
                    <div class="pwa-banner-text" role="button" tabindex="0">
                        <iconify-icon icon="solar:gift-linear" class="pwa-gift-icon"></iconify-icon>
                        <div class="pwa-text-col">
                            <span class="pwa-title">Mise à jour disponible</span>
                            <span class="pwa-subtitle" id="pwaUpdateMeta">Version plus récente détectée</span>
                        </div>
                        <span id="pwaInfoBtn" class="pwa-info-btn">
                            <iconify-icon icon="solar:alt-arrow-down-linear"></iconify-icon>
                        </span>
                    </div>
                    <div class="pwa-banner-actions">
                        <button id="pwaUpdateBtn" class="btn btn-sm btn-primary">Installer</button>
                        <button id="pwaUpdateDismissBtn" class="pwa-close-btn" aria-label="Fermer">
                            <iconify-icon icon="ph:x"></iconify-icon>
                        </button>
                    </div>
                </div>
                <div id="pwaUpdateDetails" class="pwa-banner-details">
                    <div class="pwa-details-content">
                        <div class="pwa-detail-row">
                            <span class="pwa-detail-label">Message :</span>
                            <span class="pwa-detail-value" id="pwaCommitMsg">Améliorations générales et corrections de
                                bugs.</span>
                        </div>
                        <div class="pwa-detail-row">
                            <span class="pwa-detail-label">Version :</span>
                            <span class="pwa-detail-code" id="pwaCommitHash">v0.1.X</span>
                        </div>
                    </div>
                </div>
            </div>

            <main class="main-content" id="main-content">
                <div class="output-section">
                    <div class="stats-container" id="statsContainer">
                        <!-- 1. PERFORMANCE (avec Médiane intégrée) -->
                        <div class="stat-card performance-card" id="performanceCard">
                            <div class="stat-card-header">
                                <h4 class="stat-title">Moyenne de classe</h4>
                                <div class="evolution-chip" id="classEvolutionChip">
                                    <span id="classEvolutionAverageStat">--</span>
                                </div>
                            </div>
                            <div class="performance-overview">
                                <span class="main-average-value" id="currentAvgGradeOutput">--</span>
                                <span class="average-denominator">/20</span>
                            </div>
                            <div class="performance-details">
                                <div class="detail-item tooltip" data-filter-id="minGrade" role="button" tabindex="0"
                                    data-tooltip="Note la plus basse">
                                    <span class="detail-value" id="minAvgGradeOutput">--</span>
                                    <span class="detail-label">Min</span>
                                </div>
                                <div class="detail-item tooltip"
                                    data-tooltip="Valeur centrale : 50% des élèves sont au-dessus">
                                    <span class="detail-value" id="medianGradeOutput">--</span>
                                    <span class="detail-label">Médiane</span>
                                </div>
                                <div class="detail-item tooltip" data-filter-id="maxGrade" role="button" tabindex="0"
                                    data-tooltip="Note la plus haute">
                                    <span class="detail-value" id="maxAvgGradeOutput">--</span>
                                    <span class="detail-label">Max</span>
                                </div>
                            </div>
                        </div>

                        <!-- 2. DISPERSION (Histogramme + Homogénéité fusionnés) -->
                        <div class="stat-card dispersion-card" id="dispersionCard">
                            <div class="stat-card-header">
                                <h4 class="stat-title">Répartition</h4>
                                <span class="homogeneity-badge" id="heterogeneityLabel">--</span>
                            </div>
                            <div class="histogram-container">
                                <div class="histogram-bars">
                                    <div class="hist-bar-group" data-range="0-4" data-filter-id="gradeRange_0-4"
                                        role="button" tabindex="0">
                                        <div class="hist-bar" style="height: 0%"></div>
                                        <span class="hist-label">0-4</span>
                                    </div>
                                    <div class="hist-bar-group" data-range="4-8" data-filter-id="gradeRange_4-8"
                                        role="button" tabindex="0">
                                        <div class="hist-bar" style="height: 0%"></div>
                                        <span class="hist-label">4-8</span>
                                    </div>
                                    <div class="hist-bar-group" data-range="8-12" data-filter-id="gradeRange_8-12"
                                        role="button" tabindex="0">
                                        <div class="hist-bar" style="height: 0%"></div>
                                        <span class="hist-label">8-12</span>
                                    </div>
                                    <div class="hist-bar-group" data-range="12-16" data-filter-id="gradeRange_12-16"
                                        role="button" tabindex="0">
                                        <div class="hist-bar" style="height: 0%"></div>
                                        <span class="hist-label">12-16</span>
                                    </div>
                                    <div class="hist-bar-group" data-range="16-20" data-filter-id="gradeRange_16-20"
                                        role="button" tabindex="0">
                                        <div class="hist-bar" style="height: 0%"></div>
                                        <span class="hist-label">16-20</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. DYNAMIQUE (Évolution des élèves) -->
                        <div class="stat-card evolution-card" id="evolutionCard">
                            <div class="stat-card-header">
                                <h4 class="stat-title" id="chartTitle">Dynamique</h4>
                            </div>
                            <div class="evolution-distribution-bar">
                                <div id="progressChartBar" class="bar-segment progress" data-percent="0%"></div>
                                <div id="stableChartBar" class="bar-segment stable" data-percent="0%"></div>
                                <div id="regressionChartBar" class="bar-segment regression" data-percent="0%"></div>
                            </div>
                            <div class="evolution-legend">
                                <div class="legend-item" data-filter-id="progressCount" role="button" tabindex="0">
                                    <span class="legend-dot progress"></span>
                                    <div class="legend-text">
                                        <span class="legend-label">Progrès</span>
                                        <span class="legend-count" id="classEvolutionProgressStat">0</span>
                                    </div>
                                </div>
                                <div class="legend-item" data-filter-id="stableCount" role="button" tabindex="0">
                                    <span class="legend-dot stable"></span>
                                    <div class="legend-text">
                                        <span class="legend-label">Stables</span>
                                        <span class="legend-count" id="classEvolutionStableStat">0</span>
                                    </div>
                                </div>
                                <div class="legend-item" data-filter-id="regressionCount" role="button" tabindex="0">
                                    <span class="legend-dot regression"></span>
                                    <div class="legend-text">
                                        <span class="legend-label">Régression</span>
                                        <span class="legend-count" id="classEvolutionRegressionStat">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Pagination Indicators (Mobile) -->
                    <div class="stats-pagination" id="statsPagination" aria-hidden="true">
                        <div class="stats-dot active"></div>
                        <div class="stats-dot"></div>
                        <div class="stats-dot"></div>
                    </div>

                    <!-- Progress and error UI moved to header chip (#headerGenerationStatus) -->

                    <div class="output-header" id="outputHeader">
                        <div class="output-toolbar">
                            <!-- Recherche à gauche -->
                            <div class="search-container">
                                <iconify-icon icon="solar:magnifer-linear" class="search-icon"></iconify-icon>
                                <input type="text" class="search-input" id="searchInput" placeholder="Rechercher...">
                                <button type="button" class="search-clear-btn" id="searchClearBtn"
                                    aria-label="Effacer la recherche">
                                    <iconify-icon icon="ph:x"></iconify-icon>
                                </button>
                            </div>
                            <!-- Active filter badge - inline in toolbar -->
                            <div id="activeFilterInfo" class="toolbar-filter-badge"></div>
                            <!-- Actions à droite - ordre stable -->
                            <div class="toolbar-actions">
                                <button type="button" class="btn btn-ai tooltip" id="analyzeClassBtn" disabled
                                    data-tooltip="Analyse IA de la classe">
                                    <iconify-icon icon="solar:chart-2-linear"></iconify-icon> Analyser
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="outputList" role="region" aria-live="polite"></div>
                    <div id="skeletonContainer" class="skeleton-grid" style="display: none;">
                        <!-- Skeletons générés dynamiquement -->
                    </div>
                    <div id="empty-state-card" style="display: none;"></div>
                    <p id="noResultsMessage" class="no-results-message">Aucun résultat ne correspond à votre recherche.
                    </p>
                </div>

                <!-- Floating Action Button for Adding Student -->
                <button id="addStudentFab" class="fab-add-student" data-tooltip="Ajouter un nouvel élève"
                    aria-label="Ajouter un élève">
                    <iconify-icon icon="ph:plus"></iconify-icon>
                </button>
            </main>
        </div>
    </div>

    <!-- ==================================================================== -->
    <!-- FOCUS PANEL - Vue détaillée d'un élève (Liste + Focus UX)           -->
    <!-- ==================================================================== -->
    <div id="focusPanelBackdrop" class="focus-panel-backdrop"></div>
    <div id="focusPanel" class="focus-panel" role="dialog" aria-modal="true" aria-labelledby="focusStudentName">
        <div class="focus-header">
            <!-- LEFT ZONE: Avatar (always visible) -->
            <div class="focus-header-left">
                <!-- AVATAR: Always visible, editable in edit mode -->
                <div id="focusAvatarContainer" class="focus-panel-avatar-container">
                    <!-- Populated by FocusPanelManager -->
                </div>
            </div>

            <!-- IDENTITY ZONE: Name/Badges (read) or Inputs (edit) - CENTERED -->
            <div id="focusHeaderContent" class="focus-header-content">
                <!-- READ MODE: Name & Badges -->
                <div class="focus-header-read">
                    <h2 id="focusStudentName" class="focus-student-name" role="button" tabindex="0"
                        data-tooltip="Cliquez pour éditer l'identité et les statuts">
                        Sophie DURAND
                        <iconify-icon icon="solar:pen-linear" class="focus-name-edit-icon"></iconify-icon>
                    </h2>
                    <div id="focusStatusBadges" class="focus-status-badges">
                        <!-- Badges générés dynamiquement -->
                    </div>
                </div>

                <!-- EDIT MODE: Inputs & Checkboxes (Hidden by default via CSS) -->
                <div class="focus-header-edit">
                    <div class="focus-edit-row">
                        <input type="text" id="headerPrenomInput" class="focus-input-header" placeholder="Prénom"
                            autocomplete="off">
                        <input type="text" id="headerNomInput" class="focus-input-header" placeholder="NOM"
                            autocomplete="off">
                    </div>
                    <div class="focus-status-selection">
                        <label class="status-pill-check"><input type="checkbox" value="Nouveau"> Nouveau</label>
                        <label class="status-pill-check"><input type="checkbox" value="Départ"> Départ</label>
                        <label class="status-pill-check"><input type="checkbox" value="PPRE"> PPRE</label>
                        <label class="status-pill-check"><input type="checkbox" value="PAP"> PAP</label>
                        <label class="status-pill-check"><input type="checkbox" value="ULIS"> ULIS</label>
                        <label class="status-pill-check"><input type="checkbox" value="Délégué"> Délégué</label>
                    </div>
                </div>
            </div>

            <!-- RIGHT ZONE: Unified Navigation Pill (Close + Prev/Next) -->
            <div class="focus-nav-buttons">
                <button id="focusPrevBtn" class="focus-nav-btn" aria-label="Élève précédent">
                    <iconify-icon icon="solar:alt-arrow-left-linear"></iconify-icon>
                </button>
                <span id="focusPosition" class="focus-position">3/25</span>
                <button id="focusNextBtn" class="focus-nav-btn" aria-label="Élève suivant">
                    <iconify-icon icon="solar:alt-arrow-right-linear"></iconify-icon>
                </button>
                <div class="focus-nav-divider"></div>
                <!-- Edit mode: Save button (hidden in read mode, visible in edit mode) -->
                <button id="focusEditSaveBtn" class="focus-nav-btn focus-save-btn" aria-label="Valider">
                    <iconify-icon icon="ph:check"></iconify-icon>
                </button>
                <button id="focusBackBtn" class="focus-nav-btn focus-close-btn" aria-label="Fermer le panneau">
                    <iconify-icon icon="ph:x"></iconify-icon>
                </button>
            </div>
        </div>

        <div class="focus-pages-container" id="focusPagesContainer">
            <!-- PAGE 1: Main Content (édition) -->
            <div class="focus-page focus-main-page" id="focusMainPage">
                <div class="focus-content">
                    <!-- Section historique supprimée - le contexte précédent est visible en chips inline -->

                    <!-- 2. HISTORY GRADES & CONTEXT -->
                    <div class="focus-context-group">
                        <div class="focus-context-header">
                            <div class="focus-context-label">
                                <span class="tooltip focus-context-info-trigger"
                                    data-tooltip="Un contexte relatif au travail, comportement et implication dans les projets de l'élève, permet d'obtenir des appréciations plus précises.">
                                    <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
                                    Contexte
                                </span>
                                <!-- Voice Dictation Button -->
                                <button type="button" id="focusMicBtn" class="focus-mic-btn tooltip"
                                    data-tooltip="Dictée vocale" aria-label="Dicter le contexte">
                                    <iconify-icon icon="solar:microphone-linear"></iconify-icon>
                                </button>
                            </div>

                            <!-- NEW: Previous Grades next to Current Grade -->
                            <div class="grades-wrapper">
                                <div id="focusPreviousGrades" class="previous-grades-inline">
                                    <!-- Populated by JS: T1: 12, T2: 14 -->
                                </div>
                                <div class="context-grade-group">
                                    <label for="focusCurrentGradeInput" id="focusCurrentGradeLabel">T1</label>
                                    <input type="text" id="focusCurrentGradeInput" class="context-grade-input"
                                        placeholder="--" maxlength="4">
                                </div>
                            </div>
                        </div>
                        <textarea id="focusContextInput" class="focus-context-textarea"
                            placeholder="Bavardages, travail sérieux, compréhension fragile, bonne participation, etc."></textarea>
                    </div>

                    <!-- 3. JOURNAL DE BORD - Observation notes -->
                    <div class="journal-section" id="focusJournalSection">
                        <div class="journal-header" id="focusJournalHeader">
                            <div class="journal-header-left">
                                <div class="journal-title-group">
                                    <iconify-icon icon="solar:notebook-linear"></iconify-icon>
                                    <span>Journal de bord</span>
                                </div>
                                <div class="journal-controls-group">
                                    <!-- Manual note button (Pen icon) -->
                                    <button class="journal-header-btn icon-only tooltip" id="focusJournalNoteBtn"
                                        data-tooltip="Ajouter une note">
                                        <iconify-icon icon="solar:pen-linear"></iconify-icon>
                                    </button>

                                    <!-- Tag dropdowns (Always visible) -->
                                    <div class="journal-inline-tags" id="journalInlineTags" style="display: flex;">
                                        <!-- Rendered by JS: Positif/Négatif dropdowns -->
                                    </div>

                                    <!-- Threshold quick control -->
                                    <div class="journal-threshold-control" id="journalThresholdControl">
                                        <button class="journal-threshold-btn journal-header-btn tooltip"
                                            id="journalThresholdBtn" data-tooltip="Cliquez pour régler le seuil">
                                            <iconify-icon icon="solar:filter-linear"></iconify-icon>
                                            <span id="journalThresholdValue">≥2</span>
                                        </button>
                                        <div class="journal-threshold-popover" id="journalThresholdPopover">
                                            <div class="threshold-popover-header">Seuil de signalement</div>
                                            <div class="threshold-popover-desc">Observations répétées transmises à l'IA
                                            </div>
                                            <div class="threshold-popover-controls">
                                                <button class="threshold-adjust-btn" data-delta="-1">−</button>
                                                <span class="threshold-current" id="thresholdCurrentValue">2</span>
                                                <button class="threshold-adjust-btn" data-delta="+1">+</button>
                                            </div>
                                            <div class="threshold-popover-hint">
                                                <span id="thresholdHintText">1 = tout compte • 3 = plus tolérant</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="journal-header-right">
                                <span class="journal-count-badge" id="focusJournalCount">0</span>
                            </div>
                        </div>
                        <div class="journal-content" id="focusJournalContent">
                            <!-- Draft preview (when editing) + Timeline rendered by JS -->
                        </div>
                    </div>

                    <!-- Appréciation - Now editable with refinement options -->
                    <div class="focus-appreciation">
                        <div class="focus-appreciation-header">
                            <div class="focus-appreciation-label">
                                <iconify-icon icon="solar:chat-line-linear"></iconify-icon>
                                Appréciation
                                <!-- Voice Dictation Button for Appreciation -->
                                <button type="button" id="focusAppreciationMicBtn" class="focus-mic-btn tooltip"
                                    data-tooltip="Dictée vocale" aria-label="Dicter l'appréciation">
                                    <iconify-icon icon="solar:microphone-linear"></iconify-icon>
                                </button>
                                <!-- History Navigation Group (Segmented) -->
                                <div class="history-navigation-group" id="historyNavigationGroup"
                                    style="display: none;">
                                    <button id="focusHistoryPrevBtn" class="history-nav-btn tooltip"
                                        data-tooltip="Version précédente (Ctrl+Z)" disabled>
                                        <iconify-icon icon="solar:alt-arrow-left-linear"></iconify-icon>
                                    </button>

                                    <!-- Central Indicator (Existing) -->
                                    <button id="focusHistoryIndicator" class="history-indicator-btn tooltip"
                                        data-tooltip="Historique des modifications">
                                        <span class="history-count">0</span>
                                    </button>

                                    <button id="focusHistoryNextBtn" class="history-nav-btn tooltip"
                                        data-tooltip="Version suivante (Ctrl+Y/Shift+Z)" disabled>
                                        <iconify-icon icon="solar:alt-arrow-right-linear"></iconify-icon>
                                    </button>
                                </div>
                            </div>
                            <div class="focus-appreciation-meta">
                                <span id="focusWordCount" class="word-count">0 mots</span>
                                <!-- AI Indicator: Shows if AI-generated, with model/token details -->
                                <span id="focusAiIndicator" class="ai-indicator tooltip" style="display: none;">
                                    ✨
                                </span>
                                <!-- Status Badge: Shows freshness state (generated, modified, pending) -->
                                <span id="focusAppreciationBadge" class="appreciation-status-badge tooltip"></span>
                            </div>
                        </div>
                        <div id="focusAppreciationText" class="focus-appreciation-text" contenteditable="true"
                            data-placeholder="Aucune appréciation générée. Cliquez sur 'Générer' ci-dessous.">
                        </div>

                        <!-- Refinement style buttons -->
                        <div class="focus-refinement-options" id="focusRefinementOptions">
                            <button class="btn btn-ai-outline btn-tiny tooltip" data-refine-type="concise"
                                data-tooltip="Réduit d'environ 20%">
                                <iconify-icon icon="solar:minimize-square-linear"></iconify-icon> Concise
                            </button>
                            <button class="btn btn-ai-outline btn-tiny tooltip" data-refine-type="detailed"
                                data-tooltip="Développe d'environ 20%">
                                <iconify-icon icon="solar:maximize-square-linear"></iconify-icon> Détaillée
                            </button>
                            <button class="btn btn-ai-outline btn-tiny tooltip" data-refine-type="encouraging"
                                data-tooltip="Ton plus positif et bienveillant">
                                <iconify-icon icon="solar:heart-linear"></iconify-icon> Encourageante
                            </button>
                            <button class="btn btn-ai-outline btn-tiny tooltip" data-refine-type="variations"
                                data-tooltip="Reformulation complète, même sens">
                                <iconify-icon icon="solar:restart-linear"></iconify-icon> Variation
                            </button>
                            <button class="btn btn-ai-outline btn-tiny tooltip" data-refine-type="polish"
                                data-tooltip="Corrige et améliore le style">
                                <span class="polish-icon-wrapper">
                                    <iconify-icon icon="solar:magic-stick-3-linear" class="polish-wand"></iconify-icon>
                                    <span class="polish-sparkle s1">✦</span>
                                    <span class="polish-sparkle s2">✦</span>
                                    <span class="polish-sparkle s3">✧</span>
                                </span>
                                Peaufiner
                            </button>
                        </div>
                    </div>
                </div> <!-- End focus-content -->
                <!-- Footer Page 1 -->
                <div class="focus-footer">
                    <button id="focusCopyBtn" class="btn btn-secondary tooltip" disabled
                        data-tooltip="Copier l'appréciation<br><i style='opacity:0.7'>Clic droit : copier le prompt</i>">
                        <iconify-icon icon="solar:copy-linear"></iconify-icon> Copier
                    </button>
                    <button id="focusGenerateBtn" class="btn btn-ai tooltip"
                        data-tooltip="Générer l'appréciation (Ctrl + Entrée)<br><i style='opacity:0.7'>Clic droit : prévisualiser le prompt</i>">
                        <iconify-icon icon="solar:magic-stick-3-linear"></iconify-icon> Générer <span
                            id="focusGeneratePeriod">T2</span>
                    </button>
                    <button id="focusAnalyzeBtn" class="btn btn-secondary">
                        <iconify-icon icon="solar:chart-2-linear"></iconify-icon> Analyser
                    </button>
                </div>
            </div>

            <!-- PAGE 2: Analysis (slides in from right) -->
            <div class="focus-page focus-analysis-page" id="focusAnalysisPage">
                <div class="focus-analysis-header">
                    <button id="focusAnalysisBackBtn" class="focus-back-btn" aria-label="Fermer l'analyse">
                        <iconify-icon icon="solar:alt-arrow-down-linear"></iconify-icon>
                    </button>
                    <h3 class="focus-analysis-title">
                        <iconify-icon icon="solar:chart-2-linear"></iconify-icon>
                        Analyse IA
                    </h3>
                    <button id="focusGenerateAnalysisBtn" class="btn btn-ai btn-sm">
                        <iconify-icon icon="solar:magic-stick-3-linear"></iconify-icon> Générer
                    </button>
                </div>

                <div class="focus-content focus-analysis-content-area">
                    <!-- Forces Card -->
                    <div class="analysis-card analysis-forces" id="analysisForces">
                        <div class="analysis-card-header">
                            <span class="analysis-icon forces"><iconify-icon
                                    icon="solar:cup-linear"></iconify-icon></span>
                            <h4>Forces</h4>
                        </div>
                        <div class="analysis-card-body" id="analysisForcesContent">
                            <div class="analysis-placeholder">
                                <iconify-icon icon="solar:lightbulb-linear"></iconify-icon>
                                <span>Cliquez sur "Générer" pour analyser les points forts.</span>
                            </div>
                        </div>
                    </div>

                    <!-- Faiblesses Card -->
                    <div class="analysis-card analysis-weaknesses" id="analysisWeaknesses">
                        <div class="analysis-card-header">
                            <span class="analysis-icon weaknesses"><iconify-icon
                                    icon="solar:danger-circle-linear"></iconify-icon></span>
                            <h4>Points de vigilance</h4>
                        </div>
                        <div class="analysis-card-body" id="analysisWeaknessesContent">
                            <div class="analysis-placeholder">
                                <iconify-icon icon="solar:magnifer-zoom-in-linear"></iconify-icon>
                                <span>Analyse des difficultés potentielles...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pistes Card -->
                    <div class="analysis-card analysis-suggestions" id="analysisSuggestions">
                        <div class="analysis-card-header">
                            <span class="analysis-icon suggestions"><iconify-icon
                                    icon="solar:rocket-2-linear"></iconify-icon></span>
                            <h4>Pistes de progrès</h4>
                        </div>
                        <div class="analysis-card-body" id="analysisSuggestionsContent">
                            <div class="analysis-placeholder">
                                <iconify-icon icon="solar:signpost-linear"></iconify-icon>
                                <span>Suggestions pour la progression...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <!-- ==================================================================== -->
    <!-- IMPORT WIZARD MODAL - 3-step import workflow                         -->
    <!-- ==================================================================== -->
    <div id="importWizardModal" class="modal import-wizard-modal" role="dialog" aria-modal="true"
        aria-labelledby="importWizardTitle">
        <div class="modal-content import-wizard-content">
            <!-- Unified Header & Stepper -->
            <div class="import-wizard-header-unified">
                <div class="wizard-header-title" id="importWizardTitle">
                    <div class="wizard-context-pill">
                        <span class="wizard-context-class" id="wizardClassBadge"></span>
                        <span class="wizard-context-sep">/</span>
                        <span class="wizard-context-period" id="wizardPeriodBadge">Trimestre 1</span>
                    </div>
                </div>

                <div class="ui-stepper">
                    <div class="ui-stepper-step active" data-step="1" role="button" tabindex="0">
                        <span class="ui-stepper-label">Données</span>
                    </div>
                    <div class="ui-stepper-separator">
                        <iconify-icon icon="solar:alt-arrow-right-linear"></iconify-icon>
                    </div>
                    <div class="ui-stepper-step" data-step="2" role="button" tabindex="0">
                        <span class="ui-stepper-label">Mapping</span>
                    </div>
                    <div class="ui-stepper-separator">
                        <iconify-icon icon="solar:alt-arrow-right-linear"></iconify-icon>
                    </div>
                    <div class="ui-stepper-step" data-step="3" role="button" tabindex="0">
                        <span class="ui-stepper-label">Confirmer</span>
                    </div>
                </div>

                <div class="wizard-header-actions">
                    <button class="close-button" id="closeImportWizardBtn" aria-label="Fermer">
                        <iconify-icon icon="ph:x"></iconify-icon>
                    </button>
                </div>
            </div>

            <div class="import-wizard-layout">
                <!-- LEFT: Guide Panel -->
                <aside class="wizard-guide-panel" id="wizardGuidePanel">
                    <!-- Step 1 Guide Content -->
                    <div class="guide-content active" data-guide-step="1">
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
                                Bon à savoir
                            </div>
                            <p class="guide-text">Les données seront importées pour la période affichée en en-tête.</p>
                            <p class="guide-hint">Pour changer, fermez et sélectionnez une autre période.</p>
                        </div>
                        <div class="guide-divider"></div>
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <iconify-icon icon="solar:import-linear"></iconify-icon>
                                Sources acceptées
                            </div>
                            <div class="guide-format-chips">
                                <div class="guide-format-chip tooltip" data-format="pdf"
                                    data-tooltip="PDF MBN / Pronote">
                                    <iconify-icon icon="ph:file-pdf"></iconify-icon>
                                </div>
                                <div class="guide-format-chip tooltip" data-format="excel" data-tooltip="Fichier Excel">
                                    <iconify-icon icon="ph:file-xls"></iconify-icon>
                                </div>
                                <div class="guide-format-chip tooltip" data-format="csv" data-tooltip="Fichier CSV">
                                    <iconify-icon icon="ph:file-csv"></iconify-icon>
                                </div>
                                <div class="guide-format-chip tooltip" data-format="clipboard"
                                    data-tooltip="Presse-papier">
                                    <iconify-icon icon="ph:clipboard-text"></iconify-icon>
                                </div>
                            </div>
                            <p class="guide-hint" style="margin-top: 8px;">Compatible PDF MBN / Pronote</p>
                        </div>
                        <div class="guide-divider"></div>
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <iconify-icon icon="solar:test-tube-linear"></iconify-icon>
                                Tester l'import
                            </div>
                            <p class="guide-text">Testez l'import avec des données fictives :</p>
                            <button class="guide-sample-btn" id="guideSampleBtn">
                                <iconify-icon icon="solar:magic-stick-3-bold"></iconify-icon>
                                Charger un exemple
                            </button>
                        </div>
                    </div>

                    <!-- Step 2 Guide Content -->
                    <div class="guide-content" data-guide-step="2">
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <iconify-icon icon="solar:list-bold"></iconify-icon>
                                Mapping des colonnes
                            </div>
                            <p class="guide-text">Associez chaque colonne de vos données à un champ de l'application.
                            </p>
                        </div>
                        <div class="guide-divider"></div>

                        <!-- Moved Separator Control -->
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <iconify-icon icon="solar:hashtag-bold"></iconify-icon>
                                Séparateur
                            </div>
                            <p class="guide-text">Si les colonnes sont mal découpées, changez ce paramètre.</p>
                            <div class="import-separator-row-guide">
                                <select id="wizardSeparatorSelect" class="import-separator-select full-width">
                                    <option value="tab">Tabulation</option>
                                    <option value=";">Point-virgule</option>
                                    <option value=",">Virgule</option>
                                    <option value="|">Barre (|)</option>
                                </select>
                            </div>
                        </div>

                        <div class="guide-divider"></div>
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <iconify-icon icon="solar:magic-stick-3-linear"></iconify-icon>
                                Détection automatique
                            </div>
                            <p class="guide-text">Les colonnes sont pré-remplies automatiquement. Ajustez si nécessaire.
                            </p>
                            <!-- Moved Auto-detect Button -->
                            <button class="guide-sample-btn" id="wizardAutoDetectBtn"
                                style="margin-top: 8px; width: 100%;">
                                <iconify-icon icon="solar:magic-stick-3-bold"></iconify-icon>
                                Relancer la détection
                            </button>
                        </div>
                    </div>

                    <!-- Step 3 Guide Content -->
                    <div class="guide-content" data-guide-step="3">
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <iconify-icon icon="ph:check"></iconify-icon>
                                Récapitulatif
                            </div>
                            <p class="guide-text">Vérifiez les données et décochez les colonnes que vous ne souhaitez
                                pas importer.</p>
                        </div>
                        <div class="guide-divider"></div>
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <iconify-icon icon="solar:palette-linear"></iconify-icon>
                                Légende
                            </div>
                            <div class="guide-legend-list">
                                <div class="guide-legend-item">
                                    <span class="guide-legend-dot dot-new"></span>
                                    <span>Nouveaux</span>
                                    <strong id="wizardNewCount" class="guide-legend-count count-new">0</strong>
                                </div>
                                <div class="guide-legend-item">
                                    <span class="guide-legend-dot dot-updated"></span>
                                    <span>Mis à jour <span
                                            class="guide-legend-overwrite-hint">(écrasement)</span></span>
                                    <strong id="wizardUpdatedCount" class="guide-legend-count count-updated">0</strong>
                                </div>
                                <div class="guide-legend-item">
                                    <span class="guide-legend-dot dot-departed"></span>
                                    <span>Absents</span>
                                    <strong id="wizardDepartedCount"
                                        class="guide-legend-count count-departed">0</strong>
                                </div>
                            </div>
                            <div class="guide-departed-action" id="wizardDepartedAction" style="display: none;">
                                <label class="guide-toggle-row" for="wizardDeleteDepartedToggle">
                                    <input type="checkbox" id="wizardDeleteDepartedToggle">
                                    <span>Supprimer les absents</span>
                                </label>
                            </div>
                        </div>
                        <div class="guide-divider"></div>
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
                                Bon à savoir
                            </div>
                            <p class="guide-text">Les élèves absents du fichier sont conservés. Seules les colonnes
                                cochées seront importées ou mises à jour.</p>
                            <p class="guide-hint guide-hint-warning" id="wizardOverwriteWarning" style="display:none;">
                                <iconify-icon icon="solar:danger-triangle-linear"></iconify-icon> Les données existantes
                                seront écrasées.
                            </p>
                        </div>
                    </div>
                </aside>

                <!-- RIGHT: Main Content -->
                <div class="wizard-main-content">
                    <div class="modal-body import-wizard-body">
                        <!-- Step 1: Data Input -->
                        <div class="wizard-step-content active" id="modalStep1" style="display: block;">
                            <div class="step-one-layout">
                                <!-- Enhanced Drop Zone -->
                                <div class="import-drop-zone" id="wizardDropZone">
                                    <!-- STATE 1: EMPTY -->
                                    <div class="drop-zone-content drop-zone-empty" id="wizardDropZoneEmpty">
                                        <div class="drop-zone-icon">
                                            <iconify-icon icon="solar:cloud-upload-linear"></iconify-icon>
                                        </div>
                                        <div class="drop-zone-text">
                                            <span class="drop-zone-title">Glisser-déposer un fichier</span>
                                            <span class="drop-zone-hint">ou <u>cliquer pour parcourir</u></span>
                                        </div>
                                    </div>

                                    <!-- STATE 2: FILLED (File visualization) -->
                                    <div class="drop-zone-content drop-zone-filled" id="wizardDropZoneFilled"
                                        style="display: none;">
                                        <div class="file-preview-card">
                                            <div class="file-preview-icon" id="wizardFileIcon">
                                                <iconify-icon icon="solar:file-text-bold"></iconify-icon>
                                            </div>
                                            <div class="file-preview-info">
                                                <span class="file-preview-name"
                                                    id="wizardFileName">mon_fichier_notes.pdf</span>
                                                <div id="wizardFileBadgeSlot">
                                                    <!-- Badge inserted here by JS -->
                                                </div>
                                            </div>
                                            <button class="file-remove-btn" id="wizardRemoveFileBtn"
                                                aria-label="Supprimer le fichier">
                                                <iconify-icon icon="ph:x"></iconify-icon>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Loading status overlay -->
                                    <div class="drop-zone-status" id="wizardDropZoneStatus">
                                        <div class="status-spinner"></div>
                                        <span class="status-text" id="wizardStatusText">Extraction du PDF...</span>
                                    </div>
                                    <input type="file" id="wizardFileInput" accept=".csv,.xlsx,.xls,.txt,.pdf"
                                        style="display: none;">
                                </div>

                                <div class="import-divider-horizontal">
                                    <span>ou</span>
                                </div>

                                <!-- Textarea with clear button -->
                                <div class="import-input-container">
                                    <textarea id="wizardDataTextarea" class="import-textarea" rows="6"
                                        placeholder="Collez vos données ici (Excel, CSV, Pronote...)&#10;&#10;Exemple :&#10;NOM Prénom      Moy.    Appréciation...&#10;MARTIN Lucas    12,5    Bon travail..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Mapping -->
                        <div class="wizard-step-content" id="modalStep2">


                            <div class="import-mapping-table-container" id="wizardMappingContainer">
                                <!-- Generated by JS: mapping table -->
                            </div>
                        </div>

                        <!-- Step 3: Confirm - Data Table with column checkboxes -->
                        <div class="wizard-step-content" id="modalStep3">

                            <div class="import-preview-table-container" id="wizardPreviewTableContainer">
                                <!-- Generated by JS: preview data table -->
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- UNIFIED WIZARD FOOTER - Single source of truth -->
            <!-- Step 1 Footer -->
            <div class="import-wizard-footer" id="wizardStep1Footer">
                <button class="btn btn-ghost" id="wizardStep1CancelBtn">Annuler</button>
                <div class="wizard-footer-center">
                    <!-- Format badge slot moved to drop zone -->
                    <!-- Line count -->
                    <div class="import-detected-info" id="wizardStep1LineCount" style="display: none;">
                        <strong id="wizardLineCountBadge">0</strong>
                        <span>lignes détectées</span>
                    </div>
                </div>
                <button class="btn btn-primary" id="wizardStep1NextBtn" disabled>
                    Suivant <iconify-icon icon="solar:arrow-right-linear"></iconify-icon>
                </button>
            </div>

            <!-- Step 2 Footer -->
            <div class="import-wizard-footer" id="wizardStep2Footer">
                <button class="btn btn-ghost" id="wizardStep2PrevBtn">
                    <iconify-icon icon="solar:arrow-left-linear"></iconify-icon> Précédent
                </button>
                <div class="import-detected-info">
                    <strong id="wizardCountBadge2">0</strong>
                    <span>élèves détectés</span>
                </div>
                <button class="btn btn-primary" id="wizardStep2NextBtn">
                    Suivant <iconify-icon icon="solar:arrow-right-linear"></iconify-icon>
                </button>
            </div>

            <!-- Step 3 Footer -->
            <div class="import-wizard-footer" id="wizardStep3Footer">
                <button class="btn btn-ghost" id="wizardStep3PrevBtn">
                    <iconify-icon icon="solar:arrow-left-linear"></iconify-icon> Précédent
                </button>
                <div class="step3-footer-info" id="wizardStep3FooterInfo">
                    <strong id="wizardSelectedColsBadge">0</strong>
                    <span id="wizardSelectedColsInfo">colonnes sélectionnées</span>
                </div>
                <button class="btn btn-organic btn-import-confirm" id="wizardImportOnlyBtn">
                    <iconify-icon icon="ph:check"></iconify-icon> Importer <span id="wizardImportCount">0</span> élèves
                </button>
            </div>
        </div>
    </div>


    <!-- ==================================================================== -->
    <!-- IMPORT HUB MODAL - Unified entry point for adding students           -->
    <!-- ==================================================================== -->
    <div id="importHubBackdrop" class="import-hub-backdrop" role="dialog" aria-modal="true"
        aria-labelledby="importHubTitle">
        <div class="import-hub-modal">
            <button class="import-hub-close" id="importHubCloseBtn" aria-label="Fermer">
                <iconify-icon icon="ph:x"></iconify-icon>
            </button>

            <div class="import-hub-header">
                <h2 class="import-hub-title" id="importHubTitle">Compléter votre classe</h2>
            </div>

            <div class="import-hub-choices">
                <!-- Individual Student Card -->
                <div class="import-hub-card" data-action="individual" tabindex="0" role="button">
                    <div class="import-hub-icon">
                        <iconify-icon icon="solar:user-plus-linear"></iconify-icon>
                    </div>
                    <h3 class="import-hub-card-title">Individuel</h3>
                    <p class="import-hub-card-desc">Saisie manuelle</p>
                </div>

                <!-- Mass Import Card -->
                <div class="import-hub-card" data-action="mass" tabindex="0" role="button">
                    <div class="import-hub-icon">
                        <iconify-icon icon="solar:users-group-rounded-linear"></iconify-icon>
                    </div>
                    <h3 class="import-hub-card-title">Classe entière</h3>
                    <p class="import-hub-card-desc">Fichier ou copier-coller</p>
                </div>

                <!-- Photo Import Card -->
                <div class="import-hub-card" data-action="photos" tabindex="0" role="button">
                    <div class="import-hub-icon">
                        <iconify-icon icon="solar:camera-linear"></iconify-icon>
                    </div>
                    <h3 class="import-hub-card-title">Photos</h3>
                    <p class="import-hub-card-desc">Depuis un trombinoscope</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================================================================== -->
    <!-- TROMBINOSCOPE WIZARD - Photo import from class photo                  -->
    <!-- ==================================================================== -->
    <div id="trombiWizardModal" class="trombi-wizard-modal" role="dialog" aria-modal="true">
        <div id="trombiWizardBackdrop" class="trombi-wizard-backdrop"></div>
        <div class="trombi-wizard-content">
            <div class="trombi-wizard-header">
                <div class="trombi-header-title">
                    <div class="trombi-title-pill">
                        <iconify-icon class="iconify-inline" icon="solar:camera-linear"></iconify-icon>
                        <span id="trombiClassBadge"></span>
                    </div>
                </div>
                <div class="ui-stepper">
                    <div class="ui-stepper-step active" data-step="1">
                        <span class="ui-stepper-label">1. Image</span>
                    </div>
                    <div class="ui-stepper-separator"><iconify-icon icon="solar:alt-arrow-right-linear"></iconify-icon>
                    </div>
                    <div class="ui-stepper-step" data-step="2">
                        <span class="ui-stepper-label">2. Association</span>
                    </div>
                    <div class="ui-stepper-separator"><iconify-icon icon="solar:alt-arrow-right-linear"></iconify-icon>
                    </div>
                    <div class="ui-stepper-step" data-step="3">
                        <span class="ui-stepper-label">3. Confirmer</span>
                    </div>
                </div>
                <button class="close-button" id="closeTrombiWizardBtn" aria-label="Fermer">
                    <iconify-icon icon="ph:x"></iconify-icon>
                </button>
            </div>

            <div class="trombi-wizard-body">
                <!-- Step 1: Upload trombinoscope image -->
                <div class="trombi-step-content" id="trombiStep1" style="display: flex;">
                    <div class="import-wizard-layout">
                        <!-- Left Guide Panel -->
                        <aside class="wizard-guide-panel" id="trombiGuidePanel">
                            <div class="guide-content active" style="display: flex;">
                                <div class="guide-section">
                                    <div class="guide-section-title">
                                        <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
                                        Bon à savoir
                                    </div>
                                    <p class="guide-text">Importez une photo de classe pour générer un trombinoscope
                                        interactif.</p>
                                    <p class="guide-hint">Formats acceptés : JPG, PNG, WebP.</p>
                                </div>
                                <div class="guide-divider"></div>
                                <div class="guide-section">
                                    <div class="guide-section-title">
                                        <iconify-icon class="iconify-inline"
                                            icon="solar:test-tube-linear"></iconify-icon>
                                        Tester
                                    </div>
                                    <p class="guide-text">Utilisez une image d'exemple pour tester la détection :</p>
                                    <button class="guide-sample-btn" id="trombiSampleBtn">
                                        <iconify-icon class="iconify-inline" icon="solar:gallery-linear"></iconify-icon>
                                        Charger un exemple
                                    </button>
                                </div>
                            </div>
                        </aside>

                        <!-- Main Content -->
                        <div class="wizard-main-content" style="padding: 16px;">
                            <div class="trombi-drop-zone" id="trombiDropZone">
                                <!-- Placeholder content (shown when no image) -->
                                <div class="drop-zone-content" id="trombiDropPlaceholder">
                                    <div class="drop-zone-icon">
                                        <iconify-icon icon="solar:cloud-upload-linear"></iconify-icon>
                                    </div>
                                    <div class="drop-zone-text">
                                        <span class="drop-zone-title">Glissez ou Collez (Ctrl+V) le trombinoscope
                                            ici</span>
                                        <span class="drop-zone-hint">ou <u>cliquez pour parcourir</u></span>
                                    </div>
                                </div>
                                <!-- Preview content (shown when image loaded) -->
                                <div class="drop-zone-preview" id="trombiDropPreview">
                                    <img src="" alt="Trombinoscope" class="drop-zone-image" id="trombiPreviewImg">
                                    <div class="drop-zone-overlay">
                                        <iconify-icon icon="solar:camera-linear"></iconify-icon>
                                        <span>Cliquez pour changer l'image</span>
                                    </div>
                                </div>
                                <!-- Sample button moved to sidebar -->
                            </div>
                            <input type="file" id="trombiFileInput" accept="image/*" style="display: none;">
                        </div>
                    </div>
                </div>

                <!-- Step 2: Assign students to zones -->
                <div class="trombi-step-content trombi-step-padded" id="trombiStep2" style="display: none;">
                    <div class="trombi-split-view">
                        <div class="trombi-image-panel">
                            <div id="trombiImageWithZones" class="trombi-image-wrapper">
                                <!-- Image with zone overlay will be cloned here -->
                            </div>
                        </div>
                        <div class="trombi-assignment-panel">
                            <div class="trombi-assignment-panel-header">
                                <h4>Associer les élèves aux zones</h4>
                                <!-- Auto button removed - assignment is now automatic -->
                            </div>
                            <div id="trombiAssignmentGrid" class="trombi-assignment-grid">
                                <!-- Generated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Preview and confirm -->
                <div class="trombi-step-content trombi-step-padded" id="trombiStep3" style="display: none;">
                    <div id="trombiPreviewGrid" class="trombi-preview-grid">
                        <!-- Preview generated by JS -->
                    </div>
                </div>
            </div>

            <!-- FOOTERS - Ancrés en bas, hors du body scrollable -->
            <div class="trombi-step-footer" id="trombiStep1Footer">
                <button class="btn btn-ghost" id="trombiStep1CancelBtn">Annuler</button>
                <span class="trombi-footer-info" id="trombiImageInfo"></span>
                <button class="btn btn-primary" id="trombiStep1NextBtn" disabled>
                    Suivant <iconify-icon class="iconify-inline" icon="solar:arrow-right-linear"></iconify-icon>
                </button>
            </div>

            <div class="trombi-step-footer" id="trombiStep2Footer" style="display: none;">
                <button class="btn btn-ghost" id="trombiStep2PrevBtn">
                    <iconify-icon class="iconify-inline" icon="solar:arrow-left-linear"></iconify-icon> Précédent
                </button>
                <span class="trombi-footer-info" id="trombiZonesInfo"></span>
                <button class="btn btn-primary" id="trombiStep2NextBtn">
                    Suivant <iconify-icon class="iconify-inline" icon="solar:arrow-right-linear"></iconify-icon>
                </button>
            </div>

            <div class="trombi-step-footer" id="trombiStep3Footer" style="display: none;">
                <button class="btn btn-ghost" id="trombiStep3PrevBtn">
                    <iconify-icon class="iconify-inline" icon="solar:arrow-left-linear"></iconify-icon> Précédent
                </button>
                <button class="btn btn-primary" id="trombiConfirmBtn">
                    <iconify-icon icon="ph:check"></iconify-icon> Importer les photos
                </button>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="personalizationModal" class="modal modal-lab" role="dialog" aria-modal="true"
        aria-labelledby="personalizationModalTitle">
        <div class="modal-content personalization-modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="personalizationModalTitle">
                    <span class="modal-title-icon color-accent"><iconify-icon
                            icon="solar:magic-stick-3-linear"></iconify-icon></span>
                    <span class="modal-title-text">Laboratoire de Style</span>
                </h2>
                <div class="modal-header-actions spaced">
                    <button type="button" class="icon-button tooltip" id="resetLabStyleBtn"
                        data-tooltip="Réinitialiser les réglages">
                        <iconify-icon icon="solar:restart-linear"></iconify-icon>
                    </button>
                    <button type="button" class="icon-button tooltip" id="toggleInspectorBtn"
                        data-tooltip="Inspecteur de prompt">
                        <iconify-icon icon="solar:code-square-linear"></iconify-icon>
                    </button>
                    <button class="close-button" id="closePersonalizationModalBtn" aria-label="Fermer">
                        <iconify-icon icon="ph:x"></iconify-icon>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="settings-layout-grid personalization-grid">
                    <!-- CARTE 1: RÉGLAGES DE STYLE IA -->
                    <div class="settings-controls-column">
                        <div class="settings-card settings-card-full-height" id="settings-controls-panel">
                            <div class="settings-card-header-row">
                                <h3 class="settings-card-title" id="iaStyleHeader">
                                    <iconify-icon class="iconify-inline" icon="solar:tuning-2-linear"></iconify-icon>
                                    Style de Rédaction
                                </h3>
                                <div class="toggle-switch-container tooltip"
                                    data-tooltip="Activer pour personnaliser le style de rédaction (Ton, Longueur, Voix, etc.)">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="personalizationToggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <p id="genericSubjectInfo" class="generic-info-card"
                                style="margin-top: 0; margin-bottom: 20px;">
                                <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
                                Activez "Mon Style" pour modifier ces paramètres. Sinon, les réglages par défaut
                                s'appliquent.
                            </p>

                            <div class="settings-card-content">

                                <div class="form-group">
                                    <label for="iaDiscipline">Ma discipline (Optionnel)
                                        <span class="tooltip"
                                            data-tooltip="L'IA peut adapter son vocabulaire à la matière. Effet parfois prononcé : à utiliser avec discernement.">
                                            <iconify-icon class="iconify-inline" icon="solar:info-circle-linear"
                                                style="opacity: 0.6; margin-left: 4px;"></iconify-icon>
                                        </span>
                                    </label>
                                    <input type="text" id="iaDiscipline"
                                        placeholder="Ex: Mathématiques, Français, Histoire-Géographie..."
                                        class="settings-input" maxlength="50">
                                </div>

                                <div class="form-group">
                                    <div class="slider-header-row">
                                        <label for="iaLengthSlider">Cible de Mots</label>
                                        <span id="iaLengthSliderValue" class="slider-value-display">~ 60 mots</span>
                                    </div>
                                    <div class="length-slider-container slider-container">
                                        <input type="range" id="iaLengthSlider" min="10" max="100" value="60" step="5">
                                        <div class="slider-labels">
                                            <span>Court</span><span>Moyen</span><span>Long</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="slider-header-row">
                                        <label for="iaToneSlider">Ton de l'appréciation</label>
                                        <span id="iaToneSliderValue" class="slider-value-display">Équilibré, factuel
                                            et
                                            neutre</span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" id="iaToneSlider" min="1" max="5" value="3">
                                        <div class="slider-ticks">
                                            <span class="tick"></span>
                                            <span class="tick"></span>
                                            <span class="tick"></span>
                                            <span class="tick"></span>
                                            <span class="tick"></span>
                                        </div>
                                        <div class="slider-labels">
                                            <span>Positif</span><span>Équilibré</span><span>Strict</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Voix du rédacteur</label>
                                    <div class="ui-segmented-control compact" id="iaVoiceSelector">
                                        <input type="radio" id="voiceDefault" name="iaVoiceRadio" value="default"
                                            checked>
                                        <label for="voiceDefault" class="ui-segment tooltip"
                                            data-tooltip="Laisse l'IA choisir le pronom (Je, Nous, impersonnel...).">Défaut</label>
                                        <input type="radio" id="voiceJe" name="iaVoiceRadio" value="je">
                                        <label for="voiceJe" class="ui-segment tooltip"
                                            data-tooltip="Force l'IA à utiliser la première personne du singulier ('Je').">Je</label>
                                        <input type="radio" id="voiceNous" name="iaVoiceRadio" value="nous">
                                        <label for="voiceNous" class="ui-segment tooltip"
                                            data-tooltip="Force l'IA à utiliser la première personne du pluriel ('Nous'), plus formel.">Nous</label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="slider-header-row">
                                        <label for="iaStyleInstructions" style="margin-bottom: 0;">Ma "Patte"
                                            (Optionnel)</label>
                                        <div class="toggle-switch-container compact" style="margin: 0;">
                                            <label class="toggle-switch small">
                                                <input type="checkbox" id="iaStyleInstructionsToggle" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <textarea id="iaStyleInstructions"
                                        placeholder="Exemples : Mettre l'accent sur l'expression orale • Mentionner la rigueur du raisonnement • Ne jamais utiliser le mot performance • Toujours encourager la participation..."
                                        class="style-instructions-textarea"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CARTE 2: LABORATOIRE D'APERÇU -->
                    <div class="settings-preview-column">
                        <div class="settings-card settings-card-full-height">
                            <h3 class="settings-card-title"><iconify-icon class="iconify-inline"
                                    icon="solar:test-tube-linear"></iconify-icon> Aperçu</h3>
                            <div class="settings-card-content">
                                <!-- Unified Data Card -->
                                <div class="preview-unified-card">
                                    <!-- Header: Student Selector -->
                                    <div class="preview-card-header">
                                        <div style="display:none!important;" aria-hidden="true">
                                            <select id="previewStudentSelect"></select>
                                        </div>
                                        <button type="button" class="nav-arrow-custom" id="previewPrevStudentBtn"
                                            aria-label="Élève précédent">
                                            <iconify-icon icon="solar:alt-arrow-left-linear"></iconify-icon>
                                        </button>
                                        <div class="header-student-name" id="previewStudentNameDisplay">
                                            Chargement...</div>
                                        <button type="button" class="nav-arrow-custom" id="previewNextStudentBtn"
                                            aria-label="Élève suivant">
                                            <iconify-icon icon="solar:alt-arrow-right-linear"></iconify-icon>
                                        </button>
                                    </div>

                                    <!-- Body: Context + Table -->
                                    <div id="settingsPreviewStudentData" class="preview-card-body">
                                    </div>
                                </div>

                                <p id="previewStatus" class="preview-status" style="display: none;"></p>

                                <!-- Section Aperçu avec bouton de génération -->
                                <div class="preview-result-header">
                                    <div class="result-ia-title">
                                        <iconify-icon class="iconify-inline"
                                            icon="solar:magic-stick-3-bold"></iconify-icon> Appréciation
                                    </div>
                                    <button id="refreshPreviewBtn" class="btn btn-primary btn-small tooltip"
                                        data-tooltip="Générer une appréciation avec l'IA"><iconify-icon
                                            class="iconify-inline" icon="solar:play-circle-bold"></iconify-icon>
                                        Générer</button>
                                </div>
                                <div class="refinement-group">
                                    <div class="refinement-content" id="settingsPreviewResult">Cliquez sur
                                        "Générer" pour voir l'impact de vos réglages en direct.</div>
                                    <div class="preview-meta-container" id="previewMetaContainer"
                                        style="display: none;">
                                        <div class="preview-model-badge" id="previewModelBadge" style="display: none;">
                                            <iconify-icon icon="solar:magic-stick-3-bold"></iconify-icon> —
                                        </div>
                                        <div class="word-count" id="settingsPreviewTokenCount"></div>
                                        <div class="word-count" id="settingsPreviewWordCount">0 mots • 0 car.</div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- CARTE 3: INSPECTEUR DE PROMPT (collapsible) -->
                    <div class="settings-inspector-column" id="inspectorColumn">
                        <div class="settings-card settings-card-full-height">
                            <div class="settings-card-header-row">
                                <h3 class="settings-card-title"><iconify-icon class="iconify-inline"
                                        icon="solar:terminal-bold"></iconify-icon> Inspecteur de Prompt
                                </h3>
                                <button type="button" class="btn-icon-small tooltip" id="copyPromptBtn"
                                    data-tooltip="Copier le prompt" aria-label="Copier le prompt">
                                    <iconify-icon icon="solar:copy-bold"></iconify-icon>
                                </button>
                            </div>
                            <div class="settings-card-content">
                                <div id="settingsPreviewPrompt" class="help-code-block prompt-preview-block">
                                    Le prompt s'affichera ici après avoir rafraîchi l'aperçu.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelPersonalizationBtn">Fermer</button>
                <button class="btn btn-primary" id="savePersonalizationBtn"><iconify-icon
                        icon="ph:check-bold"></iconify-icon>
                    Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="appSettingsModal" class="modal modal-help" role="dialog" aria-modal="true"
        aria-labelledby="settingsModalTitle">

        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="settingsModalTitle">
                    <span class="modal-title-icon color-secondary"><iconify-icon class="iconify-inline"
                            icon="solar:settings-bold"></iconify-icon></span>
                    <span class="modal-title-text">Paramètres</span>
                </h2>
                <button class="close-button" id="closeSettingsModalBtn" aria-label="Fermer les paramètres">
                    <iconify-icon class="iconify-inline" icon="ph:x"></iconify-icon>
                </button>
            </div>

            <div class="modal-body modal-body-flex">
                <div class="ui-tabs-vertical">
                    <!-- Sidebar Navigation -->
                    <div class="ui-tabs-sidebar">
                        <button class="ui-tabs-btn active" onclick="switchHelpTab(this, 'settings-engine')">
                            <iconify-icon class="iconify-inline icon-key" icon="solar:cpu-bold"></iconify-icon> IA &
                            Clés
                        </button>
                        <button class="ui-tabs-btn" onclick="switchHelpTab(this, 'settings-preferences')">
                            <iconify-icon class="iconify-inline icon-customize"
                                icon="solar:tuning-2-bold"></iconify-icon> Préférences
                        </button>
                        <button class="ui-tabs-btn" onclick="switchHelpTab(this, 'settings-privacy')">
                            <iconify-icon class="iconify-inline icon-privacy"
                                icon="solar:shield-user-bold"></iconify-icon> Confidentialité
                        </button>
                        <button class="ui-tabs-btn" onclick="switchHelpTab(this, 'settings-data')">
                            <iconify-icon class="iconify-inline icon-format" icon="solar:database-bold"></iconify-icon>
                            Données
                        </button>

                        <div
                            style="margin-top: auto; padding-top: 10px; width: 100%; display: flex; flex-direction: column; gap: 8px;">
                            <button class="ui-tabs-action-btn"
                                onclick="UI.openModal(DOM.helpModal, { isStacked: true })">
                                <iconify-icon class="iconify-inline" icon="solar:info-circle-bold"></iconify-icon>
                                Guide & Aide
                            </button>
                            <button class="ui-tabs-action-btn" id="checkUpdatesBtn">
                                <iconify-icon class="iconify-inline" icon="solar:restart-bold"></iconify-icon> Mises à
                                jour
                            </button>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="ui-tabs-content">
                        <div id="settings-engine" class="help-tab-content active">
                            <div class="help-section-header">
                                <div class="help-section-icon"><iconify-icon icon="solar:cpu-bold"></iconify-icon></div>
                                <p>Choix du modèle d'intelligence artificielle et configuration des clés API (+ tokens
                                    utilisés : <b id="sessionTokens" class="session-cost-value">0</b>).</p>
                            </div>

                            <div class="help-step-card">
                                <div class="help-step-layout">
                                    <div class="help-step-number"><iconify-icon icon="solar:cpu-bold"></iconify-icon>
                                    </div>
                                    <div class="help-step-body" style="width: 100%;">
                                        <strong>Fournisseur IA (Choix du modèle)</strong>
                                        <div id="apiStatusSummary" class="api-status-summary compact-mode mt-2">
                                            <div class="api-status-header compact">
                                                <div class="model-selector-wrapper">
                                                    <label for="aiModelSelect" class="sr-only">Modèle actif</label>
                                                    <select id="aiModelSelect" class="compact-model-select">
                                                        <optgroup label="🐱 Mistral AI — GRATUIT 🇫🇷 (1B tokens/mois)">
                                                            <option value="mistral-direct-small-latest">Mistral Small
                                                                3.1
                                                                (Recommandé)
                                                            </option>
                                                            <option value="mistral-direct-large-latest">Mistral Large 3
                                                                (Puissant)
                                                            </option>
                                                        </optgroup>
                                                        <optgroup label="💚 Google Gemini — QUOTA GRATUIT">
                                                            <option value="gemini-3-flash-preview">Gemini 3 Flash
                                                                (Rapide)
                                                            </option>
                                                            <option value="gemini-2.5-flash">Gemini 2.5 Flash (Stable)
                                                            </option>
                                                            <option value="gemini-2.5-pro">Gemini 2.5 Pro (Équilibré)
                                                            </option>
                                                            <option value="gemini-3-pro">Gemini 3 Pro (Puissant)
                                                            </option>
                                                        </optgroup>
                                                        <optgroup label="💚 OpenRouter — QUOTA GRATUIT">
                                                            <option value="llama-3.3-70b-free">Llama 3.3 70B (Puissant -
                                                                Journalier)
                                                            </option>
                                                            <option value="devstral-free">Devstral (Secours - Illimité?)
                                                            </option>
                                                        </optgroup>
                                                        <optgroup label="💰 OpenRouter — PAYANT (économique)">
                                                            <option value="claude-sonnet-4.5">Claude Sonnet 4.5
                                                                (Puissant)</option>
                                                            <option value="ministral-3b">Ministral 3B (~0€, Mistral)
                                                            </option>
                                                            <option value="amazon-nova-v1-lite">Nova Lite v1 (Très
                                                                économique)
                                                            </option>
                                                            <option value="openrouter">DeepSeek V3 (Économique)</option>
                                                            <option value="mistral-small">Mistral Small (Français)
                                                            </option>
                                                            <option value="mistral-large">Mistral Large (Puissant)
                                                            </option>
                                                        </optgroup>
                                                        <optgroup label="💰 OpenAI — PAYANT">
                                                            <option value="openai-gpt-4o-mini">GPT-4o Mini (Économique)
                                                            </option>
                                                            <option value="openai-gpt-3.5-turbo">GPT-3.5 Turbo (Rapide)
                                                            </option>
                                                            <option value="openai-gpt-4o">GPT-4o (Puissant)</option>
                                                        </optgroup>
                                                        <optgroup label="💰 Anthropic Claude — PAYANT">
                                                            <option value="anthropic-claude-sonnet-4.5">Claude Sonnet
                                                                4.5
                                                                (Puissant)</option>
                                                            <option value="anthropic-claude-opus-4.5">Claude Opus 4.5
                                                                (Le plus
                                                                puissant)</option>
                                                        </optgroup>

                                                        <optgroup label="🏠 Ollama — LOCAL">
                                                            <option value="ollama-qwen3:8b">🏠 Qwen 3 8B (Recommandé)
                                                            </option>
                                                            <option value="ollama-mistral">🏠 Mistral 7B (Standard)
                                                            </option>
                                                            <option value="ollama-deepseek-r1:8b">🏠 DeepSeek R1
                                                                (Raisonnement)
                                                            </option>
                                                        </optgroup>
                                                    </select>
                                                </div>
                                                <button id="testAllConnectionsBtn"
                                                    class="btn btn-secondary btn-icon-only tooltip"
                                                    data-tooltip="Vérifier la connexion">
                                                    <iconify-icon icon="solar:restart-bold"></iconify-icon>
                                                </button>
                                            </div>
                                            <div class="api-status-pills-row">
                                                <div class="status-pill inactive" id="googleApiStatus" tabindex="0"
                                                    title="Non configurée">
                                                    <span class="status-dot"></span> Google
                                                </div>
                                                <div class="status-pill inactive" id="openrouterApiStatus" tabindex="0"
                                                    title="Non configurée">
                                                    <span class="status-dot"></span> OpenRouter
                                                </div>
                                                <div class="status-pill inactive" id="openaiApiStatus" tabindex="0"
                                                    title="Non configurée">
                                                    <span class="status-dot"></span> OpenAI
                                                </div>
                                                <div class="status-pill inactive" id="anthropicApiStatus" tabindex="0"
                                                    title="Non configurée">
                                                    <span class="status-dot"></span> Claude
                                                </div>
                                                <div class="status-pill inactive" id="mistralApiStatus" tabindex="0"
                                                    title="Non configurée">
                                                    <span class="status-dot"></span> Mistral AI
                                                </div>
                                                <div class="status-pill inactive" id="ollamaApiStatus" tabindex="0"
                                                    title="Non activé">
                                                    <span class="status-dot"></span> Ollama
                                                </div>
                                            </div>


                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="help-step-card">
                                <div class="help-step-layout">
                                    <div class="help-step-number"><iconify-icon icon="solar:key-bold"></iconify-icon>
                                    </div>
                                    <div class="help-step-body" style="width: 100%;">
                                        <strong>Clés API & Relais</strong>
                                        <div class="mt-2">
                                            <div class="api-fallback-row">
                                                <div class="toggle-switch-container compact">
                                                    <label class="toggle-switch small">
                                                        <input type="checkbox" id="enableApiFallbackToggle" checked>
                                                        <span class="slider"></span>
                                                    </label>
                                                    <label for="enableApiFallbackToggle"
                                                        class="toggle-label-text">Relais
                                                        auto.</label>
                                                </div>
                                                <div class="fallback-info">
                                                    <small id="fallbackOrderHint">
                                                        <!-- Arrow removed -->
                                                        <span id="fallbackOrderText">...</span>
                                                        <span id="fallbackOrderMore" class="fallback-more-badge tooltip"
                                                            style="display: none;"></span>
                                                    </small>
                                                </div>
                                            </div>

                                            <div id="missingApiKeyWarning" class="missing-key-warning compact"
                                                style="display: none;">
                                                <iconify-icon icon="solar:danger-triangle-bold"></iconify-icon>
                                                <span id="missingKeyText">Clé manquante.</span>
                                                <button type="button" class="btn-link"
                                                    id="openApiKeysAccordionBtn">Configurer</button>
                                            </div>

                                            <small id="aiModelDescription" style="display: none;">Description du modèle
                                                sélectionné...</small>
                                        </div>

                                        <details class="ui-accordion" id="apiKeysAccordion">
                                            <summary><iconify-icon class="iconify-inline"
                                                    icon="solar:key-bold"></iconify-icon>
                                                Gérer mes clés API</summary>
                                            <div class="ui-accordion-content">
                                                <form class="ui-accordion-content-inner api-keys-container"
                                                    action="javascript:void(0)" autocomplete="off">
                                                    <div class="api-key-section" id="mistralApiKeyGroup">
                                                        <div class="api-key-header">
                                                            <span class="api-key-provider"><iconify-icon
                                                                    class="iconify-inline" icon="solar:cat-bold"
                                                                    style="color: #fd6f00;"></iconify-icon>
                                                                Mistral AI
                                                                (API directe)</span>
                                                            <div class="api-key-links">
                                                                <a href="https://console.mistral.ai/api-keys"
                                                                    target="_blank" rel="noopener noreferrer"
                                                                    class="btn-link">Obtenir une
                                                                    clé (gratuit)</a>
                                                                <a href="https://console.mistral.ai/usage"
                                                                    target="_blank" rel="noopener noreferrer"
                                                                    class="btn-link btn-link-secondary"><i
                                                                        class="fas fa-wallet"></i> Usage</a>
                                                            </div>
                                                        </div>
                                                        <div class="api-key-actions">
                                                            <div class="api-key-input-container">
                                                                <input type="password" id="mistralApiKey"
                                                                    placeholder="Clé Mistral..."
                                                                    autocomplete="new-password">
                                                                <span id="mistralApiKeyValidationIcon"
                                                                    class="api-key-validation-icon"></span>
                                                            </div>
                                                            <button type="button" id="validateMistralApiKeyBtn"
                                                                class="btn btn-purple btn-small">Vérifier</button>
                                                        </div>
                                                        <div class="error-message" id="mistralApiKeyError"
                                                            style="display: none;">
                                                        </div>
                                                    </div>

                                                    <div class="api-key-section" id="googleApiKeyGroup">
                                                        <div class="api-key-header">
                                                            <span class="api-key-provider"><iconify-icon
                                                                    class="iconify-inline"
                                                                    icon="logos:google-icon"></iconify-icon> Google
                                                                Gemini</span>
                                                            <a href="https://aistudio.google.com/app/apikey"
                                                                target="_blank" rel="noopener noreferrer"
                                                                class="btn-link">Obtenir une clé
                                                                (gratuit limité)</a>
                                                        </div>
                                                        <div class="api-key-actions">
                                                            <div class="api-key-input-container">
                                                                <input type="password" id="googleApiKey"
                                                                    placeholder="AIzaSy..." autocomplete="new-password">
                                                                <span id="googleApiKeyValidationIcon"
                                                                    class="api-key-validation-icon"></span>
                                                            </div>
                                                            <button type="button" id="validateGoogleApiKeyBtn"
                                                                class="btn btn-purple btn-small">Vérifier</button>
                                                        </div>
                                                        <div class="error-message" id="googleApiKeyError"
                                                            style="display: none;">
                                                        </div>
                                                    </div>

                                                    <div class="api-key-section" id="openrouterApiKeyGroup">
                                                        <div class="api-key-header">
                                                            <span class="api-key-provider"><iconify-icon
                                                                    class="iconify-inline"
                                                                    icon="solar:bolt-bold-duotone"
                                                                    style="color: var(--secondary-color);"></iconify-icon>
                                                                OpenRouter
                                                                (Mistral, DeepSeek...)</span>
                                                            <div class="api-key-links">
                                                                <a href="https://openrouter.ai/keys" target="_blank"
                                                                    rel="noopener noreferrer" class="btn-link">Obtenir
                                                                    une
                                                                    clé (gratuit dispo.)</a>
                                                                <a href="https://openrouter.ai/credits" target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    class="btn-link btn-link-secondary"><iconify-icon
                                                                        class="iconify-inline"
                                                                        icon="solar:wallet-bold"></iconify-icon>
                                                                    Usage</a>
                                                            </div>
                                                        </div>
                                                        <div class="api-key-actions">
                                                            <div class="api-key-input-container">
                                                                <input type="password" id="openrouterApiKey"
                                                                    placeholder="sk-or-..." autocomplete="new-password">
                                                                <span id="openrouterApiKeyValidationIcon"
                                                                    class="api-key-validation-icon"></span>
                                                            </div>
                                                            <button type="button" id="validateOpenrouterApiKeyBtn"
                                                                class="btn btn-purple btn-small">Vérifier</button>
                                                        </div>
                                                        <div class="error-message" id="openrouterApiKeyError"
                                                            style="display: none;">
                                                        </div>
                                                    </div>

                                                    <div class="api-key-section" id="openaiApiKeyGroup">
                                                        <div class="api-key-header">
                                                            <span class="api-key-provider"><iconify-icon
                                                                    class="iconify-inline"
                                                                    icon="logos:openai-icon"></iconify-icon> OpenAI
                                                                (ChatGPT)</span>
                                                            <div class="api-key-links">
                                                                <a href="https://platform.openai.com/api-keys"
                                                                    target="_blank" rel="noopener noreferrer"
                                                                    class="btn-link">Obtenir une
                                                                    clé (payant)</a>
                                                                <a href="https://platform.openai.com/usage"
                                                                    target="_blank" rel="noopener noreferrer"
                                                                    class="btn-link btn-link-secondary"><i
                                                                        class="fas fa-wallet"></i> Usage</a>
                                                            </div>
                                                        </div>
                                                        <div class="api-key-actions">
                                                            <div class="api-key-input-container">
                                                                <input type="password" id="openaiApiKey"
                                                                    placeholder="sk-..." autocomplete="new-password">
                                                                <span id="openaiApiKeyValidationIcon"
                                                                    class="api-key-validation-icon"></span>
                                                            </div>
                                                            <button type="button" id="validateOpenaiApiKeyBtn"
                                                                class="btn btn-purple btn-small">Vérifier</button>
                                                        </div>
                                                        <div class="error-message" id="openaiApiKeyError"
                                                            style="display: none;">
                                                        </div>
                                                    </div>

                                                    <div class="api-key-section" id="anthropicApiKeyGroup">
                                                        <div class="api-key-header">
                                                            <span class="api-key-provider"><iconify-icon
                                                                    class="iconify-inline"
                                                                    icon="logos:anthropic-icon"></iconify-icon> Claude
                                                                (Anthropic)</span>
                                                            <div class="api-key-links">
                                                                <a href="https://console.anthropic.com/settings/keys"
                                                                    target="_blank" rel="noopener noreferrer"
                                                                    class="btn-link">Obtenir une
                                                                    clé (payant)</a>
                                                                <a href="https://console.anthropic.com/settings/usage"
                                                                    target="_blank" rel="noopener noreferrer"
                                                                    class="btn-link btn-link-secondary"><i
                                                                        class="fas fa-wallet"></i> Usage</a>
                                                            </div>
                                                        </div>
                                                        <div class="api-key-actions">
                                                            <div class="api-key-input-container">
                                                                <input type="password" id="anthropicApiKey"
                                                                    placeholder="sk-ant-..."
                                                                    autocomplete="new-password">
                                                                <span id="anthropicApiKeyValidationIcon"
                                                                    class="api-key-validation-icon"></span>
                                                            </div>
                                                            <button type="button" id="validateAnthropicApiKeyBtn"
                                                                class="btn btn-purple btn-small">Vérifier</button>
                                                        </div>
                                                        <div class="error-message" id="anthropicApiKeyError"
                                                            style="display: none;">
                                                        </div>
                                                    </div>



                                                    <!-- Section Ollama (IA locale) -->
                                                    <div class="api-key-section ollama-section" id="ollamaConfigGroup">
                                                        <div class="api-key-header">
                                                            <span class="api-key-provider"><iconify-icon
                                                                    class="iconify-inline"
                                                                    icon="solar:server-square-bold"></iconify-icon>
                                                                Ollama (IA
                                                                Locale)</span>
                                                            <div style="display:flex; gap:10px; align-items:center;">
                                                                <a href="https://ollama.com" target="_blank"
                                                                    rel="noopener noreferrer" class="btn-link">Installer
                                                                    Ollama</a>
                                                            </div>
                                                        </div>
                                                        <div class="api-key-info">
                                                            <iconify-icon icon="solar:info-circle-bold"></iconify-icon>
                                                            Ollama permet d'exécuter des IA sur votre PC.
                                                            <strong>Gratuit et
                                                                illimité</strong>, sans envoyer vos données sur
                                                            internet.
                                                        </div>
                                                        <div class="api-key-actions api-key-actions-wrap">
                                                            <div class="toggle-switch-container toggle-full-width">
                                                                <label class="toggle-switch">
                                                                    <input type="checkbox" id="ollamaEnabledToggle">
                                                                    <span class="slider"></span>
                                                                </label>
                                                                <label for="ollamaEnabledToggle"
                                                                    class="toggle-switch-label">Activer
                                                                    Ollama</label>
                                                            </div>
                                                            <div class="api-key-input-container" style="flex: 1;">
                                                                <input type="text" id="ollamaBaseUrl"
                                                                    placeholder="http://localhost:11434"
                                                                    value="http://localhost:11434"
                                                                    style="font-family: monospace;">
                                                                <span id="ollamaValidationIcon"
                                                                    class="api-key-validation-icon"></span>
                                                            </div>
                                                            <button type="button" id="validateOllamaBtn"
                                                                class="btn btn-purple btn-small">Vérifier</button>
                                                        </div>
                                                        <div class="error-message" id="ollamaError"
                                                            style="display: none;"></div>
                                                        <div id="ollamaModelsInfo"
                                                            style="display: none; margin-top: 10px; font-size: 0.85em;">
                                                            <iconify-icon class="iconify-inline" icon="ph:check-bold"
                                                                style="color: var(--success-color);"></iconify-icon>
                                                            <span id="ollamaModelsText">Modèles installés : ...</span>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div> <!-- /ui-accordion-content-inner -->
                                    </div> <!-- /ui-accordion-content -->
                                    </details>
                                </div> <!-- /help-step-body -->
                            </div> <!-- /help-step-layout -->
                        </div>
                        <div id="settings-preferences" class="help-tab-content">
                            <div class="help-section-header">
                                <div class="help-section-icon"><iconify-icon icon="solar:tuning-2-bold"></iconify-icon>
                                </div>
                                <p>Ajustez l'affichage, les seuils d'évolution et le système de notation de
                                    l'application.
                                </p>
                            </div>
                            <div class="preferences-grid">
                                <!-- Mini-carte 1: Système périodique -->
                                <div class="preference-mini-card">
                                    <div class="preference-mini-card-header">
                                        <iconify-icon class="iconify-inline" icon="solar:calendar-bold"></iconify-icon>
                                        <span>Système périodique</span>
                                    </div>
                                    <div class="preference-mini-card-content">
                                        <div class="ui-segmented-control period-system-selector">
                                            <input type="radio" id="periodSystemTrimestres" name="periodSystemRadio"
                                                value="trimestres" checked>
                                            <label for="periodSystemTrimestres" class="ui-segment">Trimestres</label>
                                            <input type="radio" id="periodSystemSemestres" name="periodSystemRadio"
                                                value="semestres">
                                            <label for="periodSystemSemestres" class="ui-segment">Semestres</label>
                                        </div>
                                        <small class="preference-hint">T1, T2, T3 ou S1, S2</small>
                                    </div>
                                </div>

                                <!-- Mini-carte 2: Seuils d'évolution -->
                                <div class="preference-mini-card">
                                    <div class="preference-mini-card-header">
                                        <iconify-icon class="iconify-inline" icon="solar:chart-2-bold"></iconify-icon>
                                        <span>Seuils d'évolution</span>
                                    </div>
                                    <div class="preference-mini-card-content">
                                        <div class="evolution-thresholds-inline">
                                            <div class="threshold-item-compact tooltip"
                                                data-tooltip="Écart à partir duquel une hausse est significative">
                                                <label for="evolutionThresholdPositive" class="threshold-label">
                                                    <iconify-icon class="iconify-inline settings-evo-icon positive"
                                                        icon="solar:graph-up-bold"></iconify-icon>
                                                    <span>Progression</span>
                                                </label>
                                                <div class="number-input-wrapper">
                                                    <button type="button" class="number-spinner-btn decrement"
                                                        aria-label="Décrémenter"><iconify-icon class="iconify-inline"
                                                            icon="ph:minus-bold"></iconify-icon></button>
                                                    <input type="number" id="evolutionThresholdPositive" step="0.1"
                                                        min="0" value="0.5">
                                                    <button type="button" class="number-spinner-btn increment"
                                                        aria-label="Incrémenter"><iconify-icon
                                                            icon="ph:plus-bold"></iconify-icon></button>
                                                </div>
                                            </div>
                                            <div class="threshold-item-compact tooltip"
                                                data-tooltip="Écart à partir duquel une baisse est significative">
                                                <label for="evolutionThresholdNegative" class="threshold-label">
                                                    <iconify-icon class="iconify-inline settings-evo-icon negative"
                                                        icon="solar:graph-down-bold"></iconify-icon>
                                                    <span>Recul</span>
                                                </label>
                                                <div class="number-input-wrapper">
                                                    <button type="button" class="number-spinner-btn decrement"
                                                        aria-label="Décrémenter"><iconify-icon class="iconify-inline"
                                                            icon="ph:minus-bold"></iconify-icon></button>
                                                    <input type="number" id="evolutionThresholdNegative" step="0.1"
                                                        max="0" value="-0.5">
                                                    <button type="button" class="number-spinner-btn increment"
                                                        aria-label="Incrémenter"><iconify-icon
                                                            icon="ph:plus-bold"></iconify-icon></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="settings-privacy" class="help-tab-content">
                            <div class="help-section-header">
                                <div class="help-section-icon"><iconify-icon
                                        icon="solar:shield-user-bold"></iconify-icon></div>
                                <p>Paramètres de confidentialité et gestion de l'envoi de données vers l'IA.</p>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4 class="setting-subtitle">Anonymisation renforcée</h4>
                                    <div class="privacy-description-wrapper">
                                        <div class="privacy-option">
                                            <span class="option-label">Activé :</span>
                                            <span class="option-desc">Remplace le prénom par un placeholder.</span>
                                            <span class="privacy-warning-badge" title="Peut causer des répétitions">
                                                <iconify-icon icon="solar:danger-triangle-bold"></iconify-icon>
                                                Rédaction moins fluide
                                            </span>
                                        </div>
                                        <div class="privacy-option">
                                            <span class="option-label">Désactivé :</span>
                                            <span class="option-desc">Utilise le vrai prénom pour un texte plus
                                                naturel.</span>
                                        </div>
                                        <div class="privacy-footer-note">
                                            <iconify-icon class="iconify-inline"
                                                icon="solar:shield-check-bold"></iconify-icon> Le nom de famille n'est
                                            <strong>jamais</strong> transmis à l'IA.
                                        </div>
                                    </div>
                                </div>
                                <div class="toggle-switch-container">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="settingsPrivacyAnonymizeToggle" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div id="settings-data" class="help-tab-content">
                            <div class="help-section-header">
                                <div class="help-section-icon"><iconify-icon icon="solar:database-bold"></iconify-icon>
                                </div>
                                <p>Sauvegarde, restauration et synchronisation cloud de vos données.</p>
                            </div>
                            <!-- Section Sauvegarde Complète -->
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4 class="setting-subtitle"><iconify-icon
                                            icon="solar:cloud-download-bold"></iconify-icon> Sauvegarde
                                        complète</h4>
                                    <p class="setting-description">Exportez toutes vos données (élèves, appréciations,
                                        classes) pour les restaurer sur un autre appareil ou en cas de problème.</p>
                                </div>
                                <div class="setting-actions-group">
                                    <button class="btn btn-primary btn-small" id="exportFullBackupBtn">
                                        <iconify-icon icon="solar:download-minimalistic-bold"></iconify-icon> Exporter
                                    </button>
                                    <button class="btn btn-secondary btn-small" id="importFullBackupBtn">
                                        <iconify-icon class="iconify-inline" icon="solar:upload-bold"></iconify-icon>
                                        Restaurer
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="importBackupInput" accept=".json" style="display: none;">

                            <div class="settings-divider-light"></div>

                            <!-- Section Paramètres seuls -->
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4 class="setting-subtitle"><iconify-icon class="iconify-inline"
                                            icon="solar:tuning-2-bold"></iconify-icon> Paramètres uniquement
                                    </h4>
                                    <p class="setting-description">Exportez seulement la configuration (styles,
                                        matières) sans les données d'élèves.</p>
                                </div>
                                <div class="setting-actions-group">
                                    <button class="btn btn-secondary btn-small" id="exportSettingsBtn">
                                        <iconify-icon class="iconify-inline" icon="solar:export-bold"></iconify-icon>
                                        Exporter
                                    </button>
                                    <button class="btn btn-secondary btn-small" id="importSettingsBtn">
                                        <iconify-icon icon="solar:import-bold"></iconify-icon> Importer
                                    </button>
                                </div>
                            </div>

                            <div class="settings-divider-light"></div>

                            <!-- Section Cloud Save/Load -->
                            <div class="setting-row setting-row-column" id="cloudSyncSection">
                                <div class="setting-info setting-info-full">
                                    <h4 class="setting-subtitle"><iconify-icon class="iconify-inline"
                                            icon="solar:cloud-bold"></iconify-icon> Sauvegarde Cloud</h4>
                                    <p class="setting-description">
                                        Sauvegardez ou restaurez vos données via Google Drive.
                                    </p>
                                </div>

                                <!-- Provider Selection -->
                                <div class="sync-providers">
                                    <div class="sync-provider-card" data-provider="google">
                                        <div class="provider-icon"><iconify-icon class="iconify-inline"
                                                icon="logos:google-drive"></iconify-icon></div>
                                        <div class="provider-info">
                                            <span class="provider-name">Google Drive</span>
                                            <span class="provider-status" id="googleSyncStatus">Non connecté</span>
                                            <span class="provider-email" id="googleSyncEmail"
                                                style="display: none; font-size: 0.8em; color: var(--text-secondary);"></span>
                                        </div>
                                        <div class="provider-actions" style="display: flex; gap: 8px;">
                                            <button class="btn btn-secondary btn-small" id="connectGoogleBtn">
                                                Connecter
                                            </button>
                                            <button class="btn btn-danger btn-small" id="disconnectGoogleBtn"
                                                style="display: none;">
                                                <iconify-icon class="iconify-inline"
                                                    icon="solar:logout-bold"></iconify-icon>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sync-provider-card" data-provider="dropbox"
                                        style="opacity: 0.5; pointer-events: none;">
                                        <div class="provider-icon"><iconify-icon class="iconify-inline"
                                                icon="logos:dropbox"></iconify-icon></div>
                                        <div class="provider-info">
                                            <span class="provider-name">Dropbox</span>
                                            <span class="provider-status" id="dropboxSyncStatus">Bientôt
                                                disponible</span>
                                        </div>
                                        <button class="btn btn-secondary btn-small" id="connectDropboxBtn" disabled>
                                            Connecter
                                        </button>
                                    </div>
                                </div>

                                <!-- Save/Load Actions (visible when connected) -->
                                <div class="cloud-actions-bar" id="cloudActionsBar" style="display: none;">
                                    <button class="btn btn-primary btn-small" id="cloudSaveBtn">
                                        <iconify-icon icon="solar:cloud-upload-bold"></iconify-icon> Sauvegarder
                                    </button>
                                    <button class="btn btn-secondary btn-small" id="cloudLoadBtn">
                                        <iconify-icon icon="solar:cloud-download-bold"></iconify-icon> Charger
                                    </button>
                                    <span class="cloud-last-save" id="cloudLastSave"></span>
                                </div>

                                <!-- RGPD Warning (always visible) -->
                                <div class="sync-rgpd-warning" id="syncRgpdWarning">
                                    <iconify-icon class="iconify-inline" icon="solar:shield-check-bold"></iconify-icon>
                                    <span>En activant la sauvegarde cloud, vos données seront stockées sur le service
                                        choisi. Vous êtes responsable du respect des réglementations applicables
                                        (RGPD).</span>
                                </div>
                            </div>

                            <div class="settings-divider"></div>

                            <!-- Section Application Update -->
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4 class="setting-subtitle"><iconify-icon icon="solar:restart-bold"></iconify-icon>
                                        Mises à jour</h4>
                                    <p class="setting-description">Vérifiez si une nouvelle version de l'application est
                                        disponible.</p>
                                </div>
                                <div class="setting-actions-group">
                                    <button class="btn btn-secondary btn-small" id="checkUpdatesDataBtn">
                                        <iconify-icon class="iconify-inline" icon="solar:restart-bold"></iconify-icon>
                                        Vérifier
                                    </button>
                                </div>
                            </div>

                            <div class="settings-divider"></div>

                            <!-- Section Zone de Danger -->
                            <div class="danger-zone-details">
                                <details class="ui-accordion danger-accordion">
                                    <summary><iconify-icon icon="solar:danger-triangle-bold"></iconify-icon> Zone de
                                        Danger</summary>
                                    <div class="ui-accordion-content">
                                        <div class="ui-accordion-content-inner">
                                            <div class="danger-action-row">
                                                <div class="danger-info">
                                                    <strong>Réinitialiser les paramètres</strong>
                                                    <span>Remet les paramètres par défaut (clés API, matières). Vos
                                                        classes et élèves sont conservés.</span>
                                                </div>
                                                <button class="btn btn-secondary btn-small" id="resetAllSettingsBtn">
                                                    Réinitialiser
                                                </button>
                                            </div>
                                            <div class="danger-action-row" style="margin-top: 12px;">
                                                <div class="danger-info">
                                                    <strong style="color: var(--error-color);">Supprimer toutes les
                                                        données</strong>
                                                    <span>Efface TOUT : classes, élèves, appréciations, paramètres.
                                                        Irréversible.</span>
                                                </div>
                                                <button class="btn btn-danger btn-small" id="factoryResetBtn">
                                                    Tout supprimer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div> <!-- /ui-tabs-content -->
                </div> <!-- /ui-tabs-vertical -->
            </div> <!-- /modal-body-flex -->

            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSettingsBtn" tabindex="0">Annuler</button>
                <button class="btn btn-primary" id="saveSettingsBtn" tabindex="0">
                    <iconify-icon icon="ph:check-bold"></iconify-icon> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <div id="importPreviewModal" class="modal" role="dialog" aria-modal="true"
        aria-labelledby="importPreviewModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="importPreviewModalTitle"><iconify-icon class="iconify-inline color-success"
                        icon="solar:list-check-bold"></iconify-icon> Configurer
                    et
                    prévisualiser l'import</h2>
                <button class="close-button" id="closeImportPreviewModalBtn"
                    aria-label="Fermer la prévisualisation"><iconify-icon class="iconify-inline"
                        icon="ph:x"></iconify-icon></button>
            </div>
            <div class="modal-body">

                <div id="import-summary-text" class="generic-info-box"></div>
                <div id="importSavedFormatInfo" class="generic-info-box"
                    style="display: none; justify-content: space-between; align-items: center;">
                </div>

                <details class="ui-accordion" style="margin-bottom: 25px;">
                    <summary><iconify-icon class="iconify-inline" icon="solar:settings-bold"></iconify-icon> Ajuster le
                        mappage des colonnes</summary>
                    <div class="ui-accordion-content">
                        <div class="ui-accordion-content-inner">
                            <p style="margin-top:0; font-size:0.9em; color:var(--summary-details-color);">
                                Vérifiez que
                                chaque colonne de vos données est correctement associée à un
                                champ.
                                L'application essaie
                                de deviner le format, mais vous pouvez l'ajuster ici.</p>
                            <div class="form-group-inline" style="margin-bottom: 20px;">
                                <label for="separatorSelect" style="margin-bottom: 0;">Séparateur&nbsp;:</label>
                                <select id="separatorSelect">
                                    <option value="tab">Tabulation</option>
                                    <option value=",">Virgule (,)</option>
                                    <option value=";">Point-virgule (;)</option>
                                    <option value="|">Barre verticale (|)</option>
                                    <option value="custom">Autre...</option>
                                </select>
                                <input type="text" id="customSeparatorInput" style="display: none; width: 80px;"
                                    maxlength="1" placeholder="Caractère">
                            </div>

                            <div class="mapping-table-container" style="overflow-x: auto;">
                                <table class="mapping-preview-table">
                                    <thead id="mappingHeaders"></thead>
                                    <tbody id="mappingPreviewData"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </details>

                <div id="import-strategy-container" class="import-strategy-container"
                    style="display: none; margin-bottom: 25px;">
                    <div class="ui-segmented-control compact">
                        <input type="radio" id="strategyMerge" name="importStrategy" value="merge" checked>
                        <label for="strategyMerge" class="ui-segment tooltip"
                            data-tooltip="Ajoute les nouveaux, met à jour les existants et marque les absents. Recommandé.">Mettre
                            à jour (Fusionner)</label>
                        <input type="radio" id="strategyReplace" name="importStrategy" value="replace">
                        <label for="strategyReplace" class="ui-segment tooltip"
                            data-tooltip="Supprime tous les élèves actuels et les remplace par ceux de cet import.">Remplacer
                            toute la liste</label>
                    </div>
                </div>

                <div id="import-preview-container">
                    <div class="import-preview-grid">
                        <div id="import-preview-new-col" class="import-preview-column import-preview-new">
                            <div class="column-header">
                                <h4><iconify-icon class="iconify-inline" icon="solar:user-plus-bold"></iconify-icon>
                                    Nouveaux <span id="new-count" class="ui-badge ui-badge-primary">0</span></h4>
                            </div>
                            <ul id="new-students-list" class="import-preview-list"></ul>
                        </div>
                        <div id="import-preview-updated-col" class="import-preview-column import-preview-updated">
                            <div class="column-header">
                                <h4><iconify-icon class="iconify-inline" icon="solar:user-id-bold"></iconify-icon> Mis à
                                    jour <span id="updated-count" class="ui-badge ui-badge-primary">0</span></h4>
                            </div>
                            <ul id="updated-students-list" class="import-preview-list"></ul>
                        </div>
                        <div id="import-preview-departed-col" class="import-preview-column import-preview-departed">
                            <div class="column-header">
                                <h4><iconify-icon class="iconify-inline" icon="solar:user-minus-bold"></iconify-icon>
                                    Départs <span id="departed-count" class="ui-badge ui-badge-danger">0</span></h4>
                            </div>
                            <ul id="departed-students-list" class="import-preview-list">
                            </ul>
                        </div>
                    </div>
                    <div id="import-preview-replace-warning" class="api-key-warning"
                        style="display: none; border-color: var(--error-color); background-color: rgba(239, 68, 68, 0.08);">
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <div class="form-group-inline" style="margin-right: auto;">
                    <input type="checkbox" id="saveMappingCheckbox" style="width: auto;">
                    <label for="saveMappingCheckbox" style="margin-bottom: 0; font-size: 0.9em;">Mémoriser
                        ce
                        format de
                        colonnes</label>
                </div>
                <button class="btn btn-secondary" id="cancelImportPreviewBtn">Annuler</button>
                <button class="btn btn-primary" id="importOnlyBtn">
                    <iconify-icon icon="solar:download-minimalistic-bold"></iconify-icon>
                    Importer les données
                </button>
            </div>
        </div>
    </div>



    <!-- Refinement Modal removed - Focus Panel handles all refinement with inline buttons -->

    <div id="helpModal" class="modal modal-help" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="modal-title-icon color-primary"><iconify-icon class="iconify-inline"
                            icon="solar:question-circle-bold"></iconify-icon></span>
                    <span class="modal-title-text">Guide de l'application</span>
                </h2>
                <button class="close-button" id="closeHelpModalBtn" aria-label="Fermer l'aide"><iconify-icon
                        class="iconify-inline" icon="ph:x"></iconify-icon></button>
            </div>
            <div class="modal-body modal-body-flex">
                <div class="ui-tabs-vertical">
                    <!-- Sidebar Navigation -->
                    <div class="ui-tabs-sidebar">
                        <button class="ui-tabs-btn active" onclick="switchHelpTab(this, 'help-apikey')">
                            <iconify-icon class="iconify-inline icon-key" icon="solar:key-square-bold"></iconify-icon>
                            Connecter l'IA
                        </button>
                        <button class="ui-tabs-btn" onclick="switchHelpTab(this, 'help-import')">
                            <iconify-icon class="iconify-inline icon-format" icon="solar:import-bold"></iconify-icon>
                            Importer
                        </button>
                        <button class="ui-tabs-btn" onclick="switchHelpTab(this, 'help-style')">
                            <iconify-icon class="iconify-inline icon-customize"
                                icon="solar:tuning-2-bold"></iconify-icon> Personnaliser
                        </button>
                        <button class="ui-tabs-btn" onclick="switchHelpTab(this, 'help-actions')">
                            <iconify-icon class="iconify-inline icon-actions"
                                icon="solar:magic-stick-3-bold"></iconify-icon> Commandes IA
                        </button>
                        <button class="ui-tabs-btn" onclick="switchHelpTab(this, 'help-privacy')">
                            <iconify-icon class="iconify-inline icon-privacy" icon="solar:shield-bold"></iconify-icon>
                            Confidentialité
                        </button>
                        <button class="ui-tabs-btn" onclick="switchHelpTab(this, 'help-about')">
                            <iconify-icon class="iconify-inline icon-about"
                                icon="solar:info-circle-bold"></iconify-icon> À propos
                        </button>

                        <!-- Bottom Action Button -->
                        <div style="margin-top: auto; padding-top: 10px; width: 100%;">
                            <button class="ui-tabs-action-btn" onclick="relaunchSetupWizard()">
                                <iconify-icon class="iconify-inline" icon="solar:restart-bold"></iconify-icon> Relancer
                                setup
                            </button>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="ui-tabs-content">
                        <!-- Tab 1: Connecter l'IA -->
                        <!-- Tab 1: Connecter l'IA -->
                        <div id="help-apikey" class="help-tab-content active">
                            <div class="help-section-header">
                                <div class="help-section-icon">
                                    <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
                                </div>
                                <p>
                                    L'application a besoin d'un "cerveau" IA. Choisissez
                                    votre fournisseur pour voir la
                                    marche à suivre.
                                </p>
                            </div>

                            <div class="help-step-card">
                                <div class="help-step-layout">
                                    <div class="help-step-number">1</div>
                                    <div class="help-step-body">
                                        <strong>Choisir votre fournisseur</strong>
                                        <div class="help-provider-hero">
                                            <div class="ui-segmented-control compact has-glider"
                                                id="helpProviderSelector">
                                                <input type="radio" id="helpProviderMistral" name="helpProvider"
                                                    value="mistral" checked>
                                                <label for="helpProviderMistral" class="ui-segment">
                                                    <iconify-icon class="iconify-inline" icon="solar:cat-bold"
                                                        style="color: #fd6f00;"></iconify-icon>
                                                    <span>Mistral <small class="provider-tag">🇫🇷</small></span>
                                                </label>
                                                <input type="radio" id="helpProviderGoogle" name="helpProvider"
                                                    value="google">
                                                <label for="helpProviderGoogle" class="ui-segment">
                                                    <iconify-icon class="iconify-inline"
                                                        icon="logos:google-icon"></iconify-icon>
                                                    <span>Google</span>
                                                </label>
                                                <input type="radio" id="helpProviderOpenRouter" name="helpProvider"
                                                    value="openrouter">
                                                <label for="helpProviderOpenRouter" class="ui-segment">
                                                    <iconify-icon class="iconify-inline"
                                                        icon="solar:bolt-bold-duotone"></iconify-icon>
                                                    <span>OpenRouter</span>
                                                </label>
                                                <div class="ui-glider"></div>
                                            </div>
                                            <p class="provider-desc" id="helpProviderDesc">
                                                <strong>Mistral AI</strong>
                                                est une solution française, performante et
                                                <strong>gratuite</strong> (1
                                                milliard de tokens/mois).
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- MISTRAL CONTENT (Default) -->
                            <div id="helpContentMistral" class="provider-help-content">

                                <div class="help-step-card">
                                    <div class="help-step-layout">
                                        <div class="help-step-number">2</div>
                                        <div class="help-step-body">
                                            <strong>Récupérer votre clé (Gratuit)</strong>
                                            <p>Créez un compte sur
                                                Mistral AI et générez votre clé API.</p>
                                            <a href="https://console.mistral.ai/api-keys/" target="_blank"
                                                rel="noopener noreferrer" class="btn btn-secondary btn-small">
                                                <iconify-icon class="iconify-inline"
                                                    icon="solar:link-circle-bold"></iconify-icon>
                                                Ouvrir
                                                Mistral Console
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="help-step-card">
                                    <div class="help-step-layout">
                                        <div class="help-step-number">3</div>
                                        <div class="help-step-body">
                                            <strong>Copier / Coller</strong>
                                            <p>
                                                Copiez la clé générée et collez-la dans les
                                                <a href="#" class="link-to-settings btn-link" data-target-tab="advanced"
                                                    data-target-element="mistralApiKey">Paramètres</a>.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- GOOGLE CONTENT -->
                            <div id="helpContentGoogle" class="provider-help-content" style="display: none;">

                                <div class="help-step-card">
                                    <div class="help-step-layout">
                                        <div class="help-step-number">2</div>
                                        <div class="help-step-body">
                                            <strong>Créer une clé API</strong>
                                            <p>Connectez-vous avec votre
                                                compte Google et cliquez sur "Create API
                                                key".</p>
                                            <a href="https://aistudio.google.com/app/apikey" target="_blank"
                                                rel="noopener noreferrer" class="btn btn-secondary btn-small">
                                                <iconify-icon class="iconify-inline"
                                                    icon="solar:link-circle-bold"></iconify-icon>
                                                Ouvrir
                                                Google AI Studio
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="help-step-card">
                                    <div class="help-step-layout">
                                        <div class="help-step-number">3</div>
                                        <div class="help-step-body">
                                            <strong>Copier / Coller</strong>
                                            <p>
                                                Copiez la clé et collez-la dans les <a href="#"
                                                    class="link-to-settings btn-link" data-target-tab="advanced"
                                                    data-target-element="googleApiKey">Paramètres</a>
                                                section Google.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- OPENROUTER CONTENT -->
                            <div id="helpContentOpenRouter" class="provider-help-content" style="display: none;">


                                <div class="help-step-card">
                                    <div class="help-step-layout">
                                        <div class="help-step-number">2</div>
                                        <div class="help-step-body">
                                            <strong>Obtenir une clé</strong>
                                            <a href="https://openrouter.ai/keys" target="_blank"
                                                rel="noopener noreferrer" class="btn btn-secondary btn-small">
                                                <iconify-icon class="iconify-inline"
                                                    icon="solar:link-circle-bold"></iconify-icon>
                                                Site
                                                OpenRouter
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="help-step-card">
                                    <div class="help-step-layout">
                                        <div class="help-step-number">3</div>
                                        <div class="help-step-body">
                                            <strong>Configurer</strong>
                                            <p>
                                                Collez la clé dans les <a href="#" class="link-to-settings btn-link"
                                                    data-target-tab="advanced"
                                                    data-target-element="openrouterApiKey">Paramètres</a>
                                                section
                                                OpenRouter.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Common Footer -->
                            <div class="help-tip-box">
                                <iconify-icon class="iconify-inline" icon="solar:restart-bold"></iconify-icon>
                                <span><strong>Relais automatique :</strong> Si le modèle
                                    échoue, l'app peut basculer
                                    vers un autre. Activable dans les <a href="#" class="link-to-settings btn-link"
                                        data-target-tab="advanced">Paramètres
                                        avancés</a>.</span>
                            </div>
                        </div>

                        <!-- Tab 2: Importer -->
                        <div id="help-import" class="help-tab-content">
                            <div class="help-section-header">
                                <div class="help-section-icon">
                                    <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
                                </div>
                                <p>
                                    Importez vos classes depuis Excel, Pronote, un PDF ou
                                    tout autre document.
                                </p>
                            </div>

                            <div class="help-step-card">
                                <div class="help-step-layout">
                                    <div class="help-step-number">1</div>
                                    <div class="help-step-body">
                                        <strong>Choisir la méthode</strong>
                                        <ul
                                            style="margin: 8px 0 0 0; padding-left: 20px; color: var(--text-secondary);">
                                            <li style="margin-bottom: 6px;">
                                                <strong style="color: var(--text-primary);">Mode
                                                    Unitaire :</strong>
                                                Saisie manuelle (un élève à la fois).
                                            </li>
                                            <li>
                                                <strong style="color: var(--text-primary);">Import
                                                    en Masse :</strong>
                                                Copiez-collez ou glissez votre fichier.
                                                <span
                                                    style="font-size: 0.85em; background: rgba(var(--success-color-rgb), 0.1); color: var(--success-color); padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 4px;">Recommandé</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="help-step-card">
                                <div class="help-step-layout">
                                    <div class="help-step-number">2</div>
                                    <div class="help-step-body">
                                        <strong>Format idéal</strong>
                                        <p>L'application détecte automatiquement les
                                            colonnes. Copiez simplement votre
                                            tableau (y compris les en-têtes).</p>

                                        <div
                                            style="background: var(--card-glass-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--card-glass-border); margin-top: 10px; font-size: 0.85em; font-family: monospace; color: var(--text-secondary);">
                                            Nom | Prénom | Moyenne | Appréciation
                                            (optionnel)
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="help-tip-box">
                                <iconify-icon class="iconify-inline" icon="solar:lightbulb-bolt-bold"></iconify-icon>
                                <span>Après le collage, vous pourrez vérifier et ajuster le
                                    "mappage" des colonnes avant
                                    de valider.</span>
                            </div>
                        </div>

                        <!-- Tab 3: Style -->
                        <div id="help-style" class="help-tab-content">
                            <div class="help-section-header">
                                <div class="help-section-icon">
                                    <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
                                </div>
                                <p>
                                    L'IA s'adapte à votre style d'écriture. Définissez vos
                                    préférences dans les
                                    Paramètres.
                                </p>
                            </div>

                            <div class="help-step-card">
                                <div class="help-step-layout">
                                    <div class="help-step-number">1</div>
                                    <div class="help-step-body">
                                        <strong>Ton et Longueur</strong>
                                        <p>Choisissez un ton (Strict, Encourageant...) et la
                                            longueur souhaitée (Concis,
                                            Détaillé) pour vos appréciations.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="help-step-card">
                                <div class="help-step-layout">
                                    <div class="help-step-number">2</div>
                                    <div class="help-step-body">
                                        <strong>"Ma Patte" (Instructions
                                            personnalisées)</strong>
                                        <p>Donnez des consignes précises à l'IA pour qu'elle
                                            imite votre style.</p>
                                        <div
                                            style="margin-top: 8px; padding: 8px 12px; background: rgba(0,0,0,0.03); border-radius: 6px; font-style: italic; font-size: 0.85em; color: var(--text-secondary); border-left: 3px solid #a855f7;">
                                            "Ne jamais utiliser le mot 'bavard', toujours
                                            mentionner l'effort fourni."
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="help-step-card">
                                <div class="help-step-layout">
                                    <div class="help-step-number">3</div>
                                    <div class="help-step-body">
                                        <strong>Prévisualisation en direct</strong>
                                        <p>
                                            Utilisez le bouton <strong><iconify-icon class="iconify-inline"
                                                    icon="solar:test-tube-linear"></iconify-icon>
                                                Aperçu</strong> dans
                                            les
                                            paramètres pour tester vos réglages
                                            instantanément.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-secondary help-action-button" id="helpToPersonalizationBtn"
                                style="width: 100%; justify-content: center; margin-top: 10px;">
                                <iconify-icon class="iconify-inline" icon="solar:tuning-2-bold"></iconify-icon> Accéder
                                à la personnalisation
                            </button>
                        </div>

                        <!-- Tab: Actions IA (New) -->
                        <div id="help-actions" class="help-tab-content">
                            <div class="help-section-header">
                                <div class="help-section-icon">
                                    <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
                                </div>
                                <p>
                                    Comprendre les commandes de raffinement envoyées à l'IA.
                                </p>
                            </div>

                            <div class="ui-table-container">
                                <table class="ui-table responsive-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 140px;">Bouton</th>
                                            <th style="width: 120px;">Action</th>
                                            <th>Prompt Système</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <button class="btn btn-ai-outline btn-tiny"
                                                    style="pointer-events: none;">
                                                    <iconify-icon icon="solar:minimize-square-linear"></iconify-icon>
                                                    Concise
                                                </button>
                                            </td>
                                            <td style="font-weight: 500; color: var(--text-primary);">
                                                Réduire (~20%)
                                            </td>
                                            <td class="prompt-cell">"Rends cette
                                                appréciation plus concise. Garde
                                                l'essentiel."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <button class="btn btn-ai-outline btn-tiny"
                                                    style="pointer-events: none;">
                                                    <iconify-icon icon="solar:maximize-square-linear"></iconify-icon>
                                                    Détaillée
                                                </button>
                                            </td>
                                            <td style="font-weight: 500; color: var(--text-primary);">
                                                Développer (~20%)
                                            </td>
                                            <td class="prompt-cell">"Développe les points,
                                                sois plus précis. N'invente
                                                pas
                                                de faits."</td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <button class="btn btn-ai-outline btn-tiny"
                                                    style="pointer-events: none;">
                                                    <iconify-icon icon="solar:heart-linear"></iconify-icon>
                                                    Encourageante
                                                </button>
                                            </td>
                                            <td style="font-weight: 500; color: var(--text-primary);">
                                                Ton positif</td>
                                            <td class="prompt-cell">"Reformule avec un ton
                                                plus encourageant et
                                                positif."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <button class="btn btn-ai-outline btn-tiny"
                                                    style="pointer-events: none;">
                                                    <iconify-icon icon="solar:restart-linear"></iconify-icon>
                                                    Variation
                                                </button>
                                            </td>
                                            <td style="font-weight: 500; color: var(--text-primary);">
                                                Reformuler</td>
                                            <td class="prompt-cell">"Reformule différemment
                                                (vocabulaire, structure)
                                                mais
                                                garde le même sens."</td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <button class="btn btn-ai-outline btn-tiny"
                                                    style="pointer-events: none;">
                                                    <span class="polish-icon-wrapper">
                                                        <iconify-icon icon="solar:magic-stick-3-linear"
                                                            class="polish-wand"></iconify-icon>
                                                        <span class="polish-sparkle s1">✦</span>
                                                        <span class="polish-sparkle s2">✦</span>
                                                        <span class="polish-sparkle s3">✧</span>
                                                    </span>
                                                    Peaufiner
                                                </button>
                                            </td>
                                            <td style="font-weight: 500; color: var(--text-primary);">
                                                Correction Pro
                                            </td>
                                            <td class="prompt-cell">"Peaufine : corrige
                                                fautes, améliore fluidité,
                                                adopte un
                                                ton pro."</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="help-tip-box" style="margin-top: 15px;">
                                <iconify-icon class="iconify-inline" icon="solar:eye-bold"></iconify-icon>
                                <span><strong>Astuce :</strong> Faites un <strong>Clic
                                        Droit</strong> sur le bouton
                                    <em>Générer</em> pour voir le prompt complet envoyé à
                                    l'IA avant qu'il ne
                                    parte.</span>
                            </div>
                        </div>

                        <!-- Tab 4: Confidentialité -->
                        <div id="help-privacy" class="help-tab-content">
                            <div class="help-section-header">
                                <div class="help-section-icon">
                                    <iconify-icon icon="solar:info-circle-linear"></iconify-icon>
                                </div>
                                <p>
                                    Vos données, votre contrôle. Bulletin AI est conçu selon
                                    le principe "Local-First".
                                </p>
                            </div>

                            <div class="help-step-card">
                                <div class="help-step-layout">
                                    <div class="help-step-number safety-icon"><iconify-icon
                                            icon="solar:lock-keyhole-bold"></iconify-icon>
                                    </div>
                                    <div class="help-step-body">
                                        <strong>Stockage Local</strong>
                                        <p>Toutes vos données (élèves, notes, appréciations)
                                            sont stockées
                                            <strong>uniquement sur votre ordinateur</strong>
                                            (dans le navigateur). Rien
                                            n'est sauvegardé sur nos serveurs.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="help-step-card">
                                <div class="help-step-layout">
                                    <div class="help-step-number safety-icon"><iconify-icon
                                            icon="solar:incognito-bold"></iconify-icon>
                                    </div>
                                    <div class="help-step-body">
                                        <strong>Anonymisation</strong>
                                        <p>
                                            Avant d'être envoyées à l'IA pour génération,
                                            les données sont anonymisées.
                                            Les noms de famille sont supprimés. Seul le
                                            prénom et les notes sont
                                            transmis.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="help-tip-box"
                                style="border-color: rgba(16, 185, 129, 0.2); background: rgba(16, 185, 129, 0.05);">
                                <iconify-icon class="iconify-inline" icon="solar:check-circle-bold"
                                    style="color: #10b981;"></iconify-icon>
                                <span>Le code source de l'application est ouvert et
                                    auditable, garantissant une
                                    transparence totale sur le traitement des
                                    données.</span>
                            </div>
                        </div>

                        <!-- Tab 5: À propos -->
                        <div id="help-about" class="help-tab-content">
                            <div class="about-header">
                                <div class="about-header-main">
                                    <img src="assets/logo.png" alt="Bulletin AI" class="about-logo">
                                    <div class="about-title-group">
                                        <h3>Bulletin AI</h3>
                                        <div class="about-version">v0.1.0 Beta</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <a id="linkGithub" href="#" target="_blank" rel="noopener noreferrer"
                                        class="btn btn-secondary btn-small">
                                        <iconify-icon class="iconify-inline" icon="logos:github-icon"></iconify-icon>
                                        GitHub
                                    </a>
                                    <a id="linkFeedback" href="#" target="_blank" rel="noopener noreferrer"
                                        class="btn btn-secondary btn-small">
                                        <iconify-icon icon="solar:chat-line-bold"></iconify-icon> Avis
                                    </a>
                                </div>
                            </div>

                            <div class="about-content">


                                <!-- Donation Section (Refined) -->
                                <div class="support-card-premium">
                                    <h4>
                                        <iconify-icon class="iconify-inline" icon="solar:heart-bold"
                                            style="color: #FF5E5B;"></iconify-icon> Soutenir
                                        le projet
                                    </h4>
                                    <p>
                                        Cette application est gratuite. Si elle vous est
                                        utile, vous pouvez encourager
                                        son
                                        développement en m'offrant un café !
                                    </p>
                                    <a id="linkKofi" href="#" target="_blank" rel="noopener noreferrer"
                                        class="btn btn-kofi">
                                        <iconify-icon class="iconify-inline" icon="solar:cup-hot-bold"></iconify-icon>
                                        Soutenir sur Ko-fi
                                    </a>
                                </div>

                                <div class="about-footer">
                                    <p>Développé pour les enseignants par David Trafial</p>
                                    <p>© 2025 Bulletin AI - Tous droits réservés</p>
                                    <p style="margin-top: 5px; font-size: 0.9em; opacity: 0.7;">
                                        Sous licence <a id="linkLicense" href="#" target="_blank"
                                            style="color: inherit; text-decoration: underline;">Creative
                                            Commons
                                            BY-NC-SA 4.0</a></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeHelpModalFooterBtn" tabindex="0">Fermer</button>
            </div>
        </div>
    </div>


    <div id="welcomeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="welcomeModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="welcomeModalTitle">🎉 Bienvenue dans Bulletin AI
                    !</h2>
                <button class="close-button" id="closeWelcomeModalBtn" aria-label="Fermer">
                    <iconify-icon icon="ph:x"></iconify-icon>
                </button>
            </div>
            <div class="modal-body">
                <div id="welcome-step-1" class="welcome-step active">
                    <div class="welcome-icon">🚀</div>
                    <h3>Gagnez du temps sur vos bulletins</h3>


                    <div class="welcome-features-list">
                        <div class="welcome-feature">
                            <span class="feature-icon">✨</span>
                            <span class="feature-text"><strong>Unique &
                                    Varié</strong><br>Plus de
                                répétitions
                                robotiques.</span>
                        </div>
                        <div class="welcome-feature">
                            <span class="feature-icon">⚡</span>
                            <span class="feature-text"><strong>Ultra Rapide</strong><br>Une
                                classe
                                entière en quelques
                                minutes.</span>
                        </div>
                        <div class="welcome-feature">
                            <span class="feature-icon">🔒</span>
                            <span class="feature-text"><strong>Privé &
                                    Sécurisé</strong><br>Vos données
                                restent sous
                                contrôle.</span>
                        </div>
                    </div>

                    <p style="margin-top: 25px; font-size: 0.9em; color: var(--text-secondary); opacity: 0.8;">
                        Commençons par configurer votre environnement.
                    </p>
                </div>
                <div id="welcome-step-2" class="welcome-step">


                    <div class="welcome-split-layout">
                        <!-- Left Column: Context & Info -->
                        <div class="welcome-split-info">
                            <div class="welcome-header-row">
                                <span class="welcome-icon-small wave-animation">🔑</span>
                                <h3>Activez votre Assistant</h3>
                            </div>
                            <p class="welcome-subtitle-left">
                                L'application a besoin d'une connexion IA.<br>
                                Chaque option propose un accès gratuit.
                            </p>

                            <div class="security-note-left">
                                <iconify-icon class="iconify-inline" icon="solar:shield-check-bold"></iconify-icon>
                                <span>Noms anonymisés • Stockage local</span>
                            </div>
                        </div>

                        <!-- Right Column: Actions -->
                        <div class="welcome-split-action">

                            <!-- Provider Selector - Centré -->
                            <div class="provider-selector-row">
                                <div class="ui-segmented-control compact" id="welcomeProviderSelector">
                                    <input type="radio" id="providerMistral" name="welcomeProvider" value="mistral"
                                        checked>
                                    <label for="providerMistral" class="ui-segment">
                                        <iconify-icon class="iconify-inline" icon="solar:cat-bold"
                                            style="color: #fd6f00;"></iconify-icon>
                                        <span>Mistral <small class="provider-tag">🇫🇷</small></span>
                                    </label>
                                    <input type="radio" id="providerGoogle" name="welcomeProvider" value="google">
                                    <label for="providerGoogle" class="ui-segment">
                                        <iconify-icon class="iconify-inline" icon="logos:google-icon"></iconify-icon>
                                        <span>Google</span>
                                    </label>
                                    <input type="radio" id="providerOpenRouter" name="welcomeProvider"
                                        value="openrouter">
                                    <label for="providerOpenRouter" class="ui-segment">
                                        <iconify-icon class="iconify-inline"
                                            icon="solar:bolt-bold-duotone"></iconify-icon>
                                        <span>OpenRouter</span>
                                    </label>
                                </div>
                            </div>

                            <!-- API Key Input -->
                            <div class="welcome-api-key-group">
                                <input type="password" id="welcomeApiKeyInput"
                                    placeholder="Collez votre clé API Mistral ici...">
                                <button class="btn btn-validate-key" id="welcomeValidateApiKeyBtn">Valider</button>
                            </div>
                            <div class="error-message" id="welcomeApiKeyError"
                                style="display: none; justify-content: flex-start; margin-bottom: 10px; font-size: 0.9em;">
                            </div>

                            <!-- Action Links Row -->
                            <div class="welcome-action-links">
                                <a href="https://console.mistral.ai/api-keys/" target="_blank" rel="noopener noreferrer"
                                    class="get-key-link-mini" id="welcomeGetKeyLink"><iconify-icon
                                        class="iconify-inline" icon="solar:cat-bold"
                                        style="color: #fd6f00;"></iconify-icon> Obtenir
                                    ma clé</a>
                                <span class="action-separator">•</span>
                                <button class="btn-text-link-compact" id="welcomeSkipApiKeyBtn">
                                    Continuer sans clé
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="welcome-step-3" class="welcome-step">
                    <div class="welcome-icon-small" style="text-align: center; margin-bottom: 15px;">🗓️
                    </div>
                    <h3>Votre rythme scolaire</h3>
                    <p class="welcome-subtitle">Ce paramètre calibre l'IA pour qu'elle
                        s'adapte à votre
                        organisation.
                    </p>

                    <div class="period-card-selector">
                        <label class="period-card" for="welcomePeriodSystemTrimestres">
                            <input type="radio" id="welcomePeriodSystemTrimestres" name="welcomePeriodSystemRadio"
                                value="trimestres" checked>
                            <div class="period-card-content">
                                <div class="period-card-icon">
                                    <iconify-icon icon="solar:chart-2-bold"></iconify-icon>
                                </div>
                                <div class="period-card-text">
                                    <span class="period-card-title">Trimestres</span>
                                    <span class="period-card-desc">3 périodes par an
                                        (Automne, Hiver,
                                        Printemps)</span>
                                </div>
                            </div>
                        </label>
                        <label class="period-card" for="welcomePeriodSystemSemestres">
                            <input type="radio" id="welcomePeriodSystemSemestres" name="welcomePeriodSystemRadio"
                                value="semestres">
                            <div class="period-card-content">
                                <div class="period-card-icon">
                                    <iconify-icon class="iconify-inline" icon="solar:pie-chart-2-bold"></iconify-icon>
                                </div>
                                <div class="period-card-text">
                                    <span class="period-card-title">Semestres</span>
                                    <span class="period-card-desc">2 périodes par an
                                        (Automne,
                                        Printemps)</span>
                                </div>
                            </div>
                        </label>
                    </div>

                    <p class="welcome-hint">Vous pourrez modifier ce paramètre à tout moment
                        dans les
                        réglages.</p>
                </div>
                <div id="welcome-step-4" class="welcome-step">
                    <!-- Illustration Area -->
                    <!-- Transformation Illustration -->
                    <div class="welcome-transformation-svg">
                        <object type="image/svg+xml" data="./welcome-transformation.svg">
                            Illustration de transformation IA
                        </object>
                    </div>


                    <h3>Prêt à commencer !</h3>
                    <p class="welcome-subtitle">Tout est configuré. Voyez l'IA en action sur
                        des données
                        d'exemple.</p>

                    <button class="btn btn-organic btn-organic--rounded btn-cta-full" id="welcomeLoadSampleBtn">
                        <iconify-icon class="iconify-inline" icon="solar:magic-stick-3-bold"></iconify-icon>
                        Charger et Générer un exemple
                    </button>

                    <div id="welcome-next-step-info">Parfait ! Les données sont prêtes.
                        Cliquez sur
                        "Terminer" pour voir
                        les résultats.</div>
                </div>
            </div>
            <div class="welcome-nav-container">
                <button class="btn btn-secondary" id="welcomePrevBtn" style="visibility: hidden;">Précédent</button>
                <div id="welcome-dots"><span class="dot active"></span><span class="dot"></span><span
                        class="dot"></span><span class="dot"></span></div>
                <button class="btn" id="welcomeNextBtn">Suivant</button>
                <div id="welcome-finish-options">
                    <button class="btn btn-secondary" id="welcomeFinishBtn">Terminer</button>
                    <button class="btn" id="welcomeFinishAndHideBtn">Terminer et ne plus
                        afficher</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json,.csv,.txt" style="display: none;">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Génération en cours...</div>
    </div>

    <button id="backToTopBtn" class="icon-button tooltip" data-tooltip="Retour en haut"
        aria-label="Retour en haut de la page">↑</button>

    <!-- TEMPLATES -->
    <template id="student-result-template">
        <div class="appreciation-result" tabindex="0">
            <div class="card-content-wrapper">
                <div class="student-name-container" role="button" data-action="details">
                    <div class="student-name">
                        <span data-template="name"></span>
                    </div>
                    <div data-template="grades" class="student-grades-display"></div>
                    <span class="details-on-hover-label"><iconify-icon class="iconify-inline"
                            icon="solar:chart-2-bold"></iconify-icon>
                        Analyser</span>
                </div>
                <div class="appreciation-text-container" role="button" data-action="refine">
                    <p data-template="appreciation" class="appreciation-text"></p>
                    <span class="refine-on-hover-label"><iconify-icon icon="solar:magic-stick-3-bold"></iconify-icon>
                        Raffinement</span>
                </div>
                <div class="card-footer">
                    <div class="student-summary-details">
                        <span data-template="subject" class="detail-chip tooltip"></span>
                        <span data-template="wordCount" class="detail-chip tooltip"
                            data-tooltip="Nombre de mots"></span>
                    </div>
                    <div class="appreciation-actions">
                        <button class="icon-action-btn toggle-version-btn tooltip" data-action="toggle-version"
                            data-tooltip="Voir version précédente" aria-label="Basculer entre versions"
                            style="display: none;"><iconify-icon class="iconify-inline"
                                icon="solar:history-bold"></iconify-icon></button>
                        <button class="icon-action-btn copy-btn tooltip" data-action="copy" data-tooltip="Copier"
                            aria-label="Copier l'appréciation"><iconify-icon class="iconify-inline"
                                icon="solar:copy-bold"></iconify-icon></button>
                        <button class="icon-action-btn tooltip" data-action="edit" data-tooltip="Modifier"
                            aria-label="Modifier l'élève"><iconify-icon class="iconify-inline"
                                icon="solar:pen-bold"></iconify-icon></button>
                        <button class="icon-action-btn tooltip" data-action="regenerate" data-tooltip="Régénérer"
                            aria-label="Régénérer l'appréciation"><iconify-icon class="iconify-inline"
                                icon="solar:restart-bold"></iconify-icon></button>
                        <button class="icon-action-btn tooltip" data-action="delete" data-tooltip="Supprimer"
                            aria-label="Supprimer l'élève"><iconify-icon class="iconify-inline"
                                icon="solar:trash-bin-trash-bold"></iconify-icon></button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="empty-state-template">
        <div class="empty-state-illustration">
            <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="60" cy="60" r="55" stroke="url(#gradient)" stroke-width="2" stroke-dasharray="8 4"
                    class="empty-state-circle" />
                <path d="M45 55L55 65L75 45" stroke="url(#gradient)" stroke-width="3" stroke-linecap="round"
                    stroke-linejoin="round" class="empty-state-check" />
                <circle cx="60" cy="60" r="25" fill="url(#gradient)" fill-opacity="0.1" />
                <text x="60" y="65" text-anchor="middle" font-size="24" class="empty-state-emoji">✨</text>
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#d97706" />
                        <stop offset="100%" stop-color="#b45309" />
                    </linearGradient>
                </defs>
            </svg>
        </div>
        <h3>Commencez par ajouter vos élèves</h3>

        <!-- Hub d'import intégré directement -->
        <div class="empty-state-hub">
            <div class="empty-state-hub-card" data-action="individual" tabindex="0" role="button">
                <div class="empty-state-hub-icon">
                    <iconify-icon class="iconify-inline" icon="solar:user-plus-bold"></iconify-icon>
                </div>
                <div class="empty-state-hub-text">
                    <h4>Individuel</h4>
                    <p>Ajouter un élève manuellement</p>
                </div>
            </div>
            <div class="empty-state-hub-card" data-action="mass" tabindex="0" role="button">
                <div class="empty-state-hub-icon">
                    <iconify-icon icon="solar:file-text-bold"></iconify-icon>
                </div>
                <div class="empty-state-hub-text">
                    <h4>Classe entière</h4>
                    <p>Importer depuis Excel / CSV</p>
                </div>
            </div>
        </div>
    </template>

    <template id="skeleton-card-template">
        <div class="skeleton-card">
            <div class="skeleton-card-header">
                <div class="skeleton skeleton-circle skeleton-avatar"></div>
                <div class="skeleton-info">
                    <div class="skeleton skeleton-text skeleton-name"></div>
                    <div class="skeleton skeleton-text skeleton-badge"></div>
                </div>
            </div>
            <div class="skeleton-card-body">
                <div class="skeleton skeleton-text long"></div>
                <div class="skeleton skeleton-text medium"></div>
                <div class="skeleton skeleton-text long"></div>
            </div>
            <div class="skeleton-card-footer">
                <div class="skeleton skeleton-button"></div>
                <div class="skeleton skeleton-button"></div>
            </div>
        </div>
    </template>

    <script type="module" src="./src/main.js"></script>

    <!-- Modale Création de Classe (Premium iOS 2025 Style) -->
    <div id="createClassModal" class="modal modal-mini" role="dialog" aria-modal="true"
        aria-labelledby="createClassModalTitle">
        <div class="modal-content modal-mini-content">
            <div class="modal-header modal-header-centered">
                <div class="modal-icon-wrapper">
                    <iconify-icon class="iconify-inline" icon="solar:folder-with-files-bold"></iconify-icon>
                </div>
                <h2 class="modal-title" id="createClassModalTitle">Nouvelle classe</h2>
            </div>
            <div class="modal-body modal-body-compact">
                <div class="form-group premium-input-group">
                    <input type="text" id="newClassNameInput" class="form-input premium-input"
                        placeholder="CM2 A, 6ème B, Terminale S..." maxlength="50" autocomplete="off" autofocus>
                    <span class="input-char-count"><span id="classNameCharCount">0</span>/50</span>
                </div>
            </div>
            <div class="modal-footer modal-footer-buttons">
                <button class="btn btn-secondary" id="cancelCreateClassBtn">Annuler</button>
                <button class="btn btn-organic" id="confirmCreateClassBtn" disabled>
                    <iconify-icon icon="ph:check-bold"></iconify-icon> Créer
                </button>
            </div>
        </div>
    </div>

    <!-- CLASS DASHBOARD MODAL - Premium Analytics View -->
    <div id="classDashboardModal" class="modal class-dashboard-modal" role="dialog" aria-modal="true"
        aria-labelledby="classDashboardModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <div class="dashboard-header-left">
                    <h2 class="modal-title" id="classDashboardModalTitle">
                        <iconify-icon class="iconify-inline" icon="solar:pie-chart-3-bold"></iconify-icon> Tableau de
                        Bord
                    </h2>
                    <span class="dashboard-period-badge" id="dashboardPeriodBadge">
                        <iconify-icon class="iconify-inline" icon="solar:calendar-bold"></iconify-icon> Trimestre 1
                    </span>
                </div>
                <span class="dashboard-student-count" id="dashboardStudentCount">
                    <iconify-icon icon="solar:users-group-rounded-bold"></iconify-icon>
                    <strong>0</strong> élèves
                    analysés
                </span>
                <button class="close-button" id="closeDashboardModalBtn" aria-label="Fermer le tableau de bord">
                    <iconify-icon icon="ph:x"></iconify-icon>
                </button>
            </div>

            <div class="modal-body">
                <!-- Compact Spread Stat (unique to this modal) -->
                <div class="dashboard-spread-inline">
                    <div class="spread-inline-icon"><iconify-icon class="iconify-inline"
                            icon="solar:ruler-bold"></iconify-icon></div>
                    <div class="spread-inline-content">
                        <span class="spread-inline-label">Écart-type</span>
                        <span class="spread-inline-value" id="kpiSpread">--</span>
                        <span class="spread-inline-unit">pts</span>
                    </div>
                    <span class="spread-inline-badge" id="kpiSpreadLabel">--</span>
                </div>

                <!-- Highlights: Progressions & At Risk -->
                <div class="dashboard-highlights">
                    <div class="highlight-card">
                        <div class="highlight-card-header">
                            <div class="highlight-icon success"><iconify-icon class="iconify-inline"
                                    icon="solar:graph-up-bold"></iconify-icon></div>
                            <span class="highlight-card-title">Top Progressions</span>
                        </div>
                        <div class="highlight-list" id="highlightProgressList">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                    <div class="highlight-card">
                        <div class="highlight-card-header">
                            <div class="highlight-icon warning"><iconify-icon
                                    icon="solar:danger-circle-bold"></iconify-icon></div>
                            <span class="highlight-card-title">À surveiller</span>
                        </div>
                        <div class="highlight-list" id="highlightRiskList">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- AI Synthesis Section -->
                <div class="dashboard-ai-section">
                    <div class="ai-section-header">
                        <h3 class="ai-section-title"><iconify-icon icon="solar:magic-stick-3-bold"></iconify-icon>
                            Synthèse IA</h3>
                        <div class="ai-section-actions">
                            <button class="btn btn-ai btn-small" id="generateSynthesisBtn">
                                <iconify-icon icon="solar:magic-stick-3-bold"></iconify-icon> Générer
                                la synthèse
                            </button>
                        </div>
                    </div>
                    <div class="ai-section-content" id="aiSynthesisContent">
                        <div class="ai-placeholder">
                            <div class="ai-placeholder-icon"><iconify-icon
                                    icon="solar:magic-stick-3-bold"></iconify-icon></div>
                            <p class="ai-placeholder-text">Cliquez sur "Générer la synthèse"
                                pour obtenir une analyse IA
                                contextuelle de votre classe.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="dashboard-footer-right">
                    <button class="btn btn-secondary" id="copyDashboardSynthesisBtn">
                        <iconify-icon class="iconify-inline" icon="solar:copy-bold"></iconify-icon> Copier
                    </button>
                    <button class="btn btn-secondary" id="closeDashboardFooterBtn">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Legacy classAnalysisModal ID kept for backward compatibility -->
    <div id="classAnalysisModal" style="display: none;"></div>

    <!-- ==================================================================== -->
    <!-- PWA INSTALL BANNER - Smart install prompt                             -->
    <!-- ==================================================================== -->
    <div id="pwaInstallBanner" class="pwa-install-banner" role="alert" aria-live="polite">
        <div class="pwa-banner-content">
            <div class="pwa-banner-icon">
                <img src="./assets/icon-192.png" alt="Bulletin AI">
            </div>
            <div class="pwa-banner-text">
                <h4 class="pwa-banner-title">Installer Bulletin AI</h4>
                <p class="pwa-banner-subtitle">Accès rapide depuis votre écran d'accueil</p>
            </div>
            <div class="pwa-banner-actions">
                <button id="pwaInstallBtn" class="btn-install">
                    <iconify-icon class="iconify-inline" icon="solar:download-bold"></iconify-icon> Installer
                </button>
                <button id="pwaLaterBtn" class="btn-dismiss" aria-label="Plus tard" title="Plus tard">
                    <iconify-icon class="iconify-inline" icon="solar:clock-circle-bold"></iconify-icon>
                </button>
                <button id="pwaDismissBtn" class="btn-dismiss" aria-label="Ne plus afficher" title="Ne plus afficher">
                    <iconify-icon class="iconify-inline" icon="ph:x"></iconify-icon>
                </button>
            </div>
        </div>
        <!-- iOS Safari manual instructions (shown only on iOS) -->
        <div class="pwa-ios-guide">
            <div class="pwa-ios-step">
                <iconify-icon class="iconify-inline" icon="solar:export-bold"></iconify-icon>
                <span>Appuyez sur <strong>Partager</strong></span>
            </div>
            <div class="pwa-ios-step">
                <iconify-icon class="iconify-inline" icon="solar:add-square-bold"></iconify-icon>
                <span>Puis <strong>Sur l'écran d'accueil</strong></span>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="importSettingsInput" accept=".json" style="display: none;">




    <!-- Page Entrance Transition from Landing Page -->
    <script>
        (function initPageEntrance() {
            // Check if user is coming from landing page (within last 2 seconds)
            const transitionTimestamp = sessionStorage.getItem('landingTransition');
            const now = Date.now();

            if (transitionTimestamp && (now - parseInt(transitionTimestamp, 10)) < 2000) {
                // Clear the flag
                sessionStorage.removeItem('landingTransition');

                // Apply entrance animation class
                document.body.classList.add('is-transitioning-in');

                // Remove the class after animation completes
                setTimeout(() => {
                    document.body.classList.remove('is-transitioning-in');
                }, 800); // Slightly longer than animation duration
            }
        })();
    </script>
</body>

</html>