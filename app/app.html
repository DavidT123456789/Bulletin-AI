<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Configuration -->
    <link rel="manifest" href="./manifest.webmanifest">
    <meta name="theme-color" content="#6c5ce7">
    <link rel="apple-touch-icon" href="./assets/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- SEO Meta Tags -->
    <meta name="description"
        content="Bulletin AI - Assistant intelligent pour la rédaction d'appréciations scolaires. Générez des appréciations personnalisées pour vos élèves grâce à l'IA.">
    <meta name="keywords"
        content="bulletin scolaire, appréciations, enseignant, IA, intelligence artificielle, école, éducation">
    <meta name="author" content="David Trafial">
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Bulletin AI | Assistant de rédaction d'appréciations scolaires">
    <meta property="og:description"
        content="Générez des appréciations personnalisées pour vos élèves grâce à l'intelligence artificielle. Gratuit et conforme RGPD.">
    <meta property="og:image" content="./assets/icon-512.png">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Bulletin AI | Assistant de rédaction d'appréciations scolaires">
    <meta name="twitter:description"
        content="Générez des appréciations personnalisées pour vos élèves grâce à l'intelligence artificielle.">
    <meta name="twitter:image" content="./assets/icon-512.png">
    <!-- CSP removed for GitHub Pages compatibility -->
    <title>Bulletin AI | Votre assistant de rédaction</title>
    <link rel="icon" type="image/svg+xml" href="assets/icon.svg" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/svg+xml" href="assets/icon-dark-mode.svg" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="src/css/main.css">
    <script>
        // Immediate Theme Application (Prevents White Flash)
        try {
            const savedState = localStorage.getItem('bulletin_app_state');
            if (savedState) {
                const state = JSON.parse(savedState);
                // Check flattened settings (legacy/flat structure)
                let theme = 'light';
                if (state.settings && state.settings.theme) {
                    theme = state.settings.theme;
                } else if (state.theme) {
                    theme = state.theme;
                }

                if (theme === 'dark') {
                    document.documentElement.dataset.theme = 'dark';
                }
            }
        } catch (e) {
            console.error('Theme init error:', e);
        }
    </script>
</head>

<body>
    <!-- Skip Link pour accessibilité WCAG -->
    <a href="#main-content" class="skip-link">Aller au contenu principal</a>

    <!-- NOUVELLE STRUCTURE DE MISE EN PAGE PRINCIPALE -->
    <!-- Liste + Focus: Sidebar collapsed by default -->
    <div class="app-layout sidebar-collapsed app-loading">

        <!-- Sidebar removed - Import functionality now handled by Hub Modal -->
        <!-- ==================================================================== -->
        <!-- 2. CONTENU PRINCIPAL                                                 -->
        <!-- ==================================================================== -->
        <div class="main-content-wrapper">
            <header class="header">
                <!-- App Logo removed for cleaner UI -->
                <div class="header-logo" style="display: none;"></div>

                <!-- Class Selector - À gauche pour hiérarchie: Classe > Trimestre > Modèle -->
                <div class="class-selector-wrapper">
                    <div id="headerClassChip" class="header-context-chip class-chip tooltip" role="button" tabindex="0"
                        data-tooltip="Changer de classe">
                        <span class="icon"><i class="fas fa-users"></i></span>
                        <span id="headerClassName">Ma Classe</span>
                        <span id="headerStudentCount" class="student-count-badge">0</span>
                        <i class="fas fa-chevron-down class-chevron"></i>
                    </div>
                    <div id="classDropdown" class="class-dropdown" style="display: none;">
                        <div class="class-dropdown-header">
                            <button id="manageClassesBtn" class="class-dropdown-title-btn" title="Gérer les classes">
                                <i class="fas fa-cog"></i>
                                <span>Mes Classes</span>
                            </button>
                            <button id="addNewClassBtn" class="btn-icon-small tooltip" data-tooltip="Nouvelle classe">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="classDropdownList" class="class-dropdown-list">
                            <!-- Classes will be rendered here dynamically -->
                        </div>
                    </div>
                </div>

                <div class="header-center">
                    <div class="generation-mode-selector header-style" id="mainPeriodSelector"></div>
                </div>

                <div class="header-actions">
                    <!-- Generation Dashboard: Always shows class status -->
                    <div id="headerGenDashboard" class="header-gen-dashboard" role="status" aria-live="polite"
                        aria-label="Statut de génération">
                        <!-- Model indicator (subtle, clickable) -->
                        <button class="dash-model-label tooltip" id="dashModelLabel"
                            data-tooltip="Changer de modèle IA">
                            <i class="fas fa-microchip"></i>
                            <span id="dashModelName">Gemini</span>
                        </button>
                        <div class="dash-divider"></div>
                        <!-- Validated count -->
                        <button class="dash-badge dash-validated" id="dashValidated"
                            data-tooltip="Appréciations validées">
                            <i class="fas fa-check"></i>
                            <span class="dash-count" id="dashValidatedCount">0</span>
                        </button>
                        <!-- Error count (hidden if 0) -->
                        <button class="dash-badge dash-errors" id="dashErrors" data-tooltip="Erreurs de génération">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span class="dash-count" id="dashErrorCount">0</span>
                        </button>
                        <!-- Pending count -->
                        <button class="dash-badge dash-pending" id="dashPending"
                            data-tooltip="En attente de génération">
                            <i class="fas fa-hourglass-half"></i>
                            <span class="dash-count" id="dashPendingCount">0</span>
                        </button>
                        <!-- Generating state overlay -->
                        <div class="dash-generating" id="dashGenerating">
                            <div class="dash-progress-bar">
                                <div class="dash-progress-fill" id="dashProgressFill"></div>
                            </div>
                            <span class="dash-progress-text" id="dashProgressText">0/0</span>
                            <button class="dash-cancel-btn" id="dashCancelBtn" data-tooltip="Annuler">
                                <i class="fas fa-xmark"></i>
                            </button>
                        </div>
                    </div>

                    <div class="header-actions-pill">

                        <div class="dropdown-wrapper">
                            <button id="headerMenuBtn" class="pill-segment menu-btn tooltip" data-tooltip="Menu">
                                <i class="fas fa-ellipsis-vertical"></i>
                            </button>

                            <div id="headerMenuDropdown" class="header-dropdown-menu">
                                <div class="theme-control-wrapper">
                                    <div class="theme-segmented-control" id="themeSegmentedControl" data-active="light">
                                        <button class="theme-segment" data-value="light" aria-label="Mode clair"
                                            title="Mode clair">
                                            <i class="fas fa-sun"></i>
                                        </button>
                                        <button class="theme-segment" data-value="system" aria-label="Mode système"
                                            title="Mode système">
                                            <i class="fas fa-desktop"></i>
                                        </button>
                                        <button class="theme-segment" data-value="dark" aria-label="Mode sombre"
                                            title="Mode sombre">
                                            <i class="fas fa-moon"></i>
                                        </button>
                                        <div class="theme-glider"></div>
                                    </div>
                                </div>
                                <button id="updateMenuItem" class="menu-item update-item" style="display: none;">
                                    <i class="fas fa-gift" style="color: var(--primary-color);"></i>
                                    <span style="color: var(--primary-color); font-weight: 600;">Mise à jour
                                        disponible</span>
                                </button>
                                <div class="menu-separator"></div>
                                <button id="personalizationBtn" class="menu-item">
                                    <i class="fas fa-wand-magic-sparkles"></i> Personnalisation
                                </button>
                                <button id="settingsButton" class="menu-item">
                                    <i class="fas fa-cog"></i> Paramètres
                                </button>
                                <button id="helpButton" class="menu-item">
                                    <i class="fas fa-circle-question"></i> Aide
                                </button>
                                <div class="menu-separator"></div>
                                <button id="cloudReconnectBtn" class="menu-item cloud-reconnect-item"
                                    style="display: none;">
                                    <i class="fas fa-plug"></i>
                                    <span>Reconnecter Google Drive</span>
                                </button>
                                <button id="cloudSaveMenuBtn" class="menu-item cloud-save-menu-item"
                                    style="display: none;">
                                    <i class="fas fa-cloud-arrow-up"></i>
                                    <span class="cloud-save-label">Enregistrer (Cloud)</span>
                                    <span class="cloud-save-time" id="cloudSaveTimeHint"></span>
                                </button>
                                <button id="cloudLoadMenuBtn" class="menu-item cloud-save-menu-item"
                                    style="display: none;">
                                    <i class="fas fa-cloud-arrow-down"></i>
                                    <span class="cloud-save-label">Récupérer (Cloud)</span>
                                    <span class="cloud-save-time" id="cloudLoadTimeHint"></span>
                                </button>
                                <div class="menu-separator"></div>
                                <button id="installPwaBtn" class="menu-item" style="display: none;">
                                    <i class="fas fa-download"></i> Installer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- PWA Update Banner -->
            <div id="pwaUpdateBanner" class="pwa-update-banner" style="display: none;">
                <div class="pwa-banner-main">
                    <div class="pwa-banner-text">
                        <i class="fas fa-gift pwa-gift-icon"></i>
                        <div class="pwa-text-col">
                            <span class="pwa-title">Mise à jour disponible</span>
                            <span class="pwa-subtitle" id="pwaUpdateMeta">Version plus récente détectée</span>
                        </div>
                    </div>
                    <div class="pwa-banner-actions">
                        <button id="pwaInfoBtn" class="pwa-info-btn tooltip" data-tooltip="Nouveautés">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <button id="pwaUpdateBtn" class="btn btn-sm btn-primary">Installer</button>
                        <button id="pwaUpdateDismissBtn" class="pwa-close-btn" aria-label="Fermer">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div id="pwaUpdateDetails" class="pwa-banner-details">
                    <div class="pwa-details-content">
                        <div class="pwa-detail-row">
                            <span class="pwa-detail-label">Message :</span>
                            <span class="pwa-detail-value" id="pwaCommitMsg">Améliorations générales et corrections de
                                bugs.</span>
                        </div>
                        <div class="pwa-detail-row">
                            <span class="pwa-detail-label">Version :</span>
                            <span class="pwa-detail-code" id="pwaCommitHash">v0.1.X</span>
                        </div>
                    </div>
                </div>
            </div>

            <main class="main-content" id="main-content">
                <div class="output-section">
                    <div class="stats-container" id="statsContainer">
                        <!-- 1. PERFORMANCE (avec Médiane intégrée) -->
                        <div class="stat-card performance-card" id="performanceCard">
                            <div class="stat-card-header">
                                <h4 class="stat-title">Moyenne de classe</h4>
                                <div class="evolution-chip" id="classEvolutionChip">
                                    <span id="classEvolutionAverageStat">--</span>
                                </div>
                            </div>
                            <div class="performance-overview">
                                <span class="main-average-value" id="currentAvgGradeOutput">--</span>
                                <span class="average-denominator">/20</span>
                            </div>
                            <div class="performance-details">
                                <div class="detail-item tooltip" data-filter-id="minGrade" role="button" tabindex="0"
                                    data-tooltip="Note la plus basse">
                                    <span class="detail-value" id="minAvgGradeOutput">--</span>
                                    <span class="detail-label">Min</span>
                                </div>
                                <div class="detail-item tooltip"
                                    data-tooltip="Valeur centrale : 50% des élèves sont au-dessus">
                                    <span class="detail-value" id="medianGradeOutput">--</span>
                                    <span class="detail-label">Médiane</span>
                                </div>
                                <div class="detail-item tooltip" data-filter-id="maxGrade" role="button" tabindex="0"
                                    data-tooltip="Note la plus haute">
                                    <span class="detail-value" id="maxAvgGradeOutput">--</span>
                                    <span class="detail-label">Max</span>
                                </div>
                            </div>
                        </div>

                        <!-- 2. DISPERSION (Histogramme + Homogénéité fusionnés) -->
                        <div class="stat-card dispersion-card" id="dispersionCard">
                            <div class="stat-card-header">
                                <h4 class="stat-title">Répartition</h4>
                                <span class="homogeneity-badge" id="heterogeneityLabel">--</span>
                            </div>
                            <div class="histogram-container">
                                <div class="histogram-bars">
                                    <div class="hist-bar-group" data-range="0-4" data-filter-id="gradeRange_0-4"
                                        role="button" tabindex="0">
                                        <div class="hist-bar" style="height: 0%"></div>
                                        <span class="hist-label">0-4</span>
                                    </div>
                                    <div class="hist-bar-group" data-range="4-8" data-filter-id="gradeRange_4-8"
                                        role="button" tabindex="0">
                                        <div class="hist-bar" style="height: 0%"></div>
                                        <span class="hist-label">4-8</span>
                                    </div>
                                    <div class="hist-bar-group" data-range="8-12" data-filter-id="gradeRange_8-12"
                                        role="button" tabindex="0">
                                        <div class="hist-bar" style="height: 0%"></div>
                                        <span class="hist-label">8-12</span>
                                    </div>
                                    <div class="hist-bar-group" data-range="12-16" data-filter-id="gradeRange_12-16"
                                        role="button" tabindex="0">
                                        <div class="hist-bar" style="height: 0%"></div>
                                        <span class="hist-label">12-16</span>
                                    </div>
                                    <div class="hist-bar-group" data-range="16-20" data-filter-id="gradeRange_16-20"
                                        role="button" tabindex="0">
                                        <div class="hist-bar" style="height: 0%"></div>
                                        <span class="hist-label">16-20</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. DYNAMIQUE (Évolution des élèves) -->
                        <div class="stat-card evolution-card" id="evolutionCard">
                            <div class="stat-card-header">
                                <h4 class="stat-title" id="chartTitle">Dynamique</h4>
                            </div>
                            <div class="evolution-distribution-bar">
                                <div id="progressChartBar" class="bar-segment progress" data-percent="0%"></div>
                                <div id="stableChartBar" class="bar-segment stable" data-percent="0%"></div>
                                <div id="regressionChartBar" class="bar-segment regression" data-percent="0%"></div>
                            </div>
                            <div class="evolution-legend">
                                <div class="legend-item" data-filter-id="progressCount" role="button" tabindex="0">
                                    <span class="legend-dot progress"></span>
                                    <div class="legend-text">
                                        <span class="legend-label">Progrès</span>
                                        <span class="legend-count" id="classEvolutionProgressStat">0</span>
                                    </div>
                                </div>
                                <div class="legend-item" data-filter-id="stableCount" role="button" tabindex="0">
                                    <span class="legend-dot stable"></span>
                                    <div class="legend-text">
                                        <span class="legend-label">Stables</span>
                                        <span class="legend-count" id="classEvolutionStableStat">0</span>
                                    </div>
                                </div>
                                <div class="legend-item" data-filter-id="regressionCount" role="button" tabindex="0">
                                    <span class="legend-dot regression"></span>
                                    <div class="legend-text">
                                        <span class="legend-label">Régression</span>
                                        <span class="legend-count" id="classEvolutionRegressionStat">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Pagination Indicators (Mobile) -->
                    <div class="stats-pagination" id="statsPagination" aria-hidden="true">
                        <div class="stats-dot active"></div>
                        <div class="stats-dot"></div>
                        <div class="stats-dot"></div>
                    </div>

                    <!-- Progress and error UI moved to header chip (#headerGenerationStatus) -->

                    <div class="output-header" id="outputHeader">
                        <div class="output-toolbar">
                            <!-- Recherche à gauche -->
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" id="searchInput" placeholder="Rechercher...">
                                <button type="button" class="search-clear-btn" id="searchClearBtn"
                                    aria-label="Effacer la recherche">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <!-- Active filter badge - inline in toolbar -->
                            <div id="activeFilterInfo" class="toolbar-filter-badge"></div>
                            <!-- Actions à droite - ordre stable -->
                            <div class="toolbar-actions">
                                <button type="button" class="btn btn-ai tooltip" id="analyzeClassBtn" disabled
                                    data-tooltip="Analyse IA de la classe">
                                    <i class="fas fa-chart-pie"></i> Analyser
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="outputList" role="region" aria-live="polite"></div>
                    <div id="skeletonContainer" class="skeleton-grid" style="display: none;">
                        <!-- Skeletons générés dynamiquement -->
                    </div>
                    <div id="empty-state-card" style="display: none;"></div>
                    <p id="noResultsMessage" class="no-results-message">Aucun résultat ne correspond à votre recherche.
                    </p>
                </div>

                <!-- Floating Action Button for Adding Student -->
                <button id="addStudentFab" class="fab-add-student tooltip" data-tooltip="Ajouter un nouvel élève"
                    aria-label="Ajouter un élève">
                    <i class="fas fa-plus"></i>
                </button>
            </main>
        </div>
    </div>

    <!-- ==================================================================== -->
    <!-- FOCUS PANEL - Vue détaillée d'un élève (Liste + Focus UX)           -->
    <!-- ==================================================================== -->
    <div id="focusPanelBackdrop" class="focus-panel-backdrop"></div>
    <div id="focusPanel" class="focus-panel" role="dialog" aria-modal="true" aria-labelledby="focusStudentName">
        <div class="focus-header">
            <!-- LEFT ZONE: Avatar (always visible) -->
            <div class="focus-header-left">
                <!-- AVATAR: Always visible, editable in edit mode -->
                <div id="focusAvatarContainer" class="focus-panel-avatar-container">
                    <!-- Populated by FocusPanelManager -->
                </div>
            </div>

            <!-- IDENTITY ZONE: Name/Badges (read) or Inputs (edit) - CENTERED -->
            <div id="focusHeaderContent" class="focus-header-content">
                <!-- READ MODE: Name & Badges -->
                <div class="focus-header-read">
                    <h2 id="focusStudentName" class="focus-student-name" role="button" tabindex="0"
                        data-tooltip="Cliquez pour éditer l'identité et les statuts">
                        Sophie DURAND
                        <i class="fas fa-pen focus-name-edit-icon"></i>
                    </h2>
                    <div id="focusStatusBadges" class="focus-status-badges">
                        <!-- Badges générés dynamiquement -->
                    </div>
                </div>

                <!-- EDIT MODE: Inputs & Checkboxes (Hidden by default via CSS) -->
                <div class="focus-header-edit">
                    <div class="focus-edit-row">
                        <input type="text" id="headerPrenomInput" class="focus-input-header" placeholder="Prénom"
                            autocomplete="off">
                        <input type="text" id="headerNomInput" class="focus-input-header" placeholder="NOM"
                            autocomplete="off">
                    </div>
                    <div class="focus-status-selection">
                        <label class="status-pill-check"><input type="checkbox" value="Nouveau"> Nouveau</label>
                        <label class="status-pill-check"><input type="checkbox" value="Départ"> Départ</label>
                        <label class="status-pill-check"><input type="checkbox" value="PPRE"> PPRE</label>
                        <label class="status-pill-check"><input type="checkbox" value="PAP"> PAP</label>
                        <label class="status-pill-check"><input type="checkbox" value="ULIS"> ULIS</label>
                        <label class="status-pill-check"><input type="checkbox" value="Délégué"> Délégué</label>
                    </div>
                </div>
            </div>

            <!-- RIGHT ZONE: Unified Navigation Pill (Close + Prev/Next) -->
            <div class="focus-nav-buttons">
                <button id="focusPrevBtn" class="focus-nav-btn" aria-label="Élève précédent">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="focusPosition" class="focus-position">3/25</span>
                <button id="focusNextBtn" class="focus-nav-btn" aria-label="Élève suivant">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="focus-nav-divider"></div>
                <!-- Edit mode: Save button (hidden in read mode, visible in edit mode) -->
                <button id="focusEditSaveBtn" class="focus-nav-btn focus-save-btn" aria-label="Valider">
                    <i class="fas fa-check"></i>
                </button>
                <button id="focusBackBtn" class="focus-nav-btn focus-close-btn" aria-label="Fermer le panneau">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div class="focus-pages-container" id="focusPagesContainer">
            <!-- PAGE 1: Main Content (édition) -->
            <div class="focus-page focus-main-page" id="focusMainPage">
                <div class="focus-content">
                    <!-- Section historique supprimée - le contexte précédent est visible en chips inline -->

                    <!-- 2. HISTORY GRADES & CONTEXT -->
                    <div class="focus-context-group">
                        <div class="focus-context-header">
                            <div class="focus-context-label">
                                <span class="tooltip focus-context-info-trigger"
                                    data-tooltip="Un contexte relatif au travail, comportement et implication dans les projets de l'élève, permet d'obtenir des appréciations plus précises.">
                                    <i class="fas fa-info-circle"></i>
                                    Contexte
                                </span>
                                <!-- Voice Dictation Button -->
                                <button type="button" id="focusMicBtn" class="focus-mic-btn tooltip"
                                    data-tooltip="Dictée vocale" aria-label="Dicter le contexte">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>

                            <!-- NEW: Previous Grades next to Current Grade -->
                            <div class="grades-wrapper">
                                <div id="focusPreviousGrades" class="previous-grades-inline">
                                    <!-- Populated by JS: T1: 12, T2: 14 -->
                                </div>
                                <div class="context-grade-group">
                                    <label for="focusCurrentGradeInput" id="focusCurrentGradeLabel">T1</label>
                                    <input type="text" id="focusCurrentGradeInput" class="context-grade-input"
                                        placeholder="--" maxlength="4">
                                </div>
                            </div>
                        </div>
                        <textarea id="focusContextInput" class="focus-context-textarea"
                            placeholder="Bavardages, travail sérieux, compréhension fragile, bonne participation, etc."></textarea>
                    </div>

                    <!-- 3. JOURNAL DE BORD - Observation notes -->
                    <div class="journal-section" id="focusJournalSection">
                        <div class="journal-header" id="focusJournalHeader">
                            <div class="journal-header-left">
                                <div class="journal-title-group">
                                    <i class="fas fa-book"></i>
                                    <span>Journal de bord</span>
                                </div>
                                <div class="journal-controls-group">
                                    <!-- Manual note button (Pen icon) -->
                                    <button class="journal-header-btn icon-only tooltip" id="focusJournalNoteBtn"
                                        data-tooltip="Ajouter une note">
                                        <i class="fas fa-pen"></i>
                                    </button>

                                    <!-- Tag dropdowns (Always visible) -->
                                    <div class="journal-inline-tags" id="journalInlineTags" style="display: flex;">
                                        <!-- Rendered by JS: Positif/Négatif dropdowns -->
                                    </div>

                                    <!-- Threshold quick control -->
                                    <div class="journal-threshold-control" id="journalThresholdControl">
                                        <button class="journal-threshold-btn journal-header-btn tooltip"
                                            id="journalThresholdBtn" data-tooltip="Cliquez pour régler le seuil">
                                            <i class="fas fa-filter"></i>
                                            <span id="journalThresholdValue">≥2</span>
                                        </button>
                                        <div class="journal-threshold-popover" id="journalThresholdPopover">
                                            <div class="threshold-popover-header">Seuil de signalement</div>
                                            <div class="threshold-popover-desc">Observations répétées transmises à l'IA
                                            </div>
                                            <div class="threshold-popover-controls">
                                                <button class="threshold-adjust-btn" data-delta="-1">−</button>
                                                <span class="threshold-current" id="thresholdCurrentValue">2</span>
                                                <button class="threshold-adjust-btn" data-delta="+1">+</button>
                                            </div>
                                            <div class="threshold-popover-hint">
                                                <span id="thresholdHintText">1 = tout compte • 3 = plus tolérant</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="journal-header-right">
                                <span class="journal-count-badge" id="focusJournalCount">0</span>
                            </div>
                        </div>
                        <div class="journal-content" id="focusJournalContent">
                            <!-- Draft preview (when editing) + Timeline rendered by JS -->
                        </div>
                    </div>

                    <!-- Appréciation - Now editable with refinement options -->
                    <div class="focus-appreciation">
                        <div class="focus-appreciation-header">
                            <div class="focus-appreciation-label">
                                <i class="fas fa-comment-dots"></i>
                                Appréciation
                                <!-- Voice Dictation Button for Appreciation -->
                                <button type="button" id="focusAppreciationMicBtn" class="focus-mic-btn tooltip"
                                    data-tooltip="Dictée vocale" aria-label="Dicter l'appréciation">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <!-- History Navigation Group (Segmented) -->
                                <div class="history-navigation-group" id="historyNavigationGroup"
                                    style="display: none;">
                                    <button id="focusHistoryPrevBtn" class="history-nav-btn tooltip"
                                        data-tooltip="Version précédente (Ctrl+Z)" disabled>
                                        <i class="fas fa-chevron-left"></i>
                                    </button>

                                    <!-- Central Indicator (Existing) -->
                                    <button id="focusHistoryIndicator" class="history-indicator-btn tooltip"
                                        data-tooltip="Historique des modifications">
                                        <span class="history-count">0</span>
                                    </button>

                                    <button id="focusHistoryNextBtn" class="history-nav-btn tooltip"
                                        data-tooltip="Version suivante (Ctrl+Y/Shift+Z)" disabled>
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="focus-appreciation-meta">
                                <span id="focusWordCount" class="word-count">0 mots</span>
                                <!-- AI Indicator: Shows if AI-generated, with model/token details -->
                                <span id="focusAiIndicator" class="ai-indicator tooltip" style="display: none;">
                                    ✨
                                </span>
                                <!-- Status Badge: Shows freshness state (generated, modified, pending) -->
                                <span id="focusAppreciationBadge" class="appreciation-status-badge tooltip"></span>
                            </div>
                        </div>
                        <div id="focusAppreciationText" class="focus-appreciation-text" contenteditable="true"
                            data-placeholder="Aucune appréciation générée. Cliquez sur 'Générer' ci-dessous.">
                        </div>

                        <!-- Refinement style buttons -->
                        <div class="focus-refinement-options" id="focusRefinementOptions">
                            <button class="btn btn-ai-outline btn-tiny tooltip" data-refine-type="concise"
                                data-tooltip="Réduit d'environ 20%">
                                <i class="fas fa-compress-alt"></i> Concise
                            </button>
                            <button class="btn btn-ai-outline btn-tiny tooltip" data-refine-type="detailed"
                                data-tooltip="Développe d'environ 20%">
                                <i class="fas fa-expand-alt"></i> Détaillée
                            </button>
                            <button class="btn btn-ai-outline btn-tiny tooltip" data-refine-type="encouraging"
                                data-tooltip="Ton plus positif et bienveillant">
                                <i class="fas fa-heart"></i> Encourageante
                            </button>
                            <button class="btn btn-ai-outline btn-tiny tooltip" data-refine-type="variations"
                                data-tooltip="Reformulation complète, même sens">
                                <i class="fas fa-sync-alt"></i> Variation
                            </button>
                            <button class="btn btn-ai-outline btn-tiny tooltip" data-refine-type="polish"
                                data-tooltip="Corrige et améliore le style">
                                <span class="polish-icon-wrapper">
                                    <i class="fas fa-wand-magic polish-wand"></i>
                                    <span class="polish-sparkle s1">✦</span>
                                    <span class="polish-sparkle s2">✦</span>
                                    <span class="polish-sparkle s3">✧</span>
                                </span>
                                Peaufiner
                            </button>
                        </div>
                    </div>
                </div> <!-- End focus-content -->
                <!-- Footer Page 1 -->
                <div class="focus-footer">
                    <button id="focusCopyBtn" class="btn btn-secondary tooltip" disabled
                        data-tooltip="Copier l'appréciation<br><i style='opacity:0.7'>Clic droit : copier le prompt</i>">
                        <i class="fas fa-copy"></i> Copier
                    </button>
                    <button id="focusGenerateBtn" class="btn btn-ai tooltip"
                        data-tooltip="Générer l'appréciation (Ctrl + Entrée)<br><i style='opacity:0.7'>Clic droit : prévisualiser le prompt</i>">
                        <i class="fas fa-wand-magic-sparkles"></i> Générer <span id="focusGeneratePeriod">T2</span>
                    </button>
                    <button id="focusAnalyzeBtn" class="btn btn-secondary">
                        <i class="fas fa-chart-pie"></i> Analyser
                    </button>
                </div>
            </div>

            <!-- PAGE 2: Analysis (slides in from right) -->
            <div class="focus-page focus-analysis-page" id="focusAnalysisPage">
                <div class="focus-analysis-header">
                    <button id="focusAnalysisBackBtn" class="focus-back-btn" aria-label="Fermer l'analyse">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <h3 class="focus-analysis-title">
                        <i class="fas fa-chart-pie"></i>
                        Analyse IA
                    </h3>
                    <button id="focusGenerateAnalysisBtn" class="btn btn-ai btn-sm">
                        <i class="fas fa-wand-magic-sparkles"></i> Générer
                    </button>
                </div>

                <div class="focus-content focus-analysis-content-area">
                    <!-- Forces Card -->
                    <div class="analysis-card analysis-forces" id="analysisForces">
                        <div class="analysis-card-header">
                            <span class="analysis-icon forces"><i class="fas fa-trophy"></i></span>
                            <h4>Forces</h4>
                        </div>
                        <div class="analysis-card-body" id="analysisForcesContent">
                            <div class="analysis-placeholder">
                                <i class="fas fa-lightbulb"></i>
                                <span>Cliquez sur "Générer" pour analyser les points forts.</span>
                            </div>
                        </div>
                    </div>

                    <!-- Faiblesses Card -->
                    <div class="analysis-card analysis-weaknesses" id="analysisWeaknesses">
                        <div class="analysis-card-header">
                            <span class="analysis-icon weaknesses"><i class="fas fa-exclamation-circle"></i></span>
                            <h4>Points de vigilance</h4>
                        </div>
                        <div class="analysis-card-body" id="analysisWeaknessesContent">
                            <div class="analysis-placeholder">
                                <i class="fas fa-microscope"></i>
                                <span>Analyse des difficultés potentielles...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pistes Card -->
                    <div class="analysis-card analysis-suggestions" id="analysisSuggestions">
                        <div class="analysis-card-header">
                            <span class="analysis-icon suggestions"><i class="fas fa-rocket"></i></span>
                            <h4>Pistes de progrès</h4>
                        </div>
                        <div class="analysis-card-body" id="analysisSuggestionsContent">
                            <div class="analysis-placeholder">
                                <i class="fas fa-road"></i>
                                <span>Suggestions pour la progression...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <!-- ==================================================================== -->
    <!-- IMPORT WIZARD MODAL - 3-step import workflow                         -->
    <!-- ==================================================================== -->
    <div id="importWizardModal" class="modal import-wizard-modal" role="dialog" aria-modal="true"
        aria-labelledby="importWizardTitle">
        <div class="modal-content import-wizard-content">
            <!-- Unified Header & Stepper -->
            <div class="import-wizard-header-unified">
                <div class="wizard-header-title" id="importWizardTitle">
                    <div class="wizard-title-pill">
                        <i class="fas fa-download"></i>
                        <span id="wizardClassBadge"></span>
                    </div>
                </div>

                <div class="import-wizard-stepper">
                    <div class="wizard-step active" data-step="1" role="button" tabindex="0">
                        <span class="wizard-step-number">1</span>
                        <span class="wizard-step-label">Données</span>
                    </div>
                    <div class="wizard-step-connector"></div>
                    <div class="wizard-step" data-step="2" role="button" tabindex="0">
                        <span class="wizard-step-number">2</span>
                        <span class="wizard-step-label">Mapping</span>
                    </div>
                    <div class="wizard-step-connector"></div>
                    <div class="wizard-step" data-step="3" role="button" tabindex="0">
                        <span class="wizard-step-number">3</span>
                        <span class="wizard-step-label">Confirmer</span>
                    </div>
                </div>

                <button class="close-modal-btn" id="closeImportWizardBtn" aria-label="Fermer">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="import-wizard-layout">
                <!-- LEFT: Guide Panel -->
                <aside class="wizard-guide-panel" id="wizardGuidePanel">
                    <!-- Step 1 Guide Content -->
                    <div class="guide-content active" data-guide-step="1">
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <i class="fas fa-calendar-alt"></i>
                                Période active
                            </div>
                            <span class="guide-period-badge" id="guidePeriodBadge">Semestre 2</span>
                            <p class="guide-text">Les données seront importées pour cette période.</p>
                            <p class="guide-hint">Pour changer, fermez et sélectionnez une autre période.</p>
                        </div>
                        <div class="guide-divider"></div>
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <i class="fas fa-file-import"></i>
                                Sources acceptées
                            </div>
                            <div class="guide-format-chips">
                                <div class="guide-format-chip tooltip" data-format="pdf"
                                    data-tooltip="PDF MBN / Pronote">
                                    <i class="fas fa-file-pdf"></i>
                                </div>
                                <div class="guide-format-chip tooltip" data-format="excel" data-tooltip="Fichier Excel">
                                    <i class="fas fa-file-excel"></i>
                                </div>
                                <div class="guide-format-chip tooltip" data-format="csv" data-tooltip="Fichier CSV">
                                    <i class="fas fa-file-csv"></i>
                                </div>
                                <div class="guide-format-chip tooltip" data-format="clipboard"
                                    data-tooltip="Copier-coller depuis tableur">
                                    <i class="fas fa-clipboard"></i>
                                </div>
                            </div>
                            <p class="guide-hint" style="margin-top: 8px;">Compatible PDF MBN / Pronote</p>
                        </div>
                        <div class="guide-divider"></div>
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <i class="fas fa-flask"></i>
                                Découvrir le fonctionnement
                            </div>
                            <p class="guide-text">Testez l'import avec des données fictives :</p>
                            <button class="guide-sample-btn" id="guideSampleBtn">
                                <i class="fas fa-wand-magic-sparkles"></i>
                                Charger un exemple
                            </button>
                        </div>
                    </div>

                    <!-- Step 2 Guide Content -->
                    <div class="guide-content" data-guide-step="2">
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <i class="fas fa-columns"></i>
                                Mapping des colonnes
                            </div>
                            <p class="guide-text">Associez chaque colonne de vos données à un champ de l'application.
                            </p>
                        </div>
                        <div class="guide-divider"></div>

                        <!-- Moved Separator Control -->
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <i class="fas fa-hashtag"></i>
                                Séparateur
                            </div>
                            <p class="guide-text">Si les colonnes sont mal découpées, changez ce paramètre.</p>
                            <div class="import-separator-row-guide">
                                <select id="wizardSeparatorSelect" class="import-separator-select full-width">
                                    <option value="tab">Tabulation</option>
                                    <option value=";">Point-virgule</option>
                                    <option value=",">Virgule</option>
                                    <option value="|">Barre (|)</option>
                                </select>
                            </div>
                        </div>

                        <div class="guide-divider"></div>
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <i class="fas fa-magic"></i>
                                Détection automatique
                            </div>
                            <p class="guide-text">Les colonnes sont pré-remplies automatiquement. Ajustez si nécessaire.
                            </p>
                            <!-- Moved Auto-detect Button -->
                            <button class="guide-sample-btn" id="wizardAutoDetectBtn"
                                style="margin-top: 8px; width: 100%;">
                                <i class="fas fa-wand-magic-sparkles"></i>
                                Relancer la détection
                            </button>
                        </div>
                    </div>

                    <!-- Step 3 Guide Content -->
                    <div class="guide-content" data-guide-step="3">
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <i class="fas fa-check-circle"></i>
                                Vérification finale
                            </div>
                            <p class="guide-text">Vérifiez les élèves avant de confirmer l'import.</p>
                        </div>
                        <div class="guide-divider"></div>
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <i class="fas fa-code-merge"></i>
                                Fusionner
                            </div>
                            <p class="guide-text">Ajoute les nouveaux et met à jour les existants. Conserve les absents.
                            </p>
                        </div>
                        <div class="guide-divider"></div>
                        <div class="guide-section">
                            <div class="guide-section-title">
                                <i class="fas fa-arrows-rotate"></i>
                                Remplacer
                            </div>
                            <p class="guide-text">Remplace toute la liste. Les absents du fichier seront supprimés.</p>
                            <p class="guide-hint warning"><i class="fas fa-exclamation-triangle"></i> Action
                                irréversible</p>
                        </div>
                    </div>
                </aside>

                <!-- RIGHT: Main Content -->
                <div class="wizard-main-content">
                    <div class="modal-body import-wizard-body">
                        <!-- Step 1: Data Input -->
                        <div class="wizard-step-content active" id="modalStep1" style="display: block;">
                            <div class="step-one-layout">
                                <!-- Enhanced Drop Zone -->
                                <div class="import-drop-zone" id="wizardDropZone">
                                    <!-- STATE 1: EMPTY -->
                                    <div class="drop-zone-content drop-zone-empty" id="wizardDropZoneEmpty">
                                        <div class="drop-zone-icon">
                                            <i class="fas fa-cloud-arrow-up"></i>
                                        </div>
                                        <div class="drop-zone-text">
                                            <span class="drop-zone-title">Glisser-déposer un fichier</span>
                                            <span class="drop-zone-hint">ou <u>cliquer pour parcourir</u></span>
                                        </div>
                                    </div>

                                    <!-- STATE 2: FILLED (File visualization) -->
                                    <div class="drop-zone-content drop-zone-filled" id="wizardDropZoneFilled"
                                        style="display: none;">
                                        <div class="file-preview-card">
                                            <div class="file-preview-icon" id="wizardFileIcon">
                                                <i class="fas fa-file-pdf"></i>
                                            </div>
                                            <div class="file-preview-info">
                                                <span class="file-preview-name"
                                                    id="wizardFileName">mon_fichier_notes.pdf</span>
                                                <div id="wizardFileBadgeSlot">
                                                    <!-- Badge inserted here by JS -->
                                                </div>
                                            </div>
                                            <button class="file-remove-btn" id="wizardRemoveFileBtn"
                                                aria-label="Supprimer le fichier">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Loading status overlay -->
                                    <div class="drop-zone-status" id="wizardDropZoneStatus">
                                        <div class="status-spinner"></div>
                                        <span class="status-text" id="wizardStatusText">Extraction du PDF...</span>
                                    </div>
                                    <input type="file" id="wizardFileInput" accept=".csv,.xlsx,.xls,.txt,.pdf"
                                        style="display: none;">
                                </div>

                                <div class="import-divider-horizontal">
                                    <span>ou</span>
                                </div>

                                <!-- Textarea with clear button -->
                                <div class="import-input-container">
                                    <textarea id="wizardDataTextarea" class="import-textarea" rows="6"
                                        placeholder="Collez vos données ici (Excel, CSV, Pronote...)&#10;&#10;Exemple :&#10;NOM Prénom      Moy.    Appréciation...&#10;MARTIN Lucas    12,5    Bon travail..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Mapping -->
                        <div class="wizard-step-content" id="modalStep2">


                            <div class="import-mapping-table-container" id="wizardMappingContainer">
                                <!-- Generated by JS: mapping table -->
                            </div>
                        </div>

                        <!-- Step 3: Confirm -->
                        <div class="wizard-step-content" id="modalStep3">
                            <div class="wizard-step3-header">
                                <h4 class="wizard-step-title">Vérifiez avant d'importer</h4>
                                <span class="period-badge-pill" id="wizardPeriodBadge">Trimestre 1</span>
                            </div>

                            <div class="import-preview-grid" id="wizardPreviewGrid">
                                <div class="import-preview-col import-col-new">
                                    <div class="import-col-header">
                                        <i class="fas fa-user-plus"></i>
                                        <span>Nouveaux</span>
                                        <span class="import-col-count" id="wizardNewCount">0</span>
                                    </div>
                                    <ul class="import-col-list" id="wizardNewList"></ul>
                                </div>
                                <div class="import-preview-col import-col-updated">
                                    <div class="import-col-header">
                                        <i class="fas fa-sync-alt"></i>
                                        <span>Mis à jour</span>
                                        <span class="import-col-count" id="wizardUpdatedCount">0</span>
                                    </div>
                                    <ul class="import-col-list" id="wizardUpdatedList"></ul>
                                </div>
                                <div class="import-preview-col import-col-departed">
                                    <div class="import-col-header">
                                        <i class="fas fa-user-minus"></i>
                                        <span>Départs</span>
                                        <span class="import-col-count" id="wizardDepartedCount">0</span>
                                    </div>
                                    <ul class="import-col-list" id="wizardDepartedList"></ul>
                                </div>
                            </div>

                            <!-- Strategy Options - Card Style with Checkmark -->
                            <div class="import-strategy-section">
                                <label class="import-strategy-radio">
                                    <input type="radio" name="wizardStrategy" value="merge" checked>
                                    <i class="fas fa-code-merge strategy-icon"></i>
                                    <span class="strategy-radio-content">
                                        <strong>Fusionner</strong>
                                        <span class="strategy-desc">Ajoute les nouveaux élèves et met à jour les
                                            informations
                                            des élèves existants. Les absents sont conservés.</span>
                                    </span>
                                    <span class="strategy-check"><i class="fas fa-check"></i></span>
                                </label>
                                <label class="import-strategy-radio">
                                    <input type="radio" name="wizardStrategy" value="replace">
                                    <i class="fas fa-arrows-rotate strategy-icon"></i>
                                    <span class="strategy-radio-content">
                                        <strong>Remplacer tout</strong>
                                        <span class="strategy-desc">Remplace la liste actuelle par ce fichier. Attention
                                            : les
                                            élèves non présents dans ce fichier seront supprimés.</span>
                                    </span>
                                    <span class="strategy-check"><i class="fas fa-check"></i></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- UNIFIED WIZARD FOOTER - Single source of truth -->
            <!-- Step 1 Footer -->
            <div class="import-wizard-footer" id="wizardStep1Footer">
                <button class="btn btn-ghost" id="wizardStep1CancelBtn">Annuler</button>
                <div class="wizard-footer-center">
                    <!-- Format badge slot moved to drop zone -->
                    <!-- Line count -->
                    <div class="import-detected-info" id="wizardStep1LineCount" style="display: none;">
                        <span class="import-count-badge" id="wizardLineCountBadge">0</span>
                        <span>lignes détectées</span>
                    </div>
                </div>
                <button class="btn btn-primary" id="wizardStep1NextBtn" disabled>
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <!-- Step 2 Footer -->
            <div class="import-wizard-footer" id="wizardStep2Footer">
                <button class="btn btn-ghost" id="wizardStep2PrevBtn">
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <div class="import-detected-info">
                    <span class="import-count-badge" id="wizardCountBadge2">0</span>
                    <span>élèves détectés</span>
                </div>
                <button class="btn btn-primary" id="wizardStep2NextBtn">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <!-- Step 3 Footer -->
            <div class="import-wizard-footer" id="wizardStep3Footer">
                <button class="btn btn-ghost" id="wizardStep3PrevBtn">
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <div class="step3-footer-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Action irréversible</span>
                </div>
                <button class="btn btn-organic btn-import-confirm" id="wizardImportOnlyBtn">
                    <i class="fas fa-check"></i> Importer <span id="wizardImportCount">0</span> élèves
                </button>
            </div>
        </div>
    </div>


    <!-- ==================================================================== -->
    <!-- IMPORT HUB MODAL - Unified entry point for adding students           -->
    <!-- ==================================================================== -->
    <div id="importHubBackdrop" class="import-hub-backdrop" role="dialog" aria-modal="true"
        aria-labelledby="importHubTitle">
        <div class="import-hub-modal">
            <button class="import-hub-close" id="importHubCloseBtn" aria-label="Fermer">
                <i class="fas fa-times"></i>
            </button>

            <div class="import-hub-header">
                <h2 class="import-hub-title" id="importHubTitle">Compléter votre classe</h2>
            </div>

            <div class="import-hub-choices">
                <!-- Individual Student Card -->
                <div class="import-hub-card" data-action="individual" tabindex="0" role="button">
                    <div class="import-hub-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h3 class="import-hub-card-title">Individuel</h3>
                    <p class="import-hub-card-desc">Saisie manuelle</p>
                </div>

                <!-- Mass Import Card -->
                <div class="import-hub-card" data-action="mass" tabindex="0" role="button">
                    <div class="import-hub-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="import-hub-card-title">Classe entière</h3>
                    <p class="import-hub-card-desc">Fichier ou copier-coller</p>
                </div>

                <!-- Photo Import Card -->
                <div class="import-hub-card" data-action="photos" tabindex="0" role="button">
                    <div class="import-hub-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                    <h3 class="import-hub-card-title">Photos</h3>
                    <p class="import-hub-card-desc">Depuis un trombinoscope</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================================================================== -->
    <!-- TROMBINOSCOPE WIZARD - Photo import from class photo                  -->
    <!-- ==================================================================== -->
    <div id="trombiWizardModal" class="trombi-wizard-modal" role="dialog" aria-modal="true">
        <div id="trombiWizardBackdrop" class="trombi-wizard-backdrop"></div>
        <div class="trombi-wizard-content">
            <div class="trombi-wizard-header">
                <div class="trombi-header-title">
                    <div class="trombi-title-pill">
                        <i class="fas fa-camera"></i>
                        <span id="trombiClassBadge"></span>
                    </div>
                </div>
                <div class="trombi-wizard-stepper">
                    <div class="trombi-wizard-step active" data-step="1">
                        <span class="step-number">1</span>
                        <span class="step-label">Image</span>
                    </div>
                    <div class="trombi-wizard-step-connector"></div>
                    <div class="trombi-wizard-step" data-step="2">
                        <span class="step-number">2</span>
                        <span class="step-label">Association</span>
                    </div>
                    <div class="trombi-wizard-step-connector"></div>
                    <div class="trombi-wizard-step" data-step="3">
                        <span class="step-number">3</span>
                        <span class="step-label">Confirmer</span>
                    </div>
                </div>
                <button class="trombi-close-btn" id="closeTrombiWizardBtn" aria-label="Fermer">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="trombi-wizard-body">
                <!-- Step 1: Upload trombinoscope image -->
                <div class="trombi-step-content" id="trombiStep1" style="display: block;">
                    <div class="trombi-drop-zone" id="trombiDropZone">
                        <!-- Placeholder content (shown when no image) -->
                        <div class="drop-zone-content" id="trombiDropPlaceholder">
                            <div class="drop-zone-icon">
                                <i class="fas fa-cloud-arrow-up"></i>
                            </div>
                            <div class="drop-zone-text">
                                <span class="drop-zone-title">Glissez ou Collez (Ctrl+V) le trombinoscope ici</span>
                                <span class="drop-zone-hint">ou <u>cliquez pour parcourir</u></span>
                            </div>
                        </div>
                        <!-- Preview content (shown when image loaded) -->
                        <div class="drop-zone-preview" id="trombiDropPreview">
                            <img src="" alt="Trombinoscope" class="drop-zone-image" id="trombiPreviewImg">
                            <div class="drop-zone-overlay">
                                <i class="fas fa-camera"></i>
                                <span>Cliquez pour changer l'image</span>
                            </div>
                        </div>
                        <button class="btn-text-action trombi-floating-sample-btn" id="trombiSampleBtn">
                            <i class="fas fa-image"></i> Exemple
                        </button>
                    </div>
                    <input type="file" id="trombiFileInput" accept="image/*" style="display: none;">
                </div>

                <!-- Step 2: Assign students to zones -->
                <div class="trombi-step-content" id="trombiStep2" style="display: none;">
                    <div class="trombi-split-view">
                        <div class="trombi-image-panel">
                            <div id="trombiImageWithZones" class="trombi-image-wrapper">
                                <!-- Image with zone overlay will be cloned here -->
                            </div>
                        </div>
                        <div class="trombi-assignment-panel">
                            <div class="trombi-assignment-panel-header">
                                <h4>Associer les élèves aux zones</h4>
                                <!-- Auto button removed - assignment is now automatic -->
                            </div>
                            <div id="trombiAssignmentGrid" class="trombi-assignment-grid">
                                <!-- Generated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Preview and confirm -->
                <div class="trombi-step-content" id="trombiStep3" style="display: none;">
                    <div id="trombiPreviewGrid" class="trombi-preview-grid">
                        <!-- Preview generated by JS -->
                    </div>
                </div>
            </div>

            <!-- FOOTERS - Ancrés en bas, hors du body scrollable -->
            <div class="trombi-step-footer" id="trombiStep1Footer">
                <button class="btn btn-ghost" id="trombiStep1CancelBtn">Annuler</button>
                <span class="trombi-footer-info" id="trombiImageInfo"></span>
                <button class="btn btn-primary" id="trombiStep1NextBtn" disabled>
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <div class="trombi-step-footer" id="trombiStep2Footer" style="display: none;">
                <button class="btn btn-ghost" id="trombiStep2PrevBtn">
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <span class="trombi-footer-info" id="trombiZonesInfo"></span>
                <button class="btn btn-primary" id="trombiStep2NextBtn">
                    Suivant <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <div class="trombi-step-footer" id="trombiStep3Footer" style="display: none;">
                <button class="btn btn-ghost" id="trombiStep3PrevBtn">
                    <i class="fas fa-arrow-left"></i> Précédent
                </button>
                <button class="btn btn-primary" id="trombiConfirmBtn">
                    <i class="fas fa-check"></i> Importer les photos
                </button>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="personalizationModal" class="modal" role="dialog" aria-modal="true"
        aria-labelledby="personalizationModalTitle">
        <div class="modal-content personalization-modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="personalizationModalTitle"><i class="fas fa-wand-magic-sparkles"></i>
                    Personnalisation</h2>
                <div class="modal-header-actions spaced">
                    <button type="button" class="btn-icon-small inspector-toggle-btn tooltip" id="toggleInspectorBtn"
                        data-tooltip="Afficher/Masquer l'inspecteur de prompt"
                        aria-label="Afficher/Masquer l'inspecteur de prompt">
                        <i class="fas fa-terminal"></i>
                    </button>
                    <button class="close-button" id="closePersonalizationModalBtn" aria-label="Fermer"><i
                            class="fas fa-xmark"></i></button>
                </div>
            </div>
            <div class="modal-body">
                <div class="settings-layout-grid personalization-grid">
                    <!-- CARTE 1: RÉGLAGES DE STYLE IA -->
                    <div class="settings-controls-column">
                        <div class="settings-card settings-card-full-height" id="settings-controls-panel">
                            <div class="settings-card-header-row">
                                <h3 class="settings-card-title" id="iaStyleHeader">
                                    <i class="fas fa-sliders-h"></i> Style de Rédaction
                                </h3>
                                <div class="toggle-switch-container tooltip"
                                    data-tooltip="Activer pour personnaliser le style de rédaction (Ton, Longueur, Voix, etc.)">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="personalizationToggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <p id="genericSubjectInfo" class="generic-info-card"
                                style="margin-top: 0; margin-bottom: 20px;">
                                <i class="fas fa-info-circle"></i>
                                Activez "Mon Style" pour modifier ces paramètres. Sinon, les réglages par défaut
                                s'appliquent.
                            </p>

                            <div class="settings-card-content">

                                <div class="form-group">
                                    <label for="iaDiscipline">Ma discipline (Optionnel)
                                        <span class="tooltip"
                                            data-tooltip="L'IA peut adapter son vocabulaire à la matière. Effet parfois prononcé : à utiliser avec discernement.">
                                            <i class="fas fa-info-circle" style="opacity: 0.6; margin-left: 4px;"></i>
                                        </span>
                                    </label>
                                    <input type="text" id="iaDiscipline"
                                        placeholder="Ex: Mathématiques, Français, Histoire-Géographie..."
                                        class="settings-input" maxlength="50">
                                </div>

                                <div class="form-group">
                                    <div class="slider-header-row">
                                        <label for="iaLengthSlider">Cible de Mots</label>
                                        <span id="iaLengthSliderValue" class="slider-value-display">~ 60 mots</span>
                                    </div>
                                    <div class="length-slider-container slider-container">
                                        <input type="range" id="iaLengthSlider" min="10" max="100" value="60" step="5">
                                        <div class="slider-labels">
                                            <span>Court</span><span>Moyen</span><span>Long</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="slider-header-row">
                                        <label for="iaToneSlider">Ton de l'appréciation</label>
                                        <span id="iaToneSliderValue" class="slider-value-display">Équilibré, factuel
                                            et
                                            neutre</span>
                                    </div>
                                    <div class="slider-container">
                                        <input type="range" id="iaToneSlider" min="1" max="5" value="3">
                                        <div class="slider-ticks">
                                            <span class="tick"></span>
                                            <span class="tick"></span>
                                            <span class="tick"></span>
                                            <span class="tick"></span>
                                            <span class="tick"></span>
                                        </div>
                                        <div class="slider-labels">
                                            <span>Positif</span><span>Équilibré</span><span>Strict</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Voix du rédacteur</label>
                                    <div class="generation-mode-selector selector-compact" id="iaVoiceSelector">
                                        <input type="radio" id="voiceDefault" name="iaVoiceRadio" value="default"
                                            checked>
                                        <label for="voiceDefault" class="tooltip"
                                            data-tooltip="Laisse l'IA choisir le pronom (Je, Nous, impersonnel...).">Défaut</label>
                                        <input type="radio" id="voiceJe" name="iaVoiceRadio" value="je">
                                        <label for="voiceJe" class="tooltip"
                                            data-tooltip="Force l'IA à utiliser la première personne du singulier ('Je').">Je</label>
                                        <input type="radio" id="voiceNous" name="iaVoiceRadio" value="nous">
                                        <label for="voiceNous" class="tooltip"
                                            data-tooltip="Force l'IA à utiliser la première personne du pluriel ('Nous'), plus formel.">Nous</label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="slider-header-row">
                                        <label for="iaStyleInstructions" style="margin-bottom: 0;">Ma "Patte"
                                            (Optionnel)</label>
                                        <div class="toggle-switch-container compact" style="margin: 0;">
                                            <label class="toggle-switch small">
                                                <input type="checkbox" id="iaStyleInstructionsToggle" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                    <textarea id="iaStyleInstructions"
                                        placeholder="Exemples : Mettre l'accent sur l'expression orale • Mentionner la rigueur du raisonnement • Ne jamais utiliser le mot performance • Toujours encourager la participation..."
                                        class="style-instructions-textarea"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CARTE 2: LABORATOIRE D'APERÇU -->
                    <div class="settings-preview-column">
                        <div class="settings-card settings-card-full-height">
                            <h3 class="settings-card-title"><i class="fas fa-vial"></i> Aperçu</h3>
                            <div class="settings-card-content">
                                <!-- Unified Data Card -->
                                <div class="preview-unified-card">
                                    <!-- Header: Student Selector -->
                                    <div class="preview-card-header">
                                        <div style="display:none!important;" aria-hidden="true">
                                            <select id="previewStudentSelect"></select>
                                        </div>
                                        <button type="button" class="nav-arrow-custom" id="previewPrevStudentBtn"
                                            aria-label="Élève précédent">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <div class="header-student-name" id="previewStudentNameDisplay">
                                            Chargement...</div>
                                        <button type="button" class="nav-arrow-custom" id="previewNextStudentBtn"
                                            aria-label="Élève suivant">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>

                                    <!-- Body: Context + Table -->
                                    <div id="settingsPreviewStudentData" class="preview-card-body">
                                    </div>
                                </div>

                                <p id="previewStatus" class="preview-status" style="display: none;"></p>

                                <!-- Section Aperçu avec bouton de génération -->
                                <div class="preview-result-header">
                                    <div class="result-ia-title">
                                        <i class="fas fa-magic"></i> Appréciation
                                    </div>
                                    <button id="refreshPreviewBtn" class="btn btn-primary btn-small tooltip"
                                        data-tooltip="Générer une appréciation avec l'IA"><i class="fas fa-play"
                                            aria-hidden="true"></i> Générer</button>
                                </div>
                                <div class="refinement-group">
                                    <div class="refinement-content" id="settingsPreviewResult">Cliquez sur
                                        "Générer" pour voir l'impact de vos réglages en direct.</div>
                                    <div class="preview-meta-container" id="previewMetaContainer"
                                        style="display: none;">
                                        <div class="preview-model-badge" id="previewModelBadge" style="display: none;">
                                            <i class="fas fa-wand-magic-sparkles"></i> —
                                        </div>
                                        <div class="word-count" id="settingsPreviewTokenCount"></div>
                                        <div class="word-count" id="settingsPreviewWordCount">0 mots • 0 car.</div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- CARTE 3: INSPECTEUR DE PROMPT (collapsible) -->
                    <div class="settings-inspector-column" id="inspectorColumn">
                        <div class="settings-card settings-card-full-height">
                            <div class="settings-card-header-row">
                                <h3 class="settings-card-title"><i class="fas fa-terminal"></i> Inspecteur de Prompt
                                </h3>
                                <button type="button" class="btn-icon-small tooltip" id="copyPromptBtn"
                                    data-tooltip="Copier le prompt" aria-label="Copier le prompt">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div class="settings-card-content">
                                <div id="settingsPreviewPrompt" class="help-code-block prompt-preview-block">
                                    Le prompt s'affichera ici après avoir rafraîchi l'aperçu.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelPersonalizationBtn">Fermer</button>
                <button class="btn btn-primary" id="savePersonalizationBtn"><i class="fas fa-check"></i>
                    Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="appSettingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="settingsModalTitle"><i class="fas fa-cog" aria-hidden="true"></i> Paramètres
                </h2>
                <button class="close-button" id="closeSettingsModalBtn" aria-label="Fermer les paramètres"><i
                        class="fas fa-xmark"></i></button>
            </div>



            <div class="modal-body">

                <!-- Templates moved to Personalization Modal -->


                <div id="advancedTabContent" class="tab-content active" role="tabpanel">

                    <!-- CARTE 1: MOTEUR IA -->
                    <div class="settings-card">
                        <div class="settings-card-header-row">
                            <h3 class="settings-card-title"><i class="fas fa-microchip"></i> Moteur d'Intelligence</h3>
                            <div class="session-cost-label tooltip"
                                data-tooltip="Tokens utilisés depuis l'ouverture de l'application (Session). Réinitialisé au rechargement."
                                style="cursor: help;">
                                Tokens : <b id="sessionTokens" class="session-cost-value">0</b>
                            </div>
                        </div>
                        <div class="settings-card-content">
                            <div id="apiStatusSummary" class="api-status-summary compact-mode">
                                <div class="api-status-header compact">
                                    <div class="model-selector-wrapper">
                                        <label for="aiModelSelect" class="sr-only">Modèle actif</label>
                                        <select id="aiModelSelect" class="compact-model-select">
                                            <optgroup label="🐱 Mistral AI — GRATUIT 🇫🇷 (1B tokens/mois)">
                                                <option value="mistral-direct-small-latest">Mistral Small 3.1
                                                    (Recommandé)
                                                </option>
                                                <option value="mistral-direct-large-latest">Mistral Large 3 (Puissant)
                                                </option>
                                            </optgroup>
                                            <optgroup label="💚 Google Gemini — QUOTA GRATUIT">
                                                <option value="gemini-3-flash-preview">Gemini 3 Flash (Rapide)
                                                </option>
                                                <option value="gemini-2.5-flash">Gemini 2.5 Flash (Stable)</option>
                                                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Équilibré)</option>
                                                <option value="gemini-3-pro">Gemini 3 Pro (Puissant)</option>
                                            </optgroup>
                                            <optgroup label="💚 OpenRouter — QUOTA GRATUIT">
                                                <option value="llama-3.3-70b-free">Llama 3.3 70B (Puissant - Journalier)
                                                </option>
                                                <option value="devstral-free">Devstral (Secours - Illimité?)</option>
                                            </optgroup>
                                            <optgroup label="💰 OpenRouter — PAYANT (économique)">
                                                <option value="claude-sonnet-4.5">Claude Sonnet 4.5 (Puissant)</option>
                                                <option value="ministral-3b">Ministral 3B (~0€, Mistral)</option>
                                                <option value="amazon-nova-v1-lite">Nova Lite v1 (Très économique)
                                                </option>
                                                <option value="openrouter">DeepSeek V3 (Économique)</option>
                                                <option value="mistral-small">Mistral Small (Français)</option>
                                                <option value="mistral-large">Mistral Large (Puissant)</option>
                                            </optgroup>
                                            <optgroup label="💰 OpenAI — PAYANT">
                                                <option value="openai-gpt-4o-mini">GPT-4o Mini (Économique)</option>
                                                <option value="openai-gpt-3.5-turbo">GPT-3.5 Turbo (Rapide)</option>
                                                <option value="openai-gpt-4o">GPT-4o (Puissant)</option>
                                            </optgroup>
                                            <optgroup label="💰 Anthropic Claude — PAYANT">
                                                <option value="anthropic-claude-sonnet-4.5">Claude Sonnet 4.5
                                                    (Puissant)</option>
                                                <option value="anthropic-claude-opus-4.5">Claude Opus 4.5 (Le plus
                                                    puissant)</option>
                                            </optgroup>
                                            <optgroup label="🏠 Ollama — LOCAL">
                                                <option value="ollama-qwen3:8b">🏠 Qwen 3 8B (Recommandé)</option>
                                                <option value="ollama-mistral">🏠 Mistral 7B (Standard)</option>
                                                <option value="ollama-deepseek-r1:8b">🏠 DeepSeek R1 (Raisonnement)
                                                </option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <button id="testAllConnectionsBtn" class="btn btn-secondary btn-icon-only tooltip"
                                        data-tooltip="Vérifier la connexion">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <div class="api-status-pills-row">
                                    <div class="status-pill inactive" id="googleApiStatus" tabindex="0"
                                        title="Non configurée">
                                        <span class="status-dot"></span> Google
                                    </div>
                                    <div class="status-pill inactive" id="openrouterApiStatus" tabindex="0"
                                        title="Non configurée">
                                        <span class="status-dot"></span> OpenRouter
                                    </div>
                                    <div class="status-pill inactive" id="openaiApiStatus" tabindex="0"
                                        title="Non configurée">
                                        <span class="status-dot"></span> OpenAI
                                    </div>
                                    <div class="status-pill inactive" id="anthropicApiStatus" tabindex="0"
                                        title="Non configurée">
                                        <span class="status-dot"></span> Claude
                                    </div>
                                    <div class="status-pill inactive" id="mistralApiStatus" tabindex="0"
                                        title="Non configurée">
                                        <span class="status-dot"></span> Mistral AI
                                    </div>
                                    <div class="status-pill inactive" id="ollamaApiStatus" tabindex="0"
                                        title="Non activé">
                                        <span class="status-dot"></span> Ollama
                                    </div>
                                </div>

                                <div class="api-fallback-row">
                                    <div class="toggle-switch-container compact">
                                        <label class="toggle-switch small">
                                            <input type="checkbox" id="enableApiFallbackToggle" checked>
                                            <span class="slider"></span>
                                        </label>
                                        <label for="enableApiFallbackToggle" class="toggle-label-text">Relais
                                            auto.</label>
                                    </div>
                                    <div class="fallback-info">
                                        <small id="fallbackOrderHint">
                                            <!-- Arrow removed -->
                                            <span id="fallbackOrderText">...</span>
                                            <span id="fallbackOrderMore" class="fallback-more-badge tooltip"
                                                style="display: none;"></span>
                                        </small>
                                    </div>
                                </div>

                                <div id="missingApiKeyWarning" class="missing-key-warning compact"
                                    style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span id="missingKeyText">Clé manquante.</span>
                                    <button type="button" class="btn-link"
                                        id="openApiKeysAccordionBtn">Configurer</button>
                                </div>

                                <small id="aiModelDescription" style="display: none;">Description du modèle
                                    sélectionné...</small>
                            </div>

                            <details class="details-accordion" id="apiKeysAccordion">
                                <summary><i class="fas fa-key"></i> Gérer mes clés API</summary>
                                <div class="details-content">
                                    <form class="details-content-inner api-keys-container" action="javascript:void(0)"
                                        autocomplete="off">
                                        <div class="api-key-section" id="googleApiKeyGroup">
                                            <div class="api-key-header">
                                                <span class="api-key-provider"><i class="fab fa-google"></i> Google
                                                    Gemini</span>
                                                <a href="https://aistudio.google.com/app/apikey" target="_blank"
                                                    rel="noopener noreferrer" class="btn-link">Obtenir une clé
                                                    (gratuit limité)</a>
                                            </div>
                                            <div class="api-key-actions">
                                                <div class="api-key-input-container">
                                                    <input type="password" id="googleApiKey" placeholder="AIzaSy..."
                                                        autocomplete="new-password">
                                                    <span id="googleApiKeyValidationIcon"
                                                        class="api-key-validation-icon"></span>
                                                </div>
                                                <button type="button" id="validateGoogleApiKeyBtn"
                                                    class="btn btn-purple btn-small">Vérifier</button>
                                            </div>
                                            <div class="error-message" id="googleApiKeyError" style="display: none;">
                                            </div>
                                        </div>

                                        <div class="api-key-section" id="openrouterApiKeyGroup">
                                            <div class="api-key-header">
                                                <span class="api-key-provider"><i class="fas fa-route"></i>
                                                    OpenRouter
                                                    (Mistral, DeepSeek...)</span>
                                                <div class="api-key-links">
                                                    <a href="https://openrouter.ai/keys" target="_blank"
                                                        rel="noopener noreferrer" class="btn-link">Obtenir une
                                                        clé (gratuit dispo.)</a>
                                                    <a href="https://openrouter.ai/credits" target="_blank"
                                                        rel="noopener noreferrer" class="btn-link btn-link-secondary"><i
                                                            class="fas fa-wallet"></i> Usage</a>
                                                </div>
                                            </div>
                                            <div class="api-key-actions">
                                                <div class="api-key-input-container">
                                                    <input type="password" id="openrouterApiKey" placeholder="sk-or-..."
                                                        autocomplete="new-password">
                                                    <span id="openrouterApiKeyValidationIcon"
                                                        class="api-key-validation-icon"></span>
                                                </div>
                                                <button type="button" id="validateOpenrouterApiKeyBtn"
                                                    class="btn btn-purple btn-small">Vérifier</button>
                                            </div>
                                            <div class="error-message" id="openrouterApiKeyError"
                                                style="display: none;">
                                            </div>
                                        </div>

                                        <div class="api-key-section" id="openaiApiKeyGroup">
                                            <div class="api-key-header">
                                                <span class="api-key-provider"><i class="fas fa-robot"></i> OpenAI
                                                    (ChatGPT)</span>
                                                <div class="api-key-links">
                                                    <a href="https://platform.openai.com/api-keys" target="_blank"
                                                        rel="noopener noreferrer" class="btn-link">Obtenir une
                                                        clé (payant)</a>
                                                    <a href="https://platform.openai.com/usage" target="_blank"
                                                        rel="noopener noreferrer" class="btn-link btn-link-secondary"><i
                                                            class="fas fa-wallet"></i> Usage</a>
                                                </div>
                                            </div>
                                            <div class="api-key-actions">
                                                <div class="api-key-input-container">
                                                    <input type="password" id="openaiApiKey" placeholder="sk-..."
                                                        autocomplete="new-password">
                                                    <span id="openaiApiKeyValidationIcon"
                                                        class="api-key-validation-icon"></span>
                                                </div>
                                                <button type="button" id="validateOpenaiApiKeyBtn"
                                                    class="btn btn-purple btn-small">Vérifier</button>
                                            </div>
                                            <div class="error-message" id="openaiApiKeyError" style="display: none;">
                                            </div>
                                        </div>

                                        <div class="api-key-section" id="anthropicApiKeyGroup">
                                            <div class="api-key-header">
                                                <span class="api-key-provider"><i class="fas fa-brain"></i> Claude
                                                    (Anthropic)</span>
                                                <div class="api-key-links">
                                                    <a href="https://console.anthropic.com/settings/keys"
                                                        target="_blank" rel="noopener noreferrer"
                                                        class="btn-link">Obtenir une
                                                        clé (payant)</a>
                                                    <a href="https://console.anthropic.com/settings/usage"
                                                        target="_blank" rel="noopener noreferrer"
                                                        class="btn-link btn-link-secondary"><i
                                                            class="fas fa-wallet"></i> Usage</a>
                                                </div>
                                            </div>
                                            <div class="api-key-actions">
                                                <div class="api-key-input-container">
                                                    <input type="password" id="anthropicApiKey" placeholder="sk-ant-..."
                                                        autocomplete="new-password">
                                                    <span id="anthropicApiKeyValidationIcon"
                                                        class="api-key-validation-icon"></span>
                                                </div>
                                                <button type="button" id="validateAnthropicApiKeyBtn"
                                                    class="btn btn-purple btn-small">Vérifier</button>
                                            </div>
                                            <div class="error-message" id="anthropicApiKeyError" style="display: none;">
                                            </div>
                                        </div>

                                        <div class="api-key-section" id="mistralApiKeyGroup">
                                            <div class="api-key-header">
                                                <span class="api-key-provider"><i class="fas fa-cat"></i> Mistral AI
                                                    (API directe)</span>
                                                <div class="api-key-links">
                                                    <a href="https://console.mistral.ai/api-keys" target="_blank"
                                                        rel="noopener noreferrer" class="btn-link">Obtenir une
                                                        clé (gratuit)</a>
                                                    <a href="https://console.mistral.ai/usage" target="_blank"
                                                        rel="noopener noreferrer" class="btn-link btn-link-secondary"><i
                                                            class="fas fa-wallet"></i> Usage</a>
                                                </div>
                                            </div>
                                            <div class="api-key-actions">
                                                <div class="api-key-input-container">
                                                    <input type="password" id="mistralApiKey"
                                                        placeholder="Clé Mistral..." autocomplete="new-password">
                                                    <span id="mistralApiKeyValidationIcon"
                                                        class="api-key-validation-icon"></span>
                                                </div>
                                                <button type="button" id="validateMistralApiKeyBtn"
                                                    class="btn btn-purple btn-small">Vérifier</button>
                                            </div>
                                            <div class="error-message" id="mistralApiKeyError" style="display: none;">
                                            </div>
                                        </div>

                                        <!-- Section Ollama (IA locale) -->
                                        <div class="api-key-section ollama-section" id="ollamaConfigGroup">
                                            <div class="api-key-header">
                                                <span class="api-key-provider"><i class="fas fa-home"></i> Ollama (IA
                                                    Locale)</span>
                                                <div style="display:flex; gap:10px; align-items:center;">
                                                    <a href="https://ollama.com" target="_blank"
                                                        rel="noopener noreferrer" class="btn-link">Installer Ollama</a>
                                                </div>
                                            </div>
                                            <div class="api-key-info">
                                                <i class="fas fa-info-circle"></i>
                                                Ollama permet d'exécuter des IA sur votre PC. <strong>Gratuit et
                                                    illimité</strong>, sans envoyer vos données sur internet.
                                            </div>
                                            <div class="api-key-actions api-key-actions-wrap">
                                                <div class="toggle-switch-container toggle-full-width">
                                                    <label class="toggle-switch">
                                                        <input type="checkbox" id="ollamaEnabledToggle">
                                                        <span class="slider"></span>
                                                    </label>
                                                    <label for="ollamaEnabledToggle" class="toggle-switch-label">Activer
                                                        Ollama</label>
                                                </div>
                                                <div class="api-key-input-container" style="flex: 1;">
                                                    <input type="text" id="ollamaBaseUrl"
                                                        placeholder="http://localhost:11434"
                                                        value="http://localhost:11434" style="font-family: monospace;">
                                                    <span id="ollamaValidationIcon"
                                                        class="api-key-validation-icon"></span>
                                                </div>
                                                <button type="button" id="validateOllamaBtn"
                                                    class="btn btn-purple btn-small">Vérifier</button>
                                            </div>
                                            <div class="error-message" id="ollamaError" style="display: none;"></div>
                                            <div id="ollamaModelsInfo"
                                                style="display: none; margin-top: 10px; font-size: 0.85em;">
                                                <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                                                <span id="ollamaModelsText">Modèles installés : ...</span>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </details>
                        </div>
                    </div>

                    <!-- CARTE 2: PRÉFÉRENCES D'AFFICHAGE -->
                    <div class="settings-card">
                        <h3 class="settings-card-title"><i class="fas fa-sliders-h"></i> Préférences</h3>
                        <div class="settings-card-content">
                            <div class="preferences-grid">
                                <!-- Mini-carte 1: Système périodique -->
                                <div class="preference-mini-card">
                                    <div class="preference-mini-card-header">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span>Système périodique</span>
                                    </div>
                                    <div class="preference-mini-card-content">
                                        <div class="generation-mode-selector period-system-selector">
                                            <input type="radio" id="periodSystemTrimestres" name="periodSystemRadio"
                                                value="trimestres" checked>
                                            <label for="periodSystemTrimestres">Trimestres</label>
                                            <input type="radio" id="periodSystemSemestres" name="periodSystemRadio"
                                                value="semestres">
                                            <label for="periodSystemSemestres">Semestres</label>
                                        </div>
                                        <small class="preference-hint">T1, T2, T3 ou S1, S2</small>
                                    </div>
                                </div>

                                <!-- Mini-carte 2: Seuils d'évolution -->
                                <div class="preference-mini-card">
                                    <div class="preference-mini-card-header">
                                        <i class="fas fa-chart-line"></i>
                                        <span>Seuils d'évolution</span>
                                    </div>
                                    <div class="preference-mini-card-content">
                                        <div class="evolution-thresholds-inline">
                                            <div class="threshold-item-compact tooltip"
                                                data-tooltip="Écart à partir duquel une hausse est significative">
                                                <label for="evolutionThresholdPositive" class="threshold-label">
                                                    <i class="fas fa-arrow-trend-up settings-evo-icon positive"></i>
                                                    <span>Progression</span>
                                                </label>
                                                <div class="number-input-wrapper">
                                                    <button type="button" class="number-spinner-btn decrement"
                                                        aria-label="Décrémenter"><i class="fas fa-minus"></i></button>
                                                    <input type="number" id="evolutionThresholdPositive" step="0.1"
                                                        min="0" value="0.5">
                                                    <button type="button" class="number-spinner-btn increment"
                                                        aria-label="Incrémenter"><i class="fas fa-plus"></i></button>
                                                </div>
                                            </div>
                                            <div class="threshold-item-compact tooltip"
                                                data-tooltip="Écart à partir duquel une baisse est significative">
                                                <label for="evolutionThresholdNegative" class="threshold-label">
                                                    <i class="fas fa-arrow-trend-down settings-evo-icon negative"></i>
                                                    <span>Recul</span>
                                                </label>
                                                <div class="number-input-wrapper">
                                                    <button type="button" class="number-spinner-btn decrement"
                                                        aria-label="Décrémenter"><i class="fas fa-minus"></i></button>
                                                    <input type="number" id="evolutionThresholdNegative" step="0.1"
                                                        max="0" value="-0.5">
                                                    <button type="button" class="number-spinner-btn increment"
                                                        aria-label="Incrémenter"><i class="fas fa-plus"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                        <small class="preference-hint">En points de moyenne</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CARTE CONFIDENTIALITÉ -->
                    <div class="settings-card">
                        <h3 class="settings-card-title"><i class="fas fa-user-secret"></i> Confidentialité</h3>
                        <div class="settings-card-content">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4 class="setting-subtitle">Anonymisation renforcée</h4>
                                    <div class="privacy-description-wrapper">
                                        <div class="privacy-option">
                                            <span class="option-label">Activé :</span>
                                            <span class="option-desc">Remplace le prénom par un placeholder.</span>
                                            <span class="privacy-warning-badge" title="Peut causer des répétitions">
                                                <i class="fas fa-exclamation-triangle"></i> Rédaction moins fluide
                                            </span>
                                        </div>
                                        <div class="privacy-option">
                                            <span class="option-label">Désactivé :</span>
                                            <span class="option-desc">Utilise le vrai prénom pour un texte plus
                                                naturel.</span>
                                        </div>
                                        <div class="privacy-footer-note">
                                            <i class="fas fa-shield-alt"></i> Le nom de famille n'est
                                            <strong>jamais</strong> transmis à l'IA.
                                        </div>
                                    </div>
                                </div>
                                <div class="toggle-switch-container">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="settingsPrivacyAnonymizeToggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CARTE 3: GESTION DES DONNÉES -->
                    <div class="settings-card">
                        <h3 class="settings-card-title"><i class="fas fa-database"></i> Système & Données</h3>
                        <div class="settings-card-content">
                            <!-- Section Sauvegarde Complète -->
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4 class="setting-subtitle"><i class="fas fa-cloud-arrow-down"></i> Sauvegarde
                                        complète</h4>
                                    <p class="setting-description">Exportez toutes vos données (élèves, appréciations,
                                        classes) pour les restaurer sur un autre appareil ou en cas de problème.</p>
                                </div>
                                <div class="setting-actions-group">
                                    <button class="btn btn-primary btn-small" id="exportFullBackupBtn">
                                        <i class="fas fa-download"></i> Exporter
                                    </button>
                                    <button class="btn btn-secondary btn-small" id="importFullBackupBtn">
                                        <i class="fas fa-upload"></i> Restaurer
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="importBackupInput" accept=".json" style="display: none;">

                            <div class="settings-divider-light"></div>

                            <!-- Section Paramètres seuls -->
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4 class="setting-subtitle"><i class="fas fa-sliders-h"></i> Paramètres uniquement
                                    </h4>
                                    <p class="setting-description">Exportez seulement la configuration (styles,
                                        matières) sans les données d'élèves.</p>
                                </div>
                                <div class="setting-actions-group">
                                    <button class="btn btn-secondary btn-small" id="exportSettingsBtn">
                                        <i class="fas fa-file-export"></i> Exporter
                                    </button>
                                    <button class="btn btn-secondary btn-small" id="importSettingsBtn">
                                        <i class="fas fa-file-import"></i> Importer
                                    </button>
                                </div>
                            </div>

                            <div class="settings-divider-light"></div>

                            <!-- Section Cloud Save/Load -->
                            <div class="setting-row setting-row-column" id="cloudSyncSection">
                                <div class="setting-info setting-info-full">
                                    <h4 class="setting-subtitle"><i class="fas fa-cloud"></i> Sauvegarde Cloud</h4>
                                    <p class="setting-description">
                                        Sauvegardez ou restaurez vos données via Google Drive.
                                    </p>
                                </div>

                                <!-- Provider Selection -->
                                <div class="sync-providers">
                                    <div class="sync-provider-card" data-provider="google">
                                        <div class="provider-icon"><i class="fab fa-google-drive"></i></div>
                                        <div class="provider-info">
                                            <span class="provider-name">Google Drive</span>
                                            <span class="provider-status" id="googleSyncStatus">Non connecté</span>
                                            <span class="provider-email" id="googleSyncEmail"
                                                style="display: none; font-size: 0.8em; color: var(--text-secondary);"></span>
                                        </div>
                                        <div class="provider-actions" style="display: flex; gap: 8px;">
                                            <button class="btn btn-secondary btn-small" id="connectGoogleBtn">
                                                Connecter
                                            </button>
                                            <button class="btn btn-danger btn-small" id="disconnectGoogleBtn"
                                                style="display: none;">
                                                <i class="fas fa-sign-out-alt"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="sync-provider-card" data-provider="dropbox"
                                        style="opacity: 0.5; pointer-events: none;">
                                        <div class="provider-icon"><i class="fab fa-dropbox"></i></div>
                                        <div class="provider-info">
                                            <span class="provider-name">Dropbox</span>
                                            <span class="provider-status" id="dropboxSyncStatus">Bientôt
                                                disponible</span>
                                        </div>
                                        <button class="btn btn-secondary btn-small" id="connectDropboxBtn" disabled>
                                            Connecter
                                        </button>
                                    </div>
                                </div>

                                <!-- Save/Load Actions (visible when connected) -->
                                <div class="cloud-actions-bar" id="cloudActionsBar" style="display: none;">
                                    <button class="btn btn-primary btn-small" id="cloudSaveBtn">
                                        <i class="fas fa-cloud-arrow-up"></i> Sauvegarder
                                    </button>
                                    <button class="btn btn-secondary btn-small" id="cloudLoadBtn">
                                        <i class="fas fa-cloud-arrow-down"></i> Charger
                                    </button>
                                    <span class="cloud-last-save" id="cloudLastSave"></span>
                                </div>

                                <!-- RGPD Warning (always visible) -->
                                <div class="sync-rgpd-warning" id="syncRgpdWarning">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>En activant la sauvegarde cloud, vos données seront stockées sur le service
                                        choisi. Vous êtes responsable du respect des réglementations applicables
                                        (RGPD).</span>
                                </div>
                            </div>

                            <div class="settings-divider"></div>

                            <!-- Section Application Update -->
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4 class="setting-subtitle"><i class="fas fa-sync-alt"></i> Mises à jour</h4>
                                    <p class="setting-description">Vérifiez si une nouvelle version de l'application est
                                        disponible.</p>
                                </div>
                                <div class="setting-actions-group">
                                    <button class="btn btn-secondary btn-small" id="checkUpdatesBtn">
                                        <i class="fas fa-rotate"></i> Vérifier
                                    </button>
                                </div>
                            </div>

                            <div class="settings-divider"></div>

                            <!-- Section Zone de Danger -->
                            <div class="danger-zone-details">
                                <details class="details-accordion danger-accordion">
                                    <summary><i class="fas fa-exclamation-triangle"></i> Zone de Danger</summary>
                                    <div class="details-content">
                                        <div class="details-content-inner">
                                            <div class="danger-action-row">
                                                <div class="danger-info">
                                                    <strong>Réinitialiser les paramètres</strong>
                                                    <span>Remet les paramètres par défaut (clés API, matières). Vos
                                                        classes et élèves sont conservés.</span>
                                                </div>
                                                <button class="btn btn-secondary btn-small" id="resetAllSettingsBtn">
                                                    Réinitialiser
                                                </button>
                                            </div>
                                            <div class="danger-action-row" style="margin-top: 12px;">
                                                <div class="danger-info">
                                                    <strong style="color: var(--error-color);">Supprimer toutes les
                                                        données</strong>
                                                    <span>Efface TOUT : classes, élèves, appréciations, paramètres.
                                                        Irréversible.</span>
                                                </div>
                                                <button class="btn btn-danger btn-small" id="factoryResetBtn">
                                                    Tout supprimer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>

                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSettingsBtn" tabindex="0">Annuler</button>
                <button class="btn" id="saveSettingsBtn" tabindex="0"><i class="fas fa-check"></i>
                    Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="importPreviewModal" class="modal" role="dialog" aria-modal="true"
        aria-labelledby="importPreviewModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="importPreviewModalTitle"><i class="fas fa-tasks"></i> Configurer
                    et
                    prévisualiser l'import</h2>
                <button class="close-button" id="closeImportPreviewModalBtn" aria-label="Fermer la prévisualisation"><i
                        class="fas fa-xmark"></i></button>
            </div>
            <div class="modal-body">

                <div id="import-summary-text" class="generic-info-box"></div>
                <div id="importSavedFormatInfo" class="generic-info-box"
                    style="display: none; justify-content: space-between; align-items: center;"></div>

                <details class="details-accordion" style="margin-bottom: 25px;">
                    <summary><i class="fas fa-cogs"></i> Ajuster le mappage des colonnes</summary>
                    <div class="details-content">
                        <div class="details-content-inner">
                            <p style="margin-top:0; font-size:0.9em; color:var(--summary-details-color);">
                                Vérifiez que
                                chaque colonne de vos données est correctement associée à un champ.
                                L'application essaie
                                de deviner le format, mais vous pouvez l'ajuster ici.</p>
                            <div class="form-group-inline" style="margin-bottom: 20px;">
                                <label for="separatorSelect" style="margin-bottom: 0;">Séparateur&nbsp;:</label>
                                <select id="separatorSelect">
                                    <option value="tab">Tabulation</option>
                                    <option value=",">Virgule (,)</option>
                                    <option value=";">Point-virgule (;)</option>
                                    <option value="|">Barre verticale (|)</option>
                                    <option value="custom">Autre...</option>
                                </select>
                                <input type="text" id="customSeparatorInput" style="display: none; width: 80px;"
                                    maxlength="1" placeholder="Caractère">
                            </div>

                            <div class="mapping-table-container" style="overflow-x: auto;">
                                <table class="mapping-preview-table">
                                    <thead id="mappingHeaders"></thead>
                                    <tbody id="mappingPreviewData"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </details>

                <div id="import-strategy-container" class="import-strategy-container"
                    style="display: none; margin-bottom: 25px;">
                    <div class="generation-mode-selector selector-compact">
                        <input type="radio" id="strategyMerge" name="importStrategy" value="merge" checked>
                        <label for="strategyMerge" class="tooltip"
                            data-tooltip="Ajoute les nouveaux, met à jour les existants et marque les absents. Recommandé.">Mettre
                            à jour (Fusionner)</label>
                        <input type="radio" id="strategyReplace" name="importStrategy" value="replace">
                        <label for="strategyReplace" class="tooltip"
                            data-tooltip="Supprime tous les élèves actuels et les remplace par ceux de cet import.">Remplacer
                            toute la liste</label>
                    </div>
                </div>

                <div id="import-preview-container">
                    <div class="import-preview-grid">
                        <div id="import-preview-new-col" class="import-preview-column import-preview-new">
                            <div class="column-header">
                                <h4><i class="fas fa-user-plus"></i> Nouveaux <span id="new-count"
                                        class="count-badge">0</span></h4>
                            </div>
                            <ul id="new-students-list" class="import-preview-list"></ul>
                        </div>
                        <div id="import-preview-updated-col" class="import-preview-column import-preview-updated">
                            <div class="column-header">
                                <h4><i class="fas fa-user-edit"></i> Mis à jour <span id="updated-count"
                                        class="count-badge">0</span></h4>
                            </div>
                            <ul id="updated-students-list" class="import-preview-list"></ul>
                        </div>
                        <div id="import-preview-departed-col" class="import-preview-column import-preview-departed">
                            <div class="column-header">
                                <h4><i class="fas fa-user-minus"></i> Départs <span id="departed-count"
                                        class="count-badge">0</span></h4>
                            </div>
                            <ul id="departed-students-list" class="import-preview-list"></ul>
                        </div>
                    </div>
                    <div id="import-preview-replace-warning" class="api-key-warning"
                        style="display: none; border-color: var(--error-color); background-color: rgba(239, 68, 68, 0.08);">
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <div class="form-group-inline" style="margin-right: auto;">
                    <input type="checkbox" id="saveMappingCheckbox" style="width: auto;">
                    <label for="saveMappingCheckbox" style="margin-bottom: 0; font-size: 0.9em;">Mémoriser
                        ce
                        format de
                        colonnes</label>
                </div>
                <button class="btn btn-secondary" id="cancelImportPreviewBtn">Annuler</button>
                <button class="btn btn-primary" id="importOnlyBtn">
                    <i class="fas fa-download"></i> Importer les données
                </button>
            </div>
        </div>
    </div>



    <!-- Refinement Modal removed - Focus Panel handles all refinement with inline buttons -->

    <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="modal-title-icon"><i class="fas fa-circle-question" aria-hidden="true"></i></span>
                    <span class="modal-title-text">Guide de l'application</span>
                </h2>
                <button class="close-button" id="closeHelpModalBtn" aria-label="Fermer l'aide"><i
                        class="fas fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-tabs-layout">
                    <!-- Sidebar Navigation -->
                    <div class="modal-tabs-sidebar">
                        <button class="modal-tab-btn active" onclick="switchHelpTab(this, 'help-apikey')">
                            <i class="fas fa-key icon-key"></i> Connecter l'IA
                        </button>
                        <button class="modal-tab-btn" onclick="switchHelpTab(this, 'help-import')">
                            <i class="fas fa-file-import icon-format"></i> Importer
                        </button>
                        <button class="modal-tab-btn" onclick="switchHelpTab(this, 'help-style')">
                            <i class="fas fa-sliders-h icon-customize"></i> Personnaliser
                        </button>
                        <button class="modal-tab-btn" onclick="switchHelpTab(this, 'help-actions')">
                            <i class="fas fa-wand-magic-sparkles icon-actions"></i> Commandes IA
                        </button>
                        <button class="modal-tab-btn" onclick="switchHelpTab(this, 'help-privacy')">
                            <i class="fas fa-shield-halved icon-privacy"></i> Confidentialité
                        </button>
                        <button class="modal-tab-btn" onclick="switchHelpTab(this, 'help-about')">
                            <i class="fas fa-info-circle icon-about"></i> À propos
                        </button>

                        <!-- Bottom Action Button -->
                        <div style="margin-top: auto; padding-top: 10px; width: 100%;">
                            <button class="sidebar-action-btn" onclick="relaunchSetupWizard()">
                                <i class="fas fa-redo-alt"></i> Relancer setup
                            </button>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="modal-tabs-content-area">
                        <!-- Tab 1: Connecter l'IA -->
                        <!-- Tab 1: Connecter l'IA -->
                        <div id="help-apikey" class="help-tab-content active">
                            <div class="help-section-header" style="text-align: center; margin-bottom: 25px;">
                                <p style="margin-bottom: 15px; color: var(--text-secondary);">
                                    L'application a besoin d'un "cerveau" IA. Choisissez votre fournisseur pour voir la
                                    marche à suivre.
                                </p>
                                <div class="provider-selector-compact" id="helpProviderSelector"
                                    style="margin: 0 auto;">
                                    <input type="radio" id="helpProviderMistral" name="helpProvider" value="mistral"
                                        checked>
                                    <label for="helpProviderMistral">
                                        <i class="fas fa-cat"></i>
                                        <span>Mistral <small class="provider-tag">🇫🇷</small></span>
                                    </label>
                                    <input type="radio" id="helpProviderGoogle" name="helpProvider" value="google">
                                    <label for="helpProviderGoogle">
                                        <i class="fab fa-google"></i>
                                        <span>Google</span>
                                    </label>
                                    <input type="radio" id="helpProviderOpenRouter" name="helpProvider"
                                        value="openrouter">
                                    <label for="helpProviderOpenRouter">
                                        <i class="fas fa-bolt"></i>
                                        <span>OpenRouter</span>
                                    </label>
                                    <div class="selector-glider"></div>
                                </div>
                            </div>

                            <!-- MISTRAL CONTENT (Default) -->
                            <div id="helpContentMistral" class="provider-help-content">
                                <p><strong>Mistral AI</strong> est une solution française, performante et
                                    <strong>gratuite</strong> (1 milliard de tokens/mois).
                                </p>

                                <div class="help-step-card">
                                    <div style="display: flex; gap: 10px;">
                                        <div class="help-step-number">1</div>
                                        <div style="flex: 1;">
                                            <strong>Récupérer votre clé (Gratuit)</strong>
                                            <p style="margin: 5px 0 10px 0; font-size: 0.9em;">Créez un compte sur
                                                Mistral AI et générez votre clé API.</p>
                                            <a href="https://console.mistral.ai/api-keys/" target="_blank"
                                                rel="noopener noreferrer" class="btn btn-secondary btn-small"
                                                style="width: 100%; justify-content: center; margin-top: 5px;">
                                                <i class="fas fa-external-link-alt" style="margin-right:8px"></i> Ouvrir
                                                Mistral Console
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="help-step-card">
                                    <div style="display: flex; gap: 10px;">
                                        <div class="help-step-number">2</div>
                                        <div style="flex: 1;">
                                            <strong>Copier / Coller</strong>
                                            <p style="margin: 5px 0 0 0; font-size: 0.9em;">
                                                Copiez la clé générée et collez-la dans les <a href="#"
                                                    class="link-to-settings btn-link" data-target-tab="advanced"
                                                    data-target-element="mistralApiKey">Paramètres</a>.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- GOOGLE CONTENT -->
                            <div id="helpContentGoogle" class="provider-help-content" style="display: none;">
                                <p><strong>Google Gemini</strong> est une alternative gratuite et très performante.</p>

                                <div class="help-step-card">
                                    <div style="display: flex; gap: 10px;">
                                        <div class="help-step-number">1</div>
                                        <div style="flex: 1;">
                                            <strong>Créer une clé API</strong>
                                            <p style="margin: 5px 0 10px 0; font-size: 0.9em;">Connectez-vous avec votre
                                                compte Google et cliquez sur "Create API key".</p>
                                            <a href="https://aistudio.google.com/app/apikey" target="_blank"
                                                rel="noopener noreferrer" class="btn btn-secondary btn-small"
                                                style="width: 100%; justify-content: center; margin-top: 5px;">
                                                <i class="fas fa-external-link-alt" style="margin-right:8px"></i> Ouvrir
                                                Google AI Studio
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="help-step-card">
                                    <div style="display: flex; gap: 10px;">
                                        <div class="help-step-number">2</div>
                                        <div style="flex: 1;">
                                            <strong>Copier / Coller</strong>
                                            <p style="margin: 5px 0 0 0; font-size: 0.9em;">
                                                Copiez la clé et collez-la dans les <a href="#"
                                                    class="link-to-settings btn-link" data-target-tab="advanced"
                                                    data-target-element="googleApiKey">Paramètres</a> section Google.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- OPENROUTER CONTENT -->
                            <div id="helpContentOpenRouter" class="provider-help-content" style="display: none;">
                                <p><strong>OpenRouter</strong> est une passerelle unifiée donnant accès à tous les
                                    meilleurs modèles (DeepSeek, Claude, GPT-4, Llama 3...).</p>

                                <ul
                                    style="background: var(--card-bg-secondary); padding: 15px 15px 15px 35px; border-radius: 8px; font-size: 0.9em; margin: 15px 0;">
                                    <li>Accès centralisé à +100 modèles</li>
                                    <li>Tarification à l'usage (souvent moins cher)</li>
                                    <li>Modèles "Free" disponibles (parfois limités)</li>
                                </ul>

                                <div class="help-step-card">
                                    <div style="display: flex; gap: 10px;">
                                        <div class="help-step-number">1</div>
                                        <div style="flex: 1;">
                                            <strong>Obtenir une clé</strong>
                                            <a href="https://openrouter.ai/keys" target="_blank"
                                                rel="noopener noreferrer" class="btn btn-secondary btn-small"
                                                style="width: 100%; justify-content: center; margin-top: 10px;">
                                                <i class="fas fa-external-link-alt" style="margin-right:8px"></i> Site
                                                OpenRouter
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <div class="help-step-card">
                                    <div style="display: flex; gap: 10px;">
                                        <div class="help-step-number">2</div>
                                        <div style="flex: 1;">
                                            <strong>Configurer</strong>
                                            <p style="margin: 5px 0 0 0; font-size: 0.9em;">
                                                Collez la clé dans les <a href="#" class="link-to-settings btn-link"
                                                    data-target-tab="advanced"
                                                    data-target-element="openrouterApiKey">Paramètres</a> section
                                                OpenRouter.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Common Footer -->
                            <div class="help-tip-box"
                                style="margin-top: 25px; font-size: 0.9em; color: var(--text-secondary); display: flex; gap: 10px; align-items: flex-start; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                <i class="fas fa-rotate" style="color: var(--accent-color); margin-top: 2px;"></i>
                                <span><strong>Relais automatique :</strong> Si le modèle échoue, l'app peut basculer
                                    vers un autre. Activable dans les <a href="#" class="link-to-settings btn-link"
                                        data-target-tab="advanced">Paramètres avancés</a>.</span>
                            </div>
                        </div>

                        <!-- Tab 2: Importer -->
                        <div id="help-import" class="help-tab-content">
                            <p>Vous avez deux options :</p>
                            <ul style="margin-top: 5px; margin-bottom: 20px; padding-left: 20px;">
                                <li style="margin-bottom: 5px;"><strong>Mode Unitaire :</strong> Saisissez les notes
                                    d'un élève à la main pour tester.</li>
                                <li><strong>Import en Masse (Recommandé) :</strong> Copiez-collez directement depuis
                                    Excel, Pronote ou un fichier CSV.</li>
                            </ul>

                            <div
                                style="background: var(--card-glass-bg); padding: 15px; border-radius: var(--radius-lg); border: 1px solid var(--card-glass-border);">
                                <p style="font-weight: 600; font-size: 0.9em; margin-top: 0;">Structure idéale pour
                                    l'import :</p>
                                <div class="help-code-block" id="helpFormatStructure" style="margin-bottom: 15px;">
                                </div>

                                <p style="font-weight: 600; font-size: 0.9em;">Exemple concret :</p>
                                <div class="help-code-block" id="helpFormatExample"></div>
                                <div class="help-format-selector" id="helpFormatSelector" style="margin-top: 10px;">
                                </div>
                            </div>

                            <div class="help-tip-box"
                                style="margin-top: 15px; font-size: 0.9em; color: var(--text-secondary); display: flex; gap: 10px; align-items: center;">
                                <i class="fas fa-lightbulb" style="color: var(--accent-color); font-size: 1.2em;"></i>
                                <span>L'application détecte automatiquement les colonnes. Si besoin, vous pourrez
                                    ajuster le "mappage" (quelle colonne correspond à quoi) avant de valider.</span>
                            </div>
                        </div>

                        <!-- Tab 3: Style -->
                        <div id="help-style" class="help-tab-content">
                            <p>L'IA s'adapte à votre style d'écriture via les <strong>Paramètres</strong> :</p>
                            <ul style="margin-top: 5px; padding-left: 20px; margin-bottom: 15px;">
                                <li style="margin-bottom: 8px;"><strong>Ton et Longueur :</strong> Strict ou
                                    encourageant ? Concis ou détaillé ?</li>
                                <li><strong>"Ma Patte" :</strong> Donnez des consignes directes (ex: <em>"Ne jamais
                                        utiliser le mot 'bavard'"</em>, <em>"Toujours mentionner l'effort"</em>).</li>
                            </ul>
                            <p style="margin-top: 10px; font-size: 0.9em;">
                                Utilisez le bouton <strong><i class="fas fa-flask"></i> Aperçu</strong> dans les
                                paramètres pour tester vos réglages en temps réel sans modifier vos vrais bulletins.
                            </p>
                            <button class="btn btn-secondary help-action-button" id="helpToPersonalizationBtn"
                                style="margin-top: 15px;"><i class="fas fa-sliders-h" aria-hidden="true"></i> Accéder à
                                la personnalisation</button>
                        </div>

                        <!-- Tab: Actions IA (New) -->
                        <div id="help-actions" class="help-tab-content">
                            <div class="help-intro-text">
                                <p>Instructions envoyées à l'IA pour chaque bouton.</p>
                            </div>

                            <table class="help-table">
                                <thead>
                                    <tr>
                                        <th style="width: 140px;">Bouton</th>
                                        <th style="width: 120px;">Action</th>
                                        <th>Prompt Système</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="help-btn-badge">
                                                <i class="fas fa-compress-alt"></i> Concise
                                            </div>
                                        </td>
                                        <td>Réduire (~20%)</td>
                                        <td class="prompt-cell">"Rends cette appréciation plus concise, environ
                                            <strong>[Mots * 0.8]</strong> mots. Garde l'essentiel."
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="help-btn-badge">
                                                <i class="fas fa-expand-alt"></i> Détaillée
                                            </div>
                                        </td>
                                        <td>Développer (~20%)</td>
                                        <td class="prompt-cell">"Développe les points, environ <strong>[Mots *
                                                1.2]</strong> mots. N'invente pas de faits."</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="help-btn-badge">
                                                <i class="fas fa-heart"></i> Encourageante
                                            </div>
                                        </td>
                                        <td>Ton positif</td>
                                        <td class="prompt-cell">"Reformule avec un ton plus encourageant et positif.
                                            Garde la même longueur."</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="help-btn-badge">
                                                <i class="fas fa-sync-alt"></i> Variation
                                            </div>
                                        </td>
                                        <td>Reformuler</td>
                                        <td class="prompt-cell">"Reformule différemment (vocabulaire, structure) mais
                                            garde le même sens et la même longueur."</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="help-btn-badge rainbow-border">
                                                <i class="fas fa-wand-magic"></i> Peaufiner
                                            </div>
                                        </td>
                                        <td>Correction Pro</td>
                                        <td class="prompt-cell">"Peaufine : corrige fautes, améliore fluidité, adopte un
                                            ton pro. Garde sens et longueur."</td>
                                    </tr>
                                </tbody>
                            </table>

                            <div class="help-tip-box" style="margin-top: 20px;">
                                <i class="fas fa-terminal"></i>
                                <span><strong>Note technique :</strong> Toutes ces commandes finissent par l'instruction
                                    : <em>"Réponds uniquement avec le texte brut. Aucune introduction, aucun
                                        commentaire."</em></span>
                            </div>

                            <div class="help-tip-box"
                                style="margin-top: 10px; border-left: 3px solid var(--accent-color);">
                                <i class="fas fa-eye" style="color: var(--accent-color);"></i>
                                <span><strong>Astuce curieux :</strong> Faites un <strong>Clic Droit</strong> sur le
                                    bouton <em>Générer</em> (dans le panneau élève) pour prévisualiser le prompt complet
                                    envoyé à l'IA.</span>
                            </div>
                        </div>

                        <!-- Tab 4: Confidentialité -->
                        <div id="help-privacy" class="help-tab-content">
                            <div
                                style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: var(--radius-lg); border: 1px solid rgba(16, 185, 129, 0.2);">
                                <i class="fas fa-lock" style="font-size: 1.5em; color: var(--success-color);"></i>
                                <div>
                                    <strong style="color: var(--success-color);">Vos données, votre contrôle.</strong>
                                    <div style="font-size: 0.9em; opacity: 0.9;">Par défaut, stockage local uniquement —
                                        vos données restent sur votre appareil.</div>
                                </div>
                            </div>
                            <p style="font-size: 0.9em;">
                                L'IA externe (Google/OpenRouter) reçoit uniquement les données
                                <strong>anonymisées</strong> nécessaires à la rédaction. Leur traitement ultérieur
                                dépend des conditions d'utilisation de ces services tiers.
                            </p>
                        </div>

                        <!-- Tab 5: À propos -->
                        <div id="help-about" class="help-tab-content">
                            <div class="about-header">
                                <div class="about-header-main">
                                    <img src="assets/logo.png" alt="Bulletin AI" class="about-logo">
                                    <div class="about-title-group">
                                        <h3>Bulletin AI</h3>
                                        <div class="about-version">v0.1.0 Beta</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <a id="linkGithub" href="#" target="_blank" rel="noopener noreferrer"
                                        class="btn btn-secondary btn-small">
                                        <i class="fab fa-github"></i> GitHub
                                    </a>
                                    <a id="linkFeedback" href="#" target="_blank" rel="noopener noreferrer"
                                        class="btn btn-secondary btn-small">
                                        <i class="fas fa-comment-dots"></i> Avis
                                    </a>
                                </div>
                            </div>

                            <div class="about-content">
                                <p class="about-tagline">L'assistant intelligent conçu pour simplifier la rédaction de
                                    vos appréciations scolaires.</p>

                                <!-- Donation Section (Refined) -->
                                <div class="support-card-premium">
                                    <h4>
                                        <i class="fas fa-heart" style="color: #FF5E5B;"></i> Soutenir le projet
                                    </h4>
                                    <p>
                                        Cette application est gratuite. Si elle vous est utile, vous pouvez encourager
                                        son
                                        développement en m'offrant un café !
                                    </p>
                                    <a id="linkKofi" href="#" target="_blank" rel="noopener noreferrer"
                                        class="btn btn-kofi">
                                        <i class="fas fa-coffee"></i> Soutenir sur Ko-fi
                                    </a>
                                </div>

                                <div class="about-footer">
                                    <p>Développé pour les enseignants par David Trafial</p>
                                    <p>© 2025 Bulletin AI - Tous droits réservés</p>
                                    <p style="margin-top: 5px; font-size: 0.9em; opacity: 0.7;">Sous licence <a
                                            id="linkLicense" href="#" target="_blank"
                                            style="color: inherit; text-decoration: underline;">Creative Commons
                                            BY-NC-SA 4.0</a></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeHelpModalFooterBtn" tabindex="0">Fermer</button>
            </div>
        </div>
    </div>


    <div id="welcomeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="welcomeModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="welcomeModalTitle">🎉 Bienvenue dans Bulletin AI !</h2>
                <button class="close-button" id="closeWelcomeModalBtn" aria-label="Fermer">
                    <i class="fas fa-xmark"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="welcome-step-1" class="welcome-step active">
                    <div class="welcome-icon">🚀</div>
                    <h3>Gagnez du temps sur vos bulletins</h3>
                    <p class="welcome-subtitle">L'assistant intelligent qui rédige des appréciations
                        personnalisées et
                        pertinentes pour chacun de vos élèves.</p>

                    <div class="welcome-features-list">
                        <div class="welcome-feature">
                            <span class="feature-icon">✨</span>
                            <span class="feature-text"><strong>Unique & Varié</strong><br>Plus de
                                répétitions
                                robotiques.</span>
                        </div>
                        <div class="welcome-feature">
                            <span class="feature-icon">⚡</span>
                            <span class="feature-text"><strong>Ultra Rapide</strong><br>Une classe
                                entière en quelques
                                minutes.</span>
                        </div>
                        <div class="welcome-feature">
                            <span class="feature-icon">🔒</span>
                            <span class="feature-text"><strong>Privé & Sécurisé</strong><br>Vos données
                                restent sous
                                contrôle.</span>
                        </div>
                    </div>

                    <p style="margin-top: 25px; font-size: 0.9em; color: var(--text-secondary); opacity: 0.8;">
                        Commençons par configurer votre environnement.
                    </p>
                </div>
                <div id="welcome-step-2" class="welcome-step">


                    <div class="welcome-split-layout">
                        <!-- Left Column: Context & Info -->
                        <div class="welcome-split-info">
                            <div class="welcome-header-row">
                                <span class="welcome-icon-small wave-animation">🔑</span>
                                <h3>Activez votre Assistant</h3>
                            </div>
                            <p class="welcome-subtitle-left">
                                L'application a besoin d'une connexion IA.<br>
                                Chaque option propose un accès gratuit.
                            </p>

                            <div class="security-note-left">
                                <i class="fas fa-shield-alt"></i>
                                <span>Noms anonymisés • Stockage local</span>
                            </div>
                        </div>

                        <!-- Right Column: Actions -->
                        <div class="welcome-split-action">

                            <!-- Provider Selector - Centré -->
                            <div class="provider-selector-row">
                                <div class="provider-selector-compact" id="welcomeProviderSelector">
                                    <input type="radio" id="providerMistral" name="welcomeProvider" value="mistral"
                                        checked>
                                    <label for="providerMistral">
                                        <i class="fas fa-cat"></i>
                                        <span>Mistral <small class="provider-tag">🇫🇷</small></span>
                                    </label>
                                    <input type="radio" id="providerGoogle" name="welcomeProvider" value="google">
                                    <label for="providerGoogle">
                                        <i class="fab fa-google"></i>
                                        <span>Google</span>
                                    </label>
                                    <input type="radio" id="providerOpenRouter" name="welcomeProvider"
                                        value="openrouter">
                                    <label for="providerOpenRouter">
                                        <i class="fas fa-bolt"></i>
                                        <span>OpenRouter</span>
                                    </label>
                                </div>
                            </div>

                            <!-- API Key Input -->
                            <div class="welcome-api-key-group">
                                <input type="password" id="welcomeApiKeyInput"
                                    placeholder="Collez votre clé API Mistral ici...">
                                <button class="btn btn-validate-key" id="welcomeValidateApiKeyBtn">Valider</button>
                            </div>
                            <div class="error-message" id="welcomeApiKeyError"
                                style="display: none; justify-content: flex-start; margin-bottom: 10px; font-size: 0.9em;">
                            </div>

                            <!-- Action Links Row -->
                            <div class="welcome-action-links">
                                <a href="https://console.mistral.ai/api-keys/" target="_blank" rel="noopener noreferrer"
                                    class="get-key-link-mini" id="welcomeGetKeyLink"><i class="fas fa-cat"></i> Obtenir
                                    ma clé</a>
                                <span class="action-separator">•</span>
                                <button class="btn-text-link-compact" id="welcomeSkipApiKeyBtn">
                                    Continuer sans clé
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="welcome-step-3" class="welcome-step">
                    <div class="welcome-icon-small" style="text-align: center; margin-bottom: 15px;">🗓️
                    </div>
                    <h3>Votre rythme scolaire</h3>
                    <p class="welcome-subtitle">Ce paramètre calibre l'IA pour qu'elle s'adapte à votre
                        organisation.
                    </p>

                    <div class="period-card-selector">
                        <label class="period-card" for="welcomePeriodSystemTrimestres">
                            <input type="radio" id="welcomePeriodSystemTrimestres" name="welcomePeriodSystemRadio"
                                value="trimestres" checked>
                            <div class="period-card-content">
                                <div class="period-card-icon">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <div class="period-card-text">
                                    <span class="period-card-title">Trimestres</span>
                                    <span class="period-card-desc">3 périodes par an (Automne, Hiver,
                                        Printemps)</span>
                                </div>
                            </div>
                        </label>
                        <label class="period-card" for="welcomePeriodSystemSemestres">
                            <input type="radio" id="welcomePeriodSystemSemestres" name="welcomePeriodSystemRadio"
                                value="semestres">
                            <div class="period-card-content">
                                <div class="period-card-icon">
                                    <i class="fas fa-circle-half-stroke"></i>
                                </div>
                                <div class="period-card-text">
                                    <span class="period-card-title">Semestres</span>
                                    <span class="period-card-desc">2 périodes par an (Automne,
                                        Printemps)</span>
                                </div>
                            </div>
                        </label>
                    </div>

                    <p class="welcome-hint">Vous pourrez modifier ce paramètre à tout moment dans les
                        réglages.</p>
                </div>
                <div id="welcome-step-4" class="welcome-step">
                    <!-- Illustration Area -->
                    <!-- Transformation Illustration -->
                    <div class="welcome-transformation-svg">
                        <object type="image/svg+xml" data="./welcome-transformation.svg">
                            Illustration de transformation IA
                        </object>
                    </div>


                    <h3>Prêt à commencer !</h3>
                    <p class="welcome-subtitle">Tout est configuré. Voyez l'IA en action sur des données
                        d'exemple.</p>

                    <button class="btn btn-organic btn-organic--rounded btn-cta-full" id="welcomeLoadSampleBtn">
                        <i class="fas fa-wand-magic-sparkles" aria-hidden="true"></i>
                        Charger et Générer un exemple
                    </button>

                    <div id="welcome-next-step-info">Parfait ! Les données sont prêtes. Cliquez sur
                        "Terminer" pour voir
                        les résultats.</div>
                </div>
            </div>
            <div class="welcome-nav-container">
                <button class="btn btn-secondary" id="welcomePrevBtn" style="visibility: hidden;">Précédent</button>
                <div id="welcome-dots"><span class="dot active"></span><span class="dot"></span><span
                        class="dot"></span><span class="dot"></span></div>
                <button class="btn" id="welcomeNextBtn">Suivant</button>
                <div id="welcome-finish-options">
                    <button class="btn btn-secondary" id="welcomeFinishBtn">Terminer</button>
                    <button class="btn" id="welcomeFinishAndHideBtn">Terminer et ne plus
                        afficher</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json,.csv,.txt" style="display: none;">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Génération en cours...</div>
    </div>

    <button id="backToTopBtn" class="icon-button tooltip" data-tooltip="Retour en haut"
        aria-label="Retour en haut de la page">↑</button>

    <!-- TEMPLATES -->
    <template id="student-result-template">
        <div class="appreciation-result" tabindex="0">
            <div class="card-content-wrapper">
                <div class="student-name-container" role="button" data-action="details">
                    <div class="student-name">
                        <span data-template="name"></span>
                    </div>
                    <div data-template="grades" class="student-grades-display"></div>
                    <span class="details-on-hover-label"><i class="fas fa-chart-bar"></i>
                        Analyser</span>
                </div>
                <div class="appreciation-text-container" role="button" data-action="refine">
                    <p data-template="appreciation" class="appreciation-text"></p>
                    <span class="refine-on-hover-label"><i class="fas fa-wand-magic-sparkles"></i>
                        Raffinement</span>
                </div>
                <div class="card-footer">
                    <div class="student-summary-details">
                        <span data-template="subject" class="detail-chip tooltip"></span>
                        <span data-template="wordCount" class="detail-chip tooltip"
                            data-tooltip="Nombre de mots"></span>
                    </div>
                    <div class="appreciation-actions">
                        <button class="icon-action-btn toggle-version-btn tooltip" data-action="toggle-version"
                            data-tooltip="Voir version précédente" aria-label="Basculer entre versions"
                            style="display: none;"><i class="fas fa-history" aria-hidden="true"></i></button>
                        <button class="icon-action-btn copy-btn tooltip" data-action="copy" data-tooltip="Copier"
                            aria-label="Copier l'appréciation"><i class="fas fa-copy" aria-hidden="true"></i></button>
                        <button class="icon-action-btn tooltip" data-action="edit" data-tooltip="Modifier"
                            aria-label="Modifier l'élève"><i class="fas fa-pencil-alt" aria-hidden="true"></i></button>
                        <button class="icon-action-btn tooltip" data-action="regenerate" data-tooltip="Régénérer"
                            aria-label="Régénérer l'appréciation"><i class="fas fa-sync-alt"
                                aria-hidden="true"></i></button>
                        <button class="icon-action-btn tooltip" data-action="delete" data-tooltip="Supprimer"
                            aria-label="Supprimer l'élève"><i class="fas fa-trash-alt" aria-hidden="true"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="empty-state-template">
        <div class="empty-state-illustration">
            <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="60" cy="60" r="55" stroke="url(#gradient)" stroke-width="2" stroke-dasharray="8 4"
                    class="empty-state-circle" />
                <path d="M45 55L55 65L75 45" stroke="url(#gradient)" stroke-width="3" stroke-linecap="round"
                    stroke-linejoin="round" class="empty-state-check" />
                <circle cx="60" cy="60" r="25" fill="url(#gradient)" fill-opacity="0.1" />
                <text x="60" y="65" text-anchor="middle" font-size="24" class="empty-state-emoji">✨</text>
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#d97706" />
                        <stop offset="100%" stop-color="#b45309" />
                    </linearGradient>
                </defs>
            </svg>
        </div>
        <h3>Commencez par ajouter vos élèves</h3>

        <!-- Hub d'import intégré directement -->
        <div class="empty-state-hub">
            <div class="empty-state-hub-card" data-action="individual" tabindex="0" role="button">
                <div class="empty-state-hub-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div class="empty-state-hub-text">
                    <h4>Individuel</h4>
                    <p>Ajouter un élève manuellement</p>
                </div>
            </div>
            <div class="empty-state-hub-card" data-action="mass" tabindex="0" role="button">
                <div class="empty-state-hub-icon">
                    <i class="fas fa-file-csv"></i>
                </div>
                <div class="empty-state-hub-text">
                    <h4>Classe entière</h4>
                    <p>Importer depuis Excel / CSV</p>
                </div>
            </div>
        </div>
    </template>

    <template id="skeleton-card-template">
        <div class="skeleton-card">
            <div class="skeleton-card-header">
                <div class="skeleton skeleton-circle skeleton-avatar"></div>
                <div class="skeleton-info">
                    <div class="skeleton skeleton-text skeleton-name"></div>
                    <div class="skeleton skeleton-text skeleton-badge"></div>
                </div>
            </div>
            <div class="skeleton-card-body">
                <div class="skeleton skeleton-text long"></div>
                <div class="skeleton skeleton-text medium"></div>
                <div class="skeleton skeleton-text long"></div>
            </div>
            <div class="skeleton-card-footer">
                <div class="skeleton skeleton-button"></div>
                <div class="skeleton skeleton-button"></div>
            </div>
        </div>
    </template>

    <script type="module" src="./src/main.js"></script>

    <!-- Modale Création de Classe (Premium iOS 2025 Style) -->
    <div id="createClassModal" class="modal modal-mini" role="dialog" aria-modal="true"
        aria-labelledby="createClassModalTitle">
        <div class="modal-content modal-mini-content">
            <div class="modal-header modal-header-centered">
                <div class="modal-icon-wrapper">
                    <i class="fas fa-folder-plus" aria-hidden="true"></i>
                </div>
                <h2 class="modal-title" id="createClassModalTitle">Nouvelle classe</h2>
            </div>
            <div class="modal-body modal-body-compact">
                <div class="form-group premium-input-group">
                    <input type="text" id="newClassNameInput" class="form-input premium-input"
                        placeholder="CM2 A, 6ème B, Terminale S..." maxlength="50" autocomplete="off" autofocus>
                    <span class="input-char-count"><span id="classNameCharCount">0</span>/50</span>
                </div>
            </div>
            <div class="modal-footer modal-footer-buttons">
                <button class="btn btn-secondary" id="cancelCreateClassBtn">Annuler</button>
                <button class="btn btn-organic" id="confirmCreateClassBtn" disabled>
                    <i class="fas fa-check"></i> Créer
                </button>
            </div>
        </div>
    </div>

    <!-- CLASS DASHBOARD MODAL - Premium Analytics View -->
    <div id="classDashboardModal" class="modal class-dashboard-modal" role="dialog" aria-modal="true"
        aria-labelledby="classDashboardModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <div class="dashboard-header-left">
                    <h2 class="modal-title" id="classDashboardModalTitle">
                        <i class="fas fa-chart-pie" aria-hidden="true"></i> Tableau de Bord
                    </h2>
                    <span class="dashboard-period-badge" id="dashboardPeriodBadge">
                        <i class="fas fa-calendar-alt"></i> Trimestre 1
                    </span>
                </div>
                <span class="dashboard-student-count" id="dashboardStudentCount">
                    <i class="fas fa-users"></i> <strong>0</strong> élèves analysés
                </span>
                <button class="close-button" id="closeDashboardModalBtn" aria-label="Fermer le tableau de bord">
                    <i class="fas fa-xmark"></i>
                </button>
            </div>

            <div class="modal-body">
                <!-- Compact Spread Stat (unique to this modal) -->
                <div class="dashboard-spread-inline">
                    <div class="spread-inline-icon"><i class="fas fa-ruler-horizontal"></i></div>
                    <div class="spread-inline-content">
                        <span class="spread-inline-label">Écart-type</span>
                        <span class="spread-inline-value" id="kpiSpread">--</span>
                        <span class="spread-inline-unit">pts</span>
                    </div>
                    <span class="spread-inline-badge" id="kpiSpreadLabel">--</span>
                </div>

                <!-- Highlights: Progressions & At Risk -->
                <div class="dashboard-highlights">
                    <div class="highlight-card">
                        <div class="highlight-card-header">
                            <div class="highlight-icon success"><i class="fas fa-arrow-trend-up"></i></div>
                            <span class="highlight-card-title">Top Progressions</span>
                        </div>
                        <div class="highlight-list" id="highlightProgressList">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                    <div class="highlight-card">
                        <div class="highlight-card-header">
                            <div class="highlight-icon warning"><i class="fas fa-exclamation-circle"></i></div>
                            <span class="highlight-card-title">À surveiller</span>
                        </div>
                        <div class="highlight-list" id="highlightRiskList">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>

                <!-- AI Synthesis Section -->
                <div class="dashboard-ai-section">
                    <div class="ai-section-header">
                        <h3 class="ai-section-title"><i class="fas fa-wand-magic-sparkles"></i> Synthèse IA</h3>
                        <div class="ai-section-actions">
                            <button class="btn btn-ai btn-small" id="generateSynthesisBtn">
                                <i class="fas fa-wand-magic-sparkles"></i> Générer la synthèse
                            </button>
                        </div>
                    </div>
                    <div class="ai-section-content" id="aiSynthesisContent">
                        <div class="ai-placeholder">
                            <div class="ai-placeholder-icon"><i class="fas fa-wand-magic-sparkles"></i></div>
                            <p class="ai-placeholder-text">Cliquez sur "Générer la synthèse" pour obtenir une analyse IA
                                contextuelle de votre classe.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="dashboard-footer-right">
                    <button class="btn btn-secondary" id="copyDashboardSynthesisBtn">
                        <i class="fas fa-copy"></i> Copier
                    </button>
                    <button class="btn btn-secondary" id="closeDashboardFooterBtn">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Legacy classAnalysisModal ID kept for backward compatibility -->
    <div id="classAnalysisModal" style="display: none;"></div>

    <!-- ==================================================================== -->
    <!-- PWA INSTALL BANNER - Smart install prompt                             -->
    <!-- ==================================================================== -->
    <div id="pwaInstallBanner" class="pwa-install-banner" role="alert" aria-live="polite">
        <div class="pwa-banner-content">
            <div class="pwa-banner-icon">
                <img src="./assets/icon-192.png" alt="Bulletin AI">
            </div>
            <div class="pwa-banner-text">
                <h4 class="pwa-banner-title">Installer Bulletin AI</h4>
                <p class="pwa-banner-subtitle">Accès rapide depuis votre écran d'accueil</p>
            </div>
            <div class="pwa-banner-actions">
                <button id="pwaInstallBtn" class="btn-install">
                    <i class="fas fa-download"></i> Installer
                </button>
                <button id="pwaLaterBtn" class="btn-dismiss" aria-label="Plus tard" title="Plus tard">
                    <i class="fas fa-clock"></i>
                </button>
                <button id="pwaDismissBtn" class="btn-dismiss" aria-label="Ne plus afficher" title="Ne plus afficher">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <!-- iOS Safari manual instructions (shown only on iOS) -->
        <div class="pwa-ios-guide">
            <div class="pwa-ios-step">
                <i class="fas fa-arrow-up-from-bracket"></i>
                <span>Appuyez sur <strong>Partager</strong></span>
            </div>
            <div class="pwa-ios-step">
                <i class="fas fa-plus-square"></i>
                <span>Puis <strong>Sur l'écran d'accueil</strong></span>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="importSettingsInput" accept=".json" style="display: none;">




    <!-- Script pour les onglets du guide -->
    <script>
        window.switchHelpTab = function (btn, targetId) {
            // Boutons
            document.querySelectorAll('.modal-tabs-sidebar .modal-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Contenu
            document.querySelectorAll('.help-tab-content').forEach(c => c.classList.remove('active'));
            const target = document.getElementById(targetId);
            if (target) {
                target.classList.add('active');
            }
        }
    </script>

    <!-- Page Entrance Transition from Landing Page -->
    <script>
            (function initPageEntrance() {
                // Check if user is coming from landing page (within last 2 seconds)
                const transitionTimestamp = sessionStorage.getItem('landingTransition');
                const now = Date.now();

                if (transitionTimestamp && (now - parseInt(transitionTimestamp, 10)) < 2000) {
                    // Clear the flag
                    sessionStorage.removeItem('landingTransition');

                    // Apply entrance animation class
                    document.body.classList.add('is-transitioning-in');

                    // Remove the class after animation completes
                    setTimeout(() => {
                        document.body.classList.remove('is-transitioning-in');
                    }, 800); // Slightly longer than animation duration
                }
            })();
    </script>
</body>

</html>